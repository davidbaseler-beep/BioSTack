<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioStack Infinite v19.6 (Flex Planer & Stats)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --accent: #FF8C00;
            --morning-glow: #FFB347;
            --day-glow: #4facfe;
            --evening-glow: #6a11cb;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-dark: rgba(0, 0, 0, 0.3);
            --bg-dark: #1e293b;
            --labor-glow: #a855f7;
            --radar-glow: #10b981;
        }
        
        html, body {
    position: fixed;
    overflow: hidden;
    width: 100%;
    height: 100%;
    /* Verhindert das Ziehen der gesamten Seite auf iOS */
    overscroll-behavior: none; 
    background-color: #0f172a;
    /* NEU: Killt die Textmarkierung und Lupe auf iOS absolut zuverl√§ssig */
    -webkit-touch-callout: none !important; 
    -webkit-user-select: none !important; 
    user-select: none !important; 
}

body { 
    font-family: 'Inter', -apple-system, sans-serif; 
    background: #09090b;
    color: #f8fafc; 
    margin: 0; 
    -webkit-tap-highlight-color: transparent;
}

/* Scrollbars global verstecken */
::-webkit-scrollbar { display: none; }
* { 
    scrollbar-width: none; 
    -ms-overflow-style: none; 
    /* NEU: Verhindert Textmarkierung und das iOS-Lupe/Kopieren-Men√º */
    -webkit-touch-callout: none; 
    -webkit-user-select: none; 
    -moz-user-select: none; 
    -ms-user-select: none; 
    user-select: none; 
}

/* NEU: Eingabefelder M√úSSEN markierbar bleiben, sonst funktioniert die Tastatur nicht */
input, textarea, select {
    -webkit-user-select: auto !important;
    -moz-user-select: auto !important;
    -ms-user-select: auto !important;
    user-select: auto !important;
}

/* Erlaubt das Scrollen NUR innerhalb der Tabs, ohne die App zu verschieben */

/* Erlaubt das Scrollen NUR innerhalb der Tabs, ohne die App zu verschieben */
.page {
    height: 100vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 20px;
    padding-bottom: 180px !important; /* Deutlich mehr Platz am Ende der Seite */
    box-sizing: border-box;
}

        /* --- GYM TABS (NEW) --- */
        .gym-day-tabs { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .gym-day-tabs::-webkit-scrollbar { display: none; }
        .gym-day-tab { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 8px 16px; border-radius: 20px; color: #94a3b8; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: 0.3s; flex-shrink: 0;}
        .gym-day-tab.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 10px rgba(255,140,0,0.3); }

        /* --- START SCREEN STYLES --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111111, #000000); /* Noch dunklerer Noir Hintergrund */
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            /* Transition angepasst f√ºr den Tastatur-Fix */
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
        }
        .start-hidden { transform: translateY(-100%); }

        /* --- START SCREEN STYLES --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111111, #000000); 
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
        }
        .start-hidden { transform: translateY(-100%); }

        /* --- NEUES SPLASH IMAGE --- */
        .splash-hero-img {
            width: 100%;
            max-width: 450px; 
            height: auto;
            margin-bottom: 20px;
            animation: pulseGold 4s ease-in-out infinite alternate;
            
            mix-blend-mode: screen; 
            -webkit-user-drag: none; 
            user-select: none;
            
            /* Verhindert Grafik-Glitches (wei√üe Ecken) auf iOS beim Blenden */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .app-desc { font-size: 14px; color: #94a3b8; max-width: 80%; line-height: 1.6; margin-bottom: 30px; }
        
        .welcome-input {
            background: rgba(255,255,255,0.1); border: 1px solid var(--accent);
            padding: 15px; border-radius: 12px; color: white; text-align: center;
            font-size: 18px; margin-bottom: 20px; width: 70%;
            display: none; 
        }
        .welcome-btn {
            background: var(--accent); color: white; border: none; padding: 12px 30px;
            font-weight: 800; border-radius: 30px; cursor: pointer; text-transform: uppercase;
            letter-spacing: 1px; display: none; 
        }

        .swipe-hint { position: absolute; bottom: 40px; font-size: 12px; color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; animation: bounce 2s infinite; display: none; }
        
        @keyframes pulse { 0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(255,140,0,0)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 20px rgba(255,140,0,0.4)); } 100% { transform: scale(1); } }
        @keyframes pulseGold { 0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(255, 215, 0, 0)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.6)); } 100% { transform: scale(1); } } /* NEU: Goldener Glow f√ºr die DNA */
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        /* --- MODALS & REST --- */
        .custom-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 300; align-items: center; justify-content: center; }
        
        /* Zwingt System-Meldungen immer in den Vordergrund */
        #alert-modal, #confirm-modal, #prompt-modal { z-index: 99999 !important; }
        .custom-modal-box { background: var(--bg-dark); border: 1px solid var(--glass-border); padding: 25px; border-radius: 24px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .custom-modal-title { font-weight: 800; font-size: 18px; margin-bottom: 10px; }
        .custom-modal-text { font-size: 14px; opacity: 0.8; margin-bottom: 20px; line-height: 1.4; }
        .custom-modal-input { width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; color: white; text-align: center; font-size: 18px; margin-bottom: 20px; }
        
        .autocomplete-wrapper { position: relative; width: 100%; margin-bottom: 20px; text-align: left; }
        .autocomplete-wrapper .custom-modal-input { margin-bottom: 0; }
        .autocomplete-items { position: absolute; border: 1px solid var(--accent); border-radius: 12px; z-index: 999; top: calc(100% + 5px); left: 0; right: 0; background: var(--bg-dark); max-height: 180px; overflow-y: auto; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .autocomplete-item { padding: 12px 15px; cursor: pointer; color: #f1f5f9; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; font-weight: 600; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:active { background: rgba(255, 140, 0, 0.2); color: var(--accent); }

        .modal-btn-row { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-cancel { background: rgba(255,255,255,0.1); color: #cbd5e1; }
        .btn-confirm { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* --- APP STYLES --- */
        .nav { display: flex; justify-content: space-around; background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); padding: 15px 5px 25px 5px; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; border-top: 1px solid rgba(255,255,255,0.05); transition: transform 0.3s; box-shadow: 0 -10px 30px rgba(0,0,0,0.6); }
        .nav button { border: none; background: none; font-weight: 600; color: #64748b; font-size: 11px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; padding: 0 5px;}
        .nav button.active { color: var(--accent); text-shadow: 0 0 10px var(--accent); }

        .page { display: none; padding: 20px; max-width: 400px; margin: 0 auto; animation: fadeIn 0.2s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header-widget { background: var(--glass); border: 1px solid var(--glass-border); padding: 12px 20px; border-radius: 24px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .streak-fire { font-size: 24px; font-weight: 800; color: var(--accent); display: flex; align-items: center; gap: 10px; }

        .cycle-box { margin-bottom: 30px; position: relative; }
        .cycle-label { font-size: 13px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; }
        
        /* --- SWIPE-TO-ACTION STYLES --- */
        .supp-swipe-wrapper { position: relative; overflow: hidden; margin-bottom: 15px; border-radius: 20px; }
        .supp-swipe-wrapper .supp-card { margin-bottom: 0 !important; }
        
        .supp-swipe-bg { 
            position: absolute; top: 0; left: 0; bottom: 0; width: 140px; 
            display: flex; z-index: 0; border-radius: 20px; 
            opacity: 0; transition: opacity 0.2s ease; overflow: hidden;
        }
        
        .swipe-action-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 10px; letter-spacing: 1px; color: white; cursor: pointer;
            transition: opacity 0.2s;
        }
        .swipe-action-btn:active { opacity: 0.6; }
        .swipe-pause { background: #334155; }
        .swipe-pause.is-paused { background: var(--warning); color: #000; }
        .swipe-delete { background: var(--danger); }
        .swipe-icon { font-size: 16px; margin-bottom: 2px; font-weight: normal; }
        
        .supp-card { 
            background: rgba(24, 24, 27, 0.5); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: 0 10px 24px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 24px; padding: 16px; display: flex; 
            margin-bottom: 15px;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1; flex-wrap: wrap; position: relative;
            align-items: center; overflow: hidden; justify-content: space-between;
            touch-action: pan-y; 
        }
        
        .supp-card.dragging { opacity: 0.5; border: 2px dashed var(--accent); }
        .supp-card.paused { opacity: 0.75; border-style: dashed; border-color: #475569; background: rgba(0,0,0,0.25); }
        
        .timer-badge { 
            position: absolute; top: 0; right: 45px; 
            background: linear-gradient(135deg, #ef4444, #f59e0b); 
            color: white; font-size: 10px; padding: 4px 10px; 
            border-radius: 0 0 10px 10px; 
            font-weight: 900; z-index: 10; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            letter-spacing: 1px;
        }

        .stock-bg-bar { position: absolute; top: 0; left: 0; bottom: 0; opacity: 0.3; z-index: 0; transition: width 0.5s ease; }
        .icon-box { width: 42px; height: 42px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px; border: 1px solid var(--glass-border); cursor: pointer; position: relative; z-index: 2; flex-shrink: 0; }
        
        .supp-meta { flex-grow: 1; pointer-events: none; position: relative; z-index: 2; display: flex; flex-direction: column; justify-content: center; min-width: 0; margin-right: 10px; }
        .supp-name { font-weight: 700; font-size: 15px; color: #f1f5f9; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .supp-unit { font-weight: 400; opacity: 0.7; font-size: 12px; margin-top: 2px; }
        .sub-name { display: block; font-size: 12px; color: #e2e8f0; margin-top: 1px; opacity: 0.9; }
        
        .right-section { display: flex; align-items: center; justify-content: flex-end; gap: 5px; position: relative; z-index: 2; margin-right: 0px; width: auto; flex-shrink: 0; }     

        .check-btn { width: 32px; height: 32px; border: 2px solid #334155; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.2); flex-shrink: 0; }
        .check-btn::after { content: '‚úì'; color: white; font-weight: 900; display: none; }
        .checked .check-btn { background: var(--success); border-color: var(--success); box-shadow: 0 0 5px var(--success); }
        .checked .check-btn::after { display: block; }
        .gear-icon { font-size: 18px; cursor: pointer; opacity: 0.6; transition: 0.3s; padding: 8px; border-radius: 50%; background: var(--glass-dark); margin-left: auto; margin-right: 10px; z-index: 50; }
        .gear-icon:active { transform: scale(0.9); background: var(--accent); color: black; opacity: 1; }
        .stock-badge { font-size: 9px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 6px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap; margin-right: 5px; flex-shrink: 0; }
        .stock-text-ok { color: var(--success); } .stock-text-warn { color: var(--warning); border-color: var(--warning); } .stock-text-low { color: var(--danger); border-color: var(--danger); font-weight: bold; }
        .chart-container { background: rgba(24, 24, 27, 0.5); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: 0 12px 32px rgba(0,0,0,0.5); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); margin-top: 20px; box-sizing: border-box; }
        
        .fasting-ring { position: relative; width: 45px; height: 45px; margin: 0; border-radius: 50%; background: conic-gradient(rgba(255,255,255,0.05) 100%, rgba(255,255,255,0.05) 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.2); transition: background 1s ease; flex-shrink: 0; }
        .fasting-inner { width: 37px; height: 37px; background: var(--bg-dark); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .fasting-time { font-size: 10px; font-weight: 900; color: white; letter-spacing: 0.5px; margin-bottom: 1px;}
        .fasting-lbl { font-size: 5px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .gsb-card { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 15px; margin-top: 15px; }
        .gsb-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .gsb-row:last-child { border-bottom: none; }
        .gsb-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .gsb-value { font-size: 15px; font-weight: 600; color: #f1f5f9; }
        .price-tag { background: rgba(34, 197, 94, 0.15); color: #4ade80; padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: 800; }
        .insight-tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: rgba(79, 172, 254, 0.1); color: #4facfe; margin: 2px; display: inline-block; border: 1px solid rgba(79, 172, 254, 0.2); }

        .weight-input { width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.2); border: 1px solid #334155; padding: 12px; border-radius: 12px; color: white; text-align: center; font-size: 18px; margin-bottom: 10px; font-family: inherit; }
        .weight-input:disabled { opacity: 0.5; color: #cbd5e1; }
        .slider-container { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: #cbd5e1; }
        .battery-container { position: relative; width: 100%; height: 32px; margin-bottom: 20px; touch-action: none; }
        .battery-outer { position: absolute; top:0; left:0; bottom:0; right: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 3px; background: rgba(0,0,0,0.2); }
        .battery-nub { position: absolute; right: 0; top: 8px; bottom: 8px; width: 7px; background: rgba(255,255,255,0.3); border-radius: 0 4px 4px 0; }
        .battery-level { height: 100%; background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 60%, var(--success) 100%); border-radius: 4px; width: 50%; transition: width 0.1s ease-out; box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .battery-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; margin: 0; -webkit-appearance: none; }

        #time-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index:200; align-items:center; justify-content:center; }
        .modal-body { background: var(--bg-dark); padding: 25px; border-radius: 32px; width: 85%; max-width: 340px; border: 1px solid var(--glass-border); text-align: center; position: relative; }
        .close-modal-x { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #ef4444; font-weight: 800; cursor: pointer; }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .num-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; color: white; font-size: 20px; font-weight: 700; cursor: pointer; }

        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 16px; color: white; font-weight: 700; cursor: pointer; margin-bottom: 10px; transition: all 0.15s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 4px 0px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.1); transform: translateY(0); }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 0px 0px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.1); }
        .btn-add-katalog { background: #2d3748; color: #ffffff; border: 1px solid var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }

        .nutri-dropdown { width: 100%; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); display: none; }
        
        .collapse-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapse-header::after { content: '‚ñæ'; font-size: 18px; color: var(--accent); transition: 0.3s; }
        .collapse-active .collapse-header::after { transform: rotate(180deg); }
        .collapse-content { display: none; margin-top: 10px; }
        .collapse-active .collapse-content { display: block; }

        .history-item { background: rgba(255,255,255,0.03); border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--glass-border); cursor: pointer; }
        .history-header { display: flex; justify-content: space-between; align-items: center; }
        .history-date { color: var(--accent); font-weight: 800; font-size: 15px; }
        .history-stat { font-size: 12px; font-weight: 700; background: var(--accent); color: white; padding: 2px 8px; border-radius: 8px; }
        .hist-details { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); animation: slideDown 0.3s ease-out; }
        .hist-list-item { font-size: 12px; margin: 4px 0; display: flex; align-items: center; gap: 8px; }
        .hist-status-ok { color: #22c55e; } .hist-status-fail { color: #ef4444; opacity: 0.6; }
        .fb-tags { display: flex; gap: 8px; margin-top: 5px; font-size: 11px; color: #cbd5e1; }

        .add-supp-form { display: none; background: var(--glass); border: 1px dashed var(--accent); padding: 20px; border-radius: 24px; margin-bottom: 20px; animation: slideDown 0.3s ease-out; }
        .add-supp-form input, .add-supp-form textarea { width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; color: white; margin-bottom: 10px; font-family: inherit; }

        .nav-arrow { font-size: 20px; color: var(--accent); padding: 0 15px; cursor: pointer; user-select: none; font-weight: 900; }
        .nav-arrow:active { transform: scale(0.8); }
        #w-date, #m-date, #l-date { width: 60% !important; margin: 0 auto 15px auto; display: block; text-align: center; }

        .wiki-list { text-align: left; max-height: 60vh; overflow-y: auto; padding-right: 5px; }
        .wiki-category { color: #64748b; font-size: 11px; font-weight: 800; text-transform: uppercase; margin: 15px 0 5px 0; letter-spacing: 1px; }
        .wiki-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--glass-border); cursor: pointer; transition: 0.2s; }
        .wiki-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #f1f5f9; font-size: 14px; }
        .wiki-content { display: none; margin-top: 10px; font-size: 13px; color: #cbd5e1; line-height: 1.5; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .wiki-item.active { background: rgba(255, 140, 0, 0.15); border-color: var(--accent); }
        .wiki-item.active .wiki-content { display: block; }
        .wiki-arrow { transition: 0.3s; font-size: 10px; opacity: 0.7; }
        .wiki-item.active .wiki-arrow { transform: rotate(180deg); }

        .level-card { 
            background: linear-gradient(135deg, #1e293b, #0f172a); 
            border: 2px solid var(--accent); 
            border-radius: 24px; 
            padding: 20px; 
            text-align: center; 
            margin-bottom: 25px; 
            position: relative; 
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .level-trophy { font-size: 50px; margin-bottom: 10px; display: block; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .level-title { font-size: 20px; font-weight: 900; color: var(--accent); margin-bottom: 5px; }
        .level-xp { font-size: 12px; color: #cbd5e1; margin-bottom: 15px; font-weight: 600; letter-spacing: 1px;}
        .xp-bar-bg { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; width: 100%; position: relative; overflow: hidden; }
        .xp-bar-fill { background: var(--accent); height: 100%; width: 0%; transition: width 1s ease; border-radius: 4px; }
        
        #ranks-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index:400; align-items:center; justify-content:center; }
        .rank-list-item { display:flex; align-items:center; gap:15px; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid var(--glass-border); }
        .rank-list-item.locked { opacity: 0.5; filter: grayscale(1); }
        .rank-list-item.current { border-color: var(--accent); background: rgba(255, 140, 0, 0.1); }

        /* ANALYTICS MODERN UI */
        .ana-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; }
        .ana-item { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border); border-left: 3px solid var(--accent); }
        .ana-label { font-size: 8px; color: #94a3b8; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .ana-val { color: white; font-size: 13px; font-weight: 700; display: block; margin-top: 2px; }

        .info-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; }
        .info-table td { padding: 5px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-table tr:last-child td { border-bottom: none; }
        .info-table b { color: var(--accent); }
        .checkbox-row { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #cbd5e1; margin-bottom: 8px; cursor: pointer; }

        /* --- GYM STYLES --- */
        .gym-ex-card { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px; margin-bottom: 15px; }
        .gym-set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .gym-set-input { flex: 1; min-width: 0; box-sizing: border-box; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 10px 5px; border-radius: 8px; text-align: center; font-size: 14px; font-family: inherit;}
        .gym-set-input:disabled { opacity: 0.5; color: #cbd5e1; }
        .gym-set-btn { width: 45px; height: 40px; border-radius: 8px; border: none; font-weight: 900; cursor: pointer; transition: 0.2s; font-size: 14px;}
        .gym-set-btn.done { background: var(--success); color: white; box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);}
        .gym-set-btn.open { background: var(--warning); color: black; }
        /* --- APP LOCK STYLES --- */
    #app-lock-screen { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.95); backdrop-filter:blur(15px); z-index:99999; flex-direction:column; align-items:center; justify-content:center; }
    .pin-dots { display:flex; gap:20px; margin-bottom:40px; justify-content:center; }
    .pin-dot { width:16px; height:16px; border-radius:50%; border:2px solid var(--accent); transition:0.2s; }
    .pin-dot.filled { background:var(--accent); box-shadow: 0 0 10px var(--accent); }
    .pin-numpad { display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; max-width:280px; margin:0 auto; justify-items:center; }
    .pin-num-btn { width:70px; height:70px; border-radius:50%; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:white; font-size:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:600; transition:0.1s; user-select:none; }
¬† ¬† .pin-num-btn:active { background:var(--accent); color:black; transform:scale(0.95); }

    /* --- BODY ANALYTICS REDESIGN --- */
    .analytics-list-wrapper { display: flex; flex-direction: column; gap: 12px; width: 100%; }
    .analytics-list-item { display: flex; flex-direction: column; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px; }
    .analytics-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; }
    .analytics-label { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 800; color: #f8fafc; letter-spacing: 0.5px; }
    .analytics-value-wrap { text-align: right; }
    .analytics-value { font-size: 18px; font-weight: 900; color: white; display: block; line-height: 1.1; }
    .analytics-subtext { font-size: 11px; color: #94a3b8; font-weight: 600; margin-top: 4px; display: block; text-transform: uppercase; }
    .analytics-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
    .analytics-bar-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease-out; }

    /* --- PREMIUM UI UPGRADES (DETAILS) --- */
    
    /* 1. Deine Idee: Goldene Umrandung & Premium-Look f√ºr Katalog-Items */
    #page-market .supp-card {
        border: 1px solid rgba(255, 140, 0, 0.25) !important;
        background: linear-gradient(145deg, rgba(24, 24, 27, 0.7), rgba(9, 9, 11, 0.9)) !important;
        box-shadow: 0 10px 24px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255, 140, 0, 0.1) !important;
    }

    /* 2. 3D-Glas-Look f√ºr die Emoji-Icons */
    .icon-box {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.01)) !important;
        box-shadow: inset 0 1px 1px rgba(255,255,255,0.2), 0 4px 10px rgba(0,0,0,0.3) !important;
        border: 1px solid rgba(255,255,255,0.05) !important;
    }

    /* 3. Moderne Navigations-Indikatoren (Leuchtender Punkt unter aktivem Tab) */
    .nav button {
        position: relative;
        padding-bottom: 12px !important;
        transition: all 0.3s ease;
    }
    .nav button.active::after {
        content: '';
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 8px var(--accent);
    }

    /* 4. Sanfte & leuchtende Eingabefelder */
    .weight-input, .custom-modal-input {
        background: rgba(255,255,255,0.03) !important;
        border: 1px solid rgba(255,255,255,0.08) !important;
        transition: all 0.3s ease !important;
    }
    .weight-input:focus, .custom-modal-input:focus {
        border-color: var(--accent) !important;
        box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.15) !important;
        outline: none !important;
    }
¬† ¬† </style>
    </style>
</head>
<body>

    <div id="app-lock-screen">
    <div id="pin-close-btn" style="position:absolute; top:30px; right:30px; font-size:24px; color:var(--danger); font-weight:900; cursor:pointer; display:none;" onclick="cancelPinSetup()">‚úï</div>
    <div style="font-size:22px; font-weight:900; color:white; margin-bottom:10px; letter-spacing:1px;">üîí BIOSTACK</div>
    <div id="pin-msg" style="font-size:13px; color:#94a3b8; margin-bottom:30px; height:15px; font-weight:bold;">PIN eingeben</div>
    <div class="pin-dots">
        <div class="pin-dot" id="dot-1"></div>
        <div class="pin-dot" id="dot-2"></div>
        <div class="pin-dot" id="dot-3"></div>
        <div class="pin-dot" id="dot-4"></div>
    </div>
    <div class="pin-numpad">
        <div class="pin-num-btn" onclick="addPin(1)">1</div>
        <div class="pin-num-btn" onclick="addPin(2)">2</div>
        <div class="pin-num-btn" onclick="addPin(3)">3</div>
        <div class="pin-num-btn" onclick="addPin(4)">4</div>
        <div class="pin-num-btn" onclick="addPin(5)">5</div>
        <div class="pin-num-btn" onclick="addPin(6)">6</div>
        <div class="pin-num-btn" onclick="addPin(7)">7</div>
        <div class="pin-num-btn" onclick="addPin(8)">8</div>
        <div class="pin-num-btn" onclick="addPin(9)">9</div>
        <div></div>
        <div class="pin-num-btn" onclick="addPin(0)">0</div>
        <div class="pin-num-btn" onclick="delPin()" style="background:transparent; border:none; color:var(--danger); font-size:24px;">‚å´</div>
    </div>
</div>

<div id="start-screen">
    
    <img src="https://i.imgur.com/2RUKod9.png" alt="BioStack" class="splash-hero-img">
    
    <div class="app-desc" id="start-text" style="margin-top: -20px; z-index: 2; position: relative;">
        Lade Daten...
    </div>

    <input type="text" id="user-name-input" class="welcome-input" placeholder="Wie ist dein Name?" style="z-index: 2; position: relative;">
    <button id="user-name-btn" class="welcome-btn" onclick="saveUserName()" style="z-index: 2; position: relative;">LOS GEHT'S</button>
    
    <div class="swipe-hint" id="swipe-hint">‚¨Ü WEGSWIPEN ZUM STARTEN</div>
</div>

<div id="alert-modal" class="custom-modal-overlay"><div class="custom-modal-box"><div class="custom-modal-title" id="alert-title">Hinweis</div><div class="custom-modal-text" id="alert-text"></div><button class="modal-btn btn-confirm" onclick="closeAlert()">OK</button></div></div>
<div id="confirm-modal" class="custom-modal-overlay"><div class="custom-modal-box"><div class="custom-modal-title" id="confirm-title">Best√§tigen</div><div class="custom-modal-text" id="confirm-text"></div><div class="modal-btn-row"><button class="modal-btn btn-cancel" onclick="confirmCallback(false)">Abbrechen</button><button class="modal-btn btn-danger" id="confirm-ok-btn" onclick="confirmCallback(true)">L√∂schen</button></div></div></div>
<div id="prompt-modal" class="custom-modal-overlay"><div class="custom-modal-box"><div class="custom-modal-title" id="prompt-title">Eingabe</div><div class="custom-modal-text" id="prompt-text"></div><div class="autocomplete-wrapper"><input type="text" id="prompt-input" class="custom-modal-input" autocomplete="off"><div id="exercise-autocomplete-list" class="autocomplete-items"></div></div><div class="modal-btn-row"><button class="modal-btn btn-cancel" onclick="closePrompt()">Abbrechen</button><button class="modal-btn btn-confirm" onclick="promptConfirm()">Speichern</button></div></div></div>

<div id="cycle-modal" class="custom-modal-overlay"><div class="custom-modal-box"><div class="custom-modal-title">Pause einplanen ‚è∏</div><div class="custom-modal-text">Wie viele Tage soll dieses Supplement pausiert werden?</div><input type="number" id="pause-days-input" class="custom-modal-input" value="7"><div class="modal-btn-row"><button class="modal-btn btn-cancel" onclick="closeCycleModal()">Abbruch</button><button class="modal-btn btn-confirm" onclick="confirmCyclePause()">Pause Start</button></div></div></div>
<div id="gym-add-modal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="custom-modal-title">Neue √úbung üèãÔ∏è</div>
        <div class="custom-modal-text">Trage die Details f√ºr dein Training ein.</div>

        <div class="autocomplete-wrapper">
            <input type="text" id="gym-mod-name" class="custom-modal-input" placeholder="√úbungsname (z.B. Bankdr√ºcken)" autocomplete="off">
            <div id="gym-mod-autocomplete-list" class="autocomplete-items"></div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="number" id="gym-mod-sets" class="custom-modal-input" placeholder="S√§tze" value="3" style="margin-bottom:0;">
            <input type="text" id="gym-mod-reps" class="custom-modal-input" placeholder="Wdh (z.B. 8-12)" style="margin-bottom:0;">
        </div>
        
        <input type="number" step="any" id="gym-mod-weight" class="custom-modal-input" placeholder="Ziel-Gewicht kg (optional)" style="margin-bottom:20px;">

        <div class="modal-btn-row">
            <button class="modal-btn btn-cancel" onclick="closeGymModal()">Abbrechen</button>
            <button class="modal-btn btn-confirm" onclick="saveGymModal()">Speichern</button>
        </div>
    </div>
</div>

<div id="time-modal"><div class="modal-body"><span class="close-modal-x" onclick="closeModal()">‚úï</span><h3 id="modal-title">Menge w√§hlen</h3><div id="num-display" style="font-size: 32px; font-weight: 800; color: var(--accent); margin-bottom: 15px;">0</div><div class="numpad" id="numpad-grid"><div class="num-btn" onclick="pressNum('1')">1</div><div class="num-btn" onclick="pressNum('2')">2</div><div class="num-btn" onclick="pressNum('3')">3</div><div class="num-btn" onclick="pressNum('4')">4</div><div class="num-btn" onclick="pressNum('5')">5</div><div class="num-btn" onclick="pressNum('6')">6</div><div class="num-btn" onclick="pressNum('7')">7</div><div class="num-btn" onclick="pressNum('8')">8</div><div class="num-btn" onclick="pressNum('9')">9</div><div class="num-btn" onclick="pressNum('C')" style="color:#ef4444">C</div><div class="num-btn" onclick="pressNum('0')">0</div><div class="num-btn" onclick="pressNum('OK')" style="color:#22c55e">OK</div></div><div id="time-select" style="display:none"><button class="btn-action" style="background: var(--morning-glow)" onclick="confirmAdd('morning')">Morgens</button><button class="btn-action" style="background: var(--day-glow)" onclick="confirmAdd('day')">Mittags</button><button class="btn-action" style="background: var(--evening-glow)" onclick="confirmAdd('evening')">Abends</button></div></div></div>
<div id="wiki-modal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="max-width: 90%; width: 350px;">
        <div class="custom-modal-title">N√§hrstoff-Guide üìö</div>
        <div class="custom-modal-text">Tippe zum Ausklappen</div>
        
        <div class="wiki-list">
            
            <div class="wiki-category">Fettl√∂sliche Vitamine</div>
            <div style="font-size: 11px; color: #fbbf24; margin-bottom: 10px; font-style: italic;">
                ‚ö†Ô∏è Wichtig: Immer zusammen mit etwas Fett (z.B. √ñl, N√ºsse, Mahlzeit) einnehmen, damit der K√∂rper sie aufnehmen kann.
            </div>
            
            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Vitamin A <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content"><b>Retinol/Beta-Carotin</b><br>Wichtig f√ºr Sehkraft, gesunde Haut und ein starkes Immunsystem.<br><br><b>Wirkungsweise:</b> Reguliert Genexpression und Zelldifferenzierung.<br><b>Kinetik:</b> Speicherung in der Leber (Monate). Halbwertszeit: ~140 Tage.<br><br><b>Quellen:</b><br>- S√º√ükartoffel (1 gro√üer, gekocht: ~1400¬µg)<br>- Karotten (1 mittel: ~500¬µg)<br>- Rinderleber (100g: ~6500¬µg - sehr hoch!)<br>- Spinat (100g: ~460¬µg)</div></div>
            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Vitamin D <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content"><b>Calciferol</b><br>Essentiell f√ºr Knochenstoffwechsel, Immunsystem und Calcium-Aufnahme.<br><br><b>Wirkungsweise:</b> Wirkt als Prohormon an Vitamin-D-Rezeptoren (VDR) im ganzen K√∂rper.<br><b>Kinetik:</b> Peak im Blut nach 12-24h. Halbwertszeit: 15-50 Tage (Fettgewebe-Speicher).<br><br><b>Quellen:</b><br>- Sonne (Hautsynthese, wichtigste Quelle)<br>- Hering (100g: ~25¬µg / 1000 IE)<br>- Lachs (100g: ~16¬µg / 640 IE)<br>- Eigelb (1 St√ºck: ~1¬µg / 40 IE)</div></div>
            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Vitamin E <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content"><b>Tocopherol</b><br>Starkes Antioxidans. Sch√ºtzt Zellen vor oxidativem Stress.<br><br><b>Wirkungsweise:</b> Neutralisiert freie Radikale in den Zellmembranen.<br><b>Kinetik:</b> Peak nach 4-8h. Halbwertszeit: ~48h (Leber-Umsatz).<br><br><b>Quellen:</b><br>- Sonnenblumen√∂l (1 EL: ~6mg)<br>- Mandeln (30g: ~7.3mg)<br>- Haseln√ºsse (30g: ~4.3mg)<br>- Avocado (1 halbe: ~2.1mg)</div></div>
            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Vitamin K <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content"><b>Phyllochinon (K1) / Menachinon (K2)</b><br>Entscheidend f√ºr Blutgerinnung und Knochengesundheit.<br><br><b>Wirkungsweise:</b> Aktiviert Proteine (z.B. Osteocalcin), die Calcium in die Knochen einbauen.<br><b>Kinetik:</b> K1 hat eine kurze Halbwertszeit (Stunden), K2 (MK-7) hat eine sehr lange (Tage), was konstante Spiegel erm√∂glicht.<br><br><b>Quellen:</b><br>- Gr√ºnkohl (100g gekocht: ~800¬µg K1)<br>- Natto (fermentiertes Soja) (15g: ~150¬µg K2 - Top Quelle!)<br>- Brokkoli (100g: ~140¬µg K1)<br>- Gouda/Brie (30g: ~20¬µg K2)</div></div>

            <div class="wiki-category">Wasserl√∂sliche Vitamine</div>

            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Vitamin C <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content"><b>Ascorbins√§ure</b><br>Kollagenbildung, Immunsystem und starkes Antioxidans.<br><br><b>Wirkungsweise:</b> Donator von Elektronen; Cofaktor bei √ºber 15 Enzymreaktionen.<br><b>Kinetik:</b> Peak nach 2-3h. Halbwertszeit: ~10-20 Tage. √úberschuss wird innerhalb von Stunden √ºber den Urin ausgeschieden.<br><br><b>Quellen:</b><br>- Rote Paprika (100g: ~190mg)<br>- Brokkoli (100g: ~90mg)<br>- Kiwi (1 St√ºck: ~70mg)<br>- Orange (1 mittel: ~70mg)</div></div>
            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Vitamin B12 <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content"><b>Cobalamin</b><br>Blutbildung, Nervenfunktion, Zellteilung.<br><br><b>Wirkungsweise:</b> Essentiell f√ºr DNA-Synthese und Myelinscheiden (Nervenschutz).<br><b>Kinetik:</b> Komplexe Aufnahme via "Intrinsic Factor". Gro√üer Leberspeicher reicht f√ºr 3-5 Jahre.<br><br><b>Quellen:</b><br>- Rindfleisch (100g: ~2.6¬µg)<br>- Lachs (100g: ~3¬µg)<br>- Eier (2 St√ºck: ~1¬µg)<br>- Hefeextrakt (Marmite) (1 TL: ~1.9¬µg)</div></div>

            <div class="wiki-category">Mineralstoffe & Spurenelemente</div>

            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Magnesium <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content">Entspannt Muskeln/Nerven, Energiestoffwechsel (ATP).<br><br><b>Wirkungsweise:</b> Cofaktor in √ºber 300 Enzymreaktionen.<br><b>Kinetik:</b> Peak je nach Form (Citrat/Bisglycinat) 2-4h. Halbwertszeit im Blut: ~1000 Stunden (Speicherung in Knochen/Muskeln).<br><br><b>Quellen:</b><br>- K√ºrbiskerne (30g: ~150mg)<br>- Spinat (100g gekocht: ~87mg)<br>- Mandeln (30g: ~80mg)<br>- Schwarze Bohnen (100g gekocht: ~70mg)</div></div>
            <div class="wiki-item" onclick="tglWiki(this)"><div class="wiki-header">Zink <span class="wiki-arrow">‚ñº</span></div><div class="wiki-content">Immunsystem, Testosteron, Wundheilung.<br><br><b>Wirkungsweise:</b> Strukturbestandteil in Proteinen und Zellrezeptoren.<br><b>Kinetik:</b> Peak im Plasma nach 2-3h. Keine gro√üen Langzeitspeicher (t√§glich n√∂tig!).<br><br><b>Quellen:</b><br>- Austern (2 St√ºck: ~16mg - Extrem hoch!)<br>- Rindfleisch (100g: ~5mg)<br>- K√ºrbiskerne (30g: ~2.2mg)<br>- Haferflocken (100g: ~4mg)</div></div>

        </div>

        <button class="modal-btn btn-confirm" style="margin-top:15px;" onclick="closeWiki()">Schlie√üen</button>
    </div>
</div>

<div class="nav">
    <div id="global-level-badge" style="position:absolute; top:-16px; left:50%; transform:translateX(-50%); background:var(--bg-dark); border:1px solid var(--accent); padding:4px 14px; border-radius:12px; font-size:10px; font-weight:900; color:white; z-index:102; box-shadow:0 4px 15px rgba(0,0,0,0.6); cursor:pointer; display:flex; align-items:center; gap:6px; white-space:nowrap; transition:0.3s;" onclick="showPage('profile')">
        <span id="glb-icon">üå±</span> <span id="glb-text" style="color:var(--accent);">Lvl 1</span>
    </div>

    <button onclick="showPage('plan')" id="n-plan">Plan</button>
    <button onclick="showPage('market')" id="n-market">Katalog</button>
    <button onclick="showPage('gym')" id="n-gym">Gym</button>
    <button onclick="showPage('weight')" id="n-weight">Body</button>
    <button onclick="showPage('profile')" id="n-profile">Cloud</button>
</div>

<div id="page-gym" class="page">
    <div class="header-widget" style="justify-content: center;">
        <div style="font-weight: 800; color: var(--accent); font-size: 16px; letter-spacing: 1px; text-transform: uppercase;">
            üèãÔ∏è Gym Tracker
        </div>
    </div>

    <div class="chart-container" id="gym-col-heute" style="margin-bottom: 15px; border: 1px solid rgba(255, 179, 71, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('gym-col-heute')">
            <h3 style="margin:0; color:var(--morning-glow); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">üî• Heute Tracken</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            
            <div class="gym-day-tabs" id="gym-flex-tabs">
                <div class="gym-day-tab" id="ftab-Montag" onclick="setFlexDay('Montag')">Mo</div>
                <div class="gym-day-tab" id="ftab-Dienstag" onclick="setFlexDay('Dienstag')">Di</div>
                <div class="gym-day-tab" id="ftab-Mittwoch" onclick="setFlexDay('Mittwoch')">Mi</div>
                <div class="gym-day-tab" id="ftab-Donnerstag" onclick="setFlexDay('Donnerstag')">Do</div>
                <div class="gym-day-tab" id="ftab-Freitag" onclick="setFlexDay('Freitag')">Fr</div>
                <div class="gym-day-tab" id="ftab-Samstag" onclick="setFlexDay('Samstag')">Sa</div>
                <div class="gym-day-tab" id="ftab-Sonntag" onclick="setFlexDay('Sonntag')">So</div>
            </div>

            <div id="gym-today-content"></div>
        </div>
    </div>

    <div class="chart-container" id="gym-col-planer" style="margin-bottom: 15px; border: 1px solid rgba(79, 172, 254, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('gym-col-planer')">
            <h3 style="margin:0; color:var(--day-glow); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">üìù Trainings-Planer</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:5px; text-align:center; font-weight:700;">ZIEL-TAG W√ÑHLEN</div>
            
            <select id="gym-day-select" class="weight-input" onchange="gymPlannerTargetChanged()">
                <option value="Montag">Montag (Jede Woche)</option>
                <option value="Dienstag">Dienstag (Jede Woche)</option>
                <option value="Mittwoch">Mittwoch (Jede Woche)</option>
                <option value="Donnerstag">Donnerstag (Jede Woche)</option>
                <option value="Freitag">Freitag (Jede Woche)</option>
                <option value="Samstag">Samstag (Jede Woche)</option>
                <option value="Sonntag">Sonntag (Jede Woche)</option>
                <option value="DATE">üìÖ Spezielles Datum...</option>
            </select>
            
            <input type="date" id="gym-date-select" class="weight-input" style="display:none; border-color:var(--accent); max-width: 250px; margin: 0 auto 10px auto;" onchange="renderGymPlaner()">
            
            <div id="gym-planer-list"></div>
            
            <button class="btn-action" style="background:var(--accent)" onclick="addGymExercise()">+ √úBUNG HINZUF√úGEN</button>
        </div>
    </div>
    <div class="chart-container" id="gym-col-chart" style="margin-bottom: 15px; border: 1px solid rgba(168, 85, 247, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('gym-col-chart')">
            <h3 style="margin:0; color:var(--labor-glow); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">üìà Fortschritt (Max)</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:5px; text-align:center; font-weight:700;">√úBUNG ANALYSIEREN</div>
            <select id="gym-chart-select" class="weight-input" onchange="updateGymChart()"></select>
            
            <div id="gym-stats-row" class="ana-grid" style="display:none; margin-top:15px; margin-bottom:15px;">
                <div class="ana-item" style="border-left-color: var(--labor-glow);">
                    <span class="ana-label">Est. 1RM (Max)</span>
                    <span class="ana-val" id="gym-stat-1rm" style="color:var(--labor-glow);">-</span>
                </div>
                <div class="ana-item" style="border-left-color: var(--day-glow);">
                    <span class="ana-label">Volumen (Zuletzt)</span>
                    <span class="ana-val" id="gym-stat-vol">-</span>
                </div>
            </div>

            <div style="position: relative; height: 200px; width: 100%; margin-top: 15px;">
                <canvas id="gymChart"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-container" id="gym-col-history" style="margin-bottom: 15px; border: 1px solid rgba(255, 255, 255, 0.2);">
        <div class="collapse-header" onclick="tglCollapse('gym-col-history')">
            <h3 style="margin:0; color:#cbd5e1; font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">üóÇÔ∏è Trainings-Verlauf</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div id="gym-history-list"></div>
        </div>
    </div>
    </div>

<div id="page-plan" class="page active">
    <div class="header-widget">
        <div><div style="font-size: 12px; color: #64748b; font-weight: 600;">STATUS</div><div class="streak-fire" id="f-counter">üî• Tag 1</div></div>
        <div style="text-align: right; display:flex; align-items:center;">
            <div class="nav-arrow" onclick="changeDay(-1)">‚ùÆ</div>
            <div id="date-display" style="font-weight: 700; font-size: 14px; min-width:100px; text-align:center;"></div>
            <div class="nav-arrow" onclick="changeDay(1)">‚ùØ</div>
        </div>
    </div>

    <div id="fasting-widget-container" class="chart-container" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; margin-bottom: 10px; border: 1px solid rgba(79, 172, 254, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="fasting-ring" id="f-ring">
                <div class="fasting-inner">
                    <div class="fasting-time" id="f-time">00:00</div>
                    <div class="fasting-lbl" id="f-lbl">Bereit</div>
                </div>
            </div>
            <div style="text-align:left;">
                <div style="font-size: 10px; font-weight: 800; color: var(--day-glow); margin-bottom: 2px;">FASTEN</div>
                <select id="f-goal" style="background:none; border:none; color:#94a3b8; font-weight:600; font-size:11px; padding:0; outline:none; -webkit-appearance: none; appearance: none;" onchange="setFastingGoal()">
                    <option value="12">Ziel: 12h</option>
                    <option value="14">Ziel: 14h</option>
                    <option value="16" selected>Ziel: 16h</option>
                    <option value="18">Ziel: 18h</option>
                    <option value="20">Ziel: 20h</option>
                </select>
            </div>
        </div>
        <button class="btn-action" id="f-btn" style="background: var(--success); padding: 8px 16px; font-size:10px; margin:0; width:auto; border-radius:12px;" onclick="toggleFasting()">START</button>
    </div>

    <div id="cycle-widget-container" class="chart-container" style="display: none; align-items: center; justify-content: space-between; padding: 12px 15px; margin-bottom: 10px; border: 1px solid rgba(236, 72, 153, 0.3); background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(0,0,0,0));">
        <div style="display:flex; align-items:center; gap:15px; width:100%;">
            <div class="fasting-ring" id="c-ring" style="border-color: #ec4899; box-shadow: 0 0 10px rgba(236, 72, 153, 0.2); width:45px; height:45px;">
                <div class="fasting-inner">
                    <div class="fasting-time" id="c-day" style="color:#ec4899; font-size:12px; font-weight:900;">-</div>
                </div>
            </div>
            <div style="flex:1;">
                <div style="font-size: 12px; font-weight: 900; color: #ec4899; margin-bottom: 4px; text-transform:uppercase; letter-spacing: 1px;" id="c-phase">Zyklus laden...</div>
                <div style="font-size: 11px; color: #cbd5e1; line-height:1.4;" id="c-info">Bitte in den Einstellungen konfigurieren.</div>
            </div>
        </div>
    </div>

    <div id="plan-content"></div>
    <div class="chart-container" style="padding-bottom:10px;"><button onclick="tglSum()" style="width:100%; background: linear-gradient(135deg, rgba(255,140,0,0.1), rgba(255,140,0,0.02)); border: 1px solid rgba(255,140,0,0.3); color: var(--accent); font-weight: 800; cursor: pointer; letter-spacing: 2px; padding: 15px; border-radius: 16px; text-transform: uppercase; font-size: 12px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s ease;">üß¨ STACK METRICS</button><div id="sum-details" style="display:none; margin-top:20px;"></div></div>
</div>

<div id="page-weight" class="page">
    
    <div id="body-analytics-summary" class="chart-container" style="background: linear-gradient(135deg, rgba(255,140,0,0.05), rgba(0,0,0,0)); border: 1px solid rgba(255,140,0,0.2); display:none; padding: 15px;">
        <h3 style="margin-top:0; font-size: 13px; color:#f8fafc; font-weight:800; letter-spacing:1px; text-transform:uppercase; display:flex; align-items:center; gap:8px;">
            <span style="color:var(--accent); font-size:16px;">‚ú¶</span> Pro Analytics
        </h3>
        <div id="body-summary-grid" class="ana-grid"></div>
    </div>

    <div class="chart-container" id="body-col-bp" style="margin-bottom: 15px; border: 1px solid rgba(239, 68, 68, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('body-col-bp')">
            <h3 style="margin:0; color:#ef4444; font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">ü´Ä Blutdruck & Puls</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:5px; text-align:center; font-weight:700;">DATUM W√ÑHLEN</div>
            <input type="date" id="bp-date" class="weight-input" style="margin-bottom: 15px; width: 200px; display: block; margin-left: auto; margin-right: auto;">
            
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <input type="number" id="bp-sys" class="weight-input" placeholder="SYS" style="margin-bottom:0; font-size:16px; font-weight:bold; color:#4facfe;">
                <span style="color:#94a3b8; font-size:24px; font-weight:100;">/</span>
                <input type="number" id="bp-dia" class="weight-input" placeholder="DIA" style="margin-bottom:0; font-size:16px; font-weight:bold; color:#f59e0b;">
            </div>
            <input type="number" id="bp-pulse" class="weight-input" placeholder="Puls (BPM) - optional" style="margin-bottom:15px; font-size:14px;">
            
            <button class="btn-action" style="background: #ef4444;" onclick="saveBp()">WERTE SPEICHERN</button>
            <div id="bp-msg" style="text-align:center; font-size:12px; color:#22c55e; height:15px; margin-top:5px;"></div>
            
            <div id="bp-weekly-avg" style="text-align:center; font-size:11px; margin-top:15px; color: #cbd5e1; font-weight:800; letter-spacing:0.5px; display:none;"></div>
            <div style="position: relative; height: 180px; width: 100%; margin-top: 10px;">
                <canvas id="bpChart"></canvas>
            </div>
            <div id="bp-history-list" style="margin-top: 20px;"></div>
        </div>
    </div>
    <div class="chart-container" id="body-col-tracking" style="margin-bottom: 15px; border: 1px solid rgba(79, 172, 254, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('body-col-tracking')">
            <h3 style="margin:0; color:var(--day-glow); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">ü¶æ GEWICHT</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:5px; text-align:center; font-weight:700;">DATUM W√ÑHLEN</div>
            <input type="date" id="w-date" class="weight-input">
            <input type="number" id="w-val" class="weight-input" step="0.1" placeholder="Gewicht in kg">
            <div id="trend-ui" style="text-align:center; font-size:11px; margin-bottom:10px; color: #64748b; font-weight:600; letter-spacing:0.5px; height: 15px;"></div>
            <button class="btn-action" style="background: var(--accent)" onclick="addWeight()">LOG GEWICHT</button>
            <canvas id="weightChart" style="margin-top:20px;"></canvas>
        </div>
    </div>

    <div class="chart-container" id="body-col-masse" style="margin-bottom: 15px; border: 1px solid rgba(255, 140, 0, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('body-col-masse')">
            <h3 style="margin:0; color:var(--accent); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">üìè K√∂rperumfang</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:5px; text-align:center; font-weight:700;">DATUM W√ÑHLEN</div>
            <input type="date" id="m-date" class="weight-input" style="margin-bottom: 15px;">
                <div class="ana-grid">
        <input type="number" id="m-brust" class="weight-input" placeholder="Brust (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-schultern" class="weight-input" placeholder="Schultern (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-bauch" class="weight-input" placeholder="Bauch (cm)" style="grid-column: span 2; margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-bizeps-l" class="weight-input" placeholder="L Bizeps (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-bizeps-r" class="weight-input" placeholder="R Bizeps (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-beine-l" class="weight-input" placeholder="L Bein (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-beine-r" class="weight-input" placeholder="R Bein (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-waden-l" class="weight-input" placeholder="L Wade (cm)" style="margin-bottom:0; font-size: 14px;">
        <input type="number" id="m-waden-r" class="weight-input" placeholder="R Wade (cm)" style="margin-bottom:0; font-size: 14px;">
    </div>
            <button class="btn-action" style="background: var(--accent); margin-top: 15px;" onclick="saveMasse()">MA√üE SPEICHERN</button>
            <div id="masse-msg" style="text-align:center; font-size:12px; color:#22c55e; height:15px; margin-top: 5px;"></div>
            
            <div id="masse-history-list" style="margin-top: 15px;"></div>
        </div>
    </div>
    <div class="chart-container" id="body-col-labor" style="margin-bottom: 15px; border: 1px solid rgba(168, 85, 247, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('body-col-labor')">
            <h3 style="margin:0; color:var(--labor-glow); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; text-align: left;">ü©∏ Laborwerte</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:5px; text-align:center; font-weight:700;">DATUM W√ÑHLEN</div>
            <input type="date" id="l-date" class="weight-input" style="margin-bottom: 15px;">
            
            <div id="labor-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button class="btn-action" style="background: rgba(255,255,255,0.05); border: 1px dashed var(--labor-glow); color: var(--labor-glow); margin-bottom: 0;" onclick="promptAddLab()">+ NEUER WERT</button>
                <button class="btn-action" style="background: var(--labor-glow); margin-bottom: 0;" onclick="saveLabValues()">SPEICHERN</button>
            </div>
            <div id="labor-msg" style="text-align:center; font-size:12px; color:#22c55e; height:15px; margin-top: 5px;"></div>
            
            <div id="lab-history-list" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div class="chart-container" id="body-col-feedback" style="margin-bottom: 15px; border: 1px solid rgba(34, 197, 94, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('body-col-feedback')">
            <h3 style="margin:0; color:var(--success); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">‚ö° Bio-Feedback</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div class="slider-container"><div class="slider-label"><span>Energie</span><span id="val-energy">50%</span></div><div class="battery-container"><div class="battery-outer"><div id="fill-energy" class="battery-level" style="width:50%"></div></div><div class="battery-nub"></div><input type="range" min="0" max="100" value="50" oninput="updSl('energy', this.value)" id="sl-energy" class="battery-input"></div></div>
            <div class="slider-container"><div class="slider-label"><span>Fokus & Klarheit</span><span id="val-focus">50%</span></div><div class="battery-container"><div class="battery-outer"><div id="fill-focus" class="battery-level" style="width:50%"></div></div><div class="battery-nub"></div><input type="range" min="0" max="100" value="50" oninput="updSl('focus', this.value)" id="sl-focus" class="battery-input"></div></div>
            <div class="slider-container"><div class="slider-label"><span>Schlafqualit√§t</span><span id="val-sleep">50%</span></div><div class="battery-container"><div class="battery-outer"><div id="fill-sleep" class="battery-level" style="width:50%"></div></div><div class="battery-nub"></div><input type="range" min="0" max="100" value="50" oninput="updSl('sleep', this.value)" id="sl-sleep" class="battery-input"></div></div>
            <button class="btn-action" style="background: #334155" onclick="saveFeedback()">WERTE SPEICHERN</button>
            <div id="feedback-msg" style="text-align:center; font-size:12px; color:#22c55e; height:15px;"></div>
        </div>
    </div>

    <div class="chart-container" id="body-col-radar" style="margin-bottom: 15px; border: 1px solid rgba(16, 185, 129, 0.3);">
        <div class="collapse-header" onclick="tglCollapse('body-col-radar')">
            <h3 style="margin:0; color:var(--radar-glow); font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">üï∏Ô∏è BIO-ANALYSE</h3>
        </div>
        <div class="collapse-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button id="btn-radar-7d" class="btn-action" style="background:var(--accent); margin:0; padding:8px 15px; font-size:11px; width:auto;" onclick="setRadarMode('7d')">7 TAGE</button>
                <button id="btn-radar-all" class="btn-action" style="background:rgba(255,255,255,0.1); border:1px solid var(--accent); margin:0; padding:8px 15px; font-size:11px; color:white; width:auto;" onclick="setRadarMode('all')">DAUERHAFT</button>
            </div>
            <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>

</div>

<div id="page-market" class="page">
    <h2>Katalog</h2>
    <button class="btn-action" style="background: rgba(255,255,255,0.05); border: 1px solid #64748b; color: #94a3b8; font-size: 12px; padding: 10px;" onclick="openWiki()">üìö GUIDE: WAS BRAUCHE ICH?</button>
    <button class="btn-action" style="background: #1e293b; border: 1px solid var(--accent); color: var(--accent); margin-bottom: 20px;" onclick="tglAddForm()">+ NEUES SUPPLEMENT</button>
    <div id="add-supp-form" class="add-supp-form">
        <input type="text" id="new-icon" placeholder="Symbol (Emoji nutzen üíä, üåø, üß†)">
        <input type="text" id="new-brand" placeholder="Marke">
        <input type="text" id="new-name" placeholder="Name">
        <input type="text" id="new-unit" placeholder="Einheit (z.B. Caps, ml, g)">
        <div style="display:flex; gap:10px;">
    <input type="number" id="new-stock" placeholder="Aktueller Bestand" style="flex:1.2">
    <input type="number" id="new-restock-qty" placeholder="Std-Kaufmenge" style="flex:1">
    <input type="number" id="new-price" step="0.01" placeholder="Preis (‚Ç¨)" style="flex:2">
</div>
        <textarea id="new-nutri" placeholder="N√§hrstoffe (Einer pro Zeile, z.B.&#10;Zink: 25 mg&#10;Magnesium: 100 mg)" rows="3"></textarea>
        <button id="btn-save-supp" class="btn-action" style="background: var(--accent); margin-top: 10px;" onclick="saveNewSupp()">IM KATALOG SPEICHERN</button>
    </div>
    <div id="market-list"></div>
</div>

<div id="page-profile" class="page">
    <h2>Cloud & Historie</h2>

    <div class="level-card" onclick="openRanksModal()">
        <span class="level-trophy" id="lvl-icon">üå±</span>
        <div class="level-title" id="lvl-name">Level 1: Starter</div>
        <div class="level-xp" id="lvl-xp">0 / 250 XP</div>
        <div class="xp-bar-bg"><div class="xp-bar-fill" id="lvl-bar"></div></div>
        <div style="font-size:10px; color:#64748b; margin-top:10px; text-transform:uppercase; letter-spacing:1px;">Alle R√§nge ansehen ‚ûî</div>
    </div>

    <div class="chart-container" style="margin-bottom: 20px; border: 1px solid var(--day-glow);" id="sec-travel">
        <div class="collapse-header" onclick="tglCollapse('sec-travel')"><h3 style="margin:0; color:var(--day-glow);">üåç Reise-Tracker</h3></div>
        <div class="collapse-content">
            <div style="font-size:11px; color:#94a3b8; margin-bottom:10px;">Wie viele Tage bist du unterwegs?</div>
            <input type="number" id="travel-days" class="weight-input" placeholder="Anzahl Tage" oninput="calcTravelKit()">
            <div id="travel-result" style="margin-top:15px;"></div>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 20px;" id="sec-history"><div class="collapse-header" onclick="tglCollapse('sec-history')"><h3 style="margin:0">Verlauf</h3></div><div class="collapse-content"><div id="history-list"></div></div></div>
    
    <div class="chart-container">
        <button class="btn-action" style="background: #334155; margin-top: 0;" onclick="openSettingsModal()">‚öôÔ∏è EINSTELLUNGEN & PROFIL</button>
    </div>
</div>
</div>
<div id="settings-modal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="max-width: 90%; width: 350px; max-height: 85vh; overflow-y: auto; text-align: left; padding: 20px;">
        <div class="custom-modal-title" style="text-align: center; margin-bottom: 20px;">‚öô Profil & Einstellungen</div>

        <div style="margin-bottom: 20px; text-align: left; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
            <label style="font-size:11px; color:#94a3b8; font-weight:800; display:block; margin-bottom:8px; text-transform:uppercase;">üöÄ Start-Tab (beim √ñffnen)</label>
            <select id="setting-start-tab" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; font-size: 14px; outline: none; font-weight:bold; cursor:pointer;" onchange="saveStartTab()">
                <option value="plan" style="color:black;">Plan (Standard)</option>
                <option value="market" style="color:black;">Katalog</option>
                <option value="gym" style="color:black;">Gym</option>
                <option value="weight" style="color:black;">Body</option>
                <option value="profile" style="color:black;">Cloud & Historie</option>
            </select>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0; margin-bottom: 15px;" id="set-col-dash">
            <div class="collapse-header" onclick="tglCollapse('set-col-dash')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">‚ú¶ Dashboard Anzeige</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px;">
                
                <details style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <summary style="font-size:12px; font-weight:bold; color:var(--day-glow); cursor:pointer; outline:none; list-style:none;">üìã Plan & Allgemein ‚ñæ</summary>
                    <div style="margin-top:10px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-fasting"> Fasten-Tracker anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-top-level"> Level-Badge oben dauerhaft anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-haptic"> Haptisches Feedback (Vibration)</label>
                    </div>
                </details>

                <details style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <summary style="font-size:12px; font-weight:bold; color:var(--accent); cursor:pointer; outline:none; list-style:none;">ü¶æ Body (Haupt-Widgets) ‚ñæ</summary>
                    <div style="margin-top:10px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-bp"> Blutdruck anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-gewicht"> Gewicht anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-masse"> K√∂rperma√üe anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-labor"> Laborwerte anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-radar"> Bio-Analyse (Radar) anzeigen</label>
                    </div>
                </details>

                <details style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <summary style="font-size:12px; font-weight:bold; color:var(--success); cursor:pointer; outline:none; list-style:none;">üìä Body (Pro Analytics Kacheln) ‚ñæ</summary>
                    <div style="margin-top:10px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-bmi"> BMI anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-whtr"> WHtR (Bauchfett) anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-whr"> WHR (Taille-H√ºfte) anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-grund"> Grundumsatz anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-leistung"> Leistungsumsatz anzeigen</label>
                        <label class="checkbox-row"><input type="checkbox" id="chk-show-gesamt"> Gesamtumsatz anzeigen</label>
                    </div>
                </details>

            </div>
        </div>
        
        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-personal">
            <div class="collapse-header" onclick="tglCollapse('set-col-personal')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">üë§ Pers√∂nliche Daten</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px;">
                <div style="display:flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="set-name" class="weight-input" placeholder="Name" style="margin-bottom:0;">
                    <select id="set-gender" class="weight-input" style="margin-bottom:0;">
                        <option value="m">M√§nnlich</option>
                        <option value="f">Weiblich</option>
                    </select>
                    <input type="number" id="set-age" class="weight-input" placeholder="Alter" style="margin-bottom:0;">
                    <input type="number" id="set-height" class="weight-input" placeholder="Gr√∂√üe (cm)" style="margin-bottom:0;">
                    <input type="number" id="set-weight" class="weight-input" placeholder="Gewicht (kg)" style="margin-bottom:0;">
                    <div style="font-size:11px; color:#94a3b8; margin-bottom:-5px; margin-top:5px;">Geburtsdatum</div>
                    <input type="date" id="set-birth" class="weight-input" style="margin-bottom:0;">
                </div>
            </div>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-cycle">
            <div class="collapse-header" onclick="tglCollapse('set-col-cycle')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid rgba(236, 72, 153, 0.4);">
                <h3 style="color:#ec4899; font-size: 14px; margin: 0;">üå∏ Zyklus & Rhythmus</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(236, 72, 153, 0.05); border-radius: 12px; margin-top: 5px;">
                <label class="checkbox-row" style="margin-bottom:20px; font-size:13px; font-weight:bold;"><input type="checkbox" id="chk-show-cycle"> <span style="color:#ec4899;">Zyklus-Tracker anzeigen</span></label>
                
                <div style="font-size:11px; color:#ec4899; margin-bottom:5px; font-weight:bold;">START-DATUM (TAG 1)</div>
                <input type="date" id="set-cycle-start" class="weight-input" style="border-color:rgba(236, 72, 153, 0.4);">
                
                <div style="font-size:11px; color:#ec4899; margin-bottom:5px; margin-top:5px; font-weight:bold;">ZYKLUSL√ÑNGE (TAGE)</div>
                <input type="number" id="set-cycle-length" class="weight-input" placeholder="z.B. 28" value="28" style="border-color:rgba(236, 72, 153, 0.4); margin-bottom:0;">
            </div>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-bmi">
            <div class="collapse-header" onclick="tglCollapse('set-col-bmi')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">‚öñÔ∏è BMI Rechner</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px;">
                <button class="btn-action" style="background: var(--accent); padding: 12px; font-size: 12px;" onclick="calcBMI()">BMI BERECHNEN</button>
                <div id="res-bmi" style="display: none; margin-top: 15px; font-size: 12px; line-height: 1.5; color: #cbd5e1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border);"></div>
            </div>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-whr">
            <div class="collapse-header" onclick="tglCollapse('set-col-whr')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">üìè Umfang Analyse</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px;">
                <div style="display:flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                    <input type="number" id="set-waist" class="weight-input" placeholder="Taillenumfang (cm)" style="margin-bottom:0;">
                    <input type="number" id="set-hip" class="weight-input" placeholder="H√ºftumfang (cm)" style="margin-bottom:0;">
                </div>
                <button class="btn-action" style="background: var(--accent); padding: 12px; font-size: 12px;" onclick="calcWHR()">UMFANG BERECHNEN</button>
                <div id="res-whr" style="display: none; margin-top: 15px; font-size: 12px; line-height: 1.5; color: #cbd5e1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border);"></div>
            </div>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-cal">
            <div class="collapse-header" onclick="tglCollapse('set-col-cal')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">üî• Kalorienrechner</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px;">
                <div style="font-size:11px; color:#94a3b8; margin-bottom:5px;">Bitte genau 24 Stunden verteilen:</div>
                <div id="pal-total-counter" style="font-size:13px; font-weight:800; color:var(--danger); margin-bottom:15px; text-align:center;">Stunden: 0 / 24h</div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:12px; color:#e2e8f0;">Schlafen (PAL 0.95)</span>
                    <input type="number" id="pal-sleep" class="weight-input pal-input" style="width:60px; padding:8px; margin:0;" value="8" oninput="updatePalStatus()">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:12px; color:#e2e8f0;">Freizeit/Couch (PAL 1.2)</span>
                    <input type="number" id="pal-relax" class="weight-input pal-input" style="width:60px; padding:8px; margin:0;" value="4" oninput="updatePalStatus()">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:12px; color:#e2e8f0;">B√ºro/Sitzend (PAL 1.45)</span>
                    <input type="number" id="pal-sit" class="weight-input pal-input" style="width:60px; padding:8px; margin:0;" value="8" oninput="updatePalStatus()">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:12px; color:#e2e8f0;">Gehen/Stehen (PAL 1.65)</span>
                    <input type="number" id="pal-stand" class="weight-input pal-input" style="width:60px; padding:8px; margin:0;" value="3" oninput="updatePalStatus()">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span style="font-size:12px; color:#e2e8f0;">Sport/Arbeit (PAL 2.0)</span>
                    <input type="number" id="pal-sport" class="weight-input pal-input" style="width:60px; padding:8px; margin:0;" value="1" oninput="updatePalStatus()">
                </div>

                <button class="btn-action" style="background: var(--accent); padding: 12px; font-size: 12px;" onclick="calcCalories()">KALORIEN BERECHNEN</button>
                <div id="res-cal" style="display: none; margin-top: 15px; font-size: 12px; line-height: 1.5; color: #cbd5e1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border);"></div>
            </div>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-backup">
            <div class="collapse-header" onclick="tglCollapse('set-col-backup')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">‚òÅÔ∏è Cloud & Backup</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px; text-align:center;">
                
                <div id="google-login-section">
                    <p style="font-size:11px; color:#94a3b8; margin-bottom:10px;">Mit Google Drive verbinden f√ºr Cloud-Backups.</p>
                    <button class="btn-action" style="background: white; color: black; display:flex; align-items:center; justify-content:center; gap:10px; font-size:12px; padding:12px;" onclick="handleAuthClick()">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="16"> √úber Google anmelden
                    </button>
                </div>

                <div id="google-user-section" style="display:none; margin-bottom:15px;">
                    <div style="font-size:12px; color:var(--success); font-weight:800; margin-bottom:2px;">‚úì Verbunden</div>
                    <div id="google-user-name" style="font-size:10px; color:#94a3b8; margin-bottom:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-action" style="background: var(--day-glow); font-size: 10px; padding: 12px; margin:0;" onclick="syncToDrive()">‚òÅÔ∏è ZU DRIVE SPEICHERN</button>
                        <button class="btn-action" style="background: var(--warning); font-size: 10px; padding: 12px; margin:0; color:black;" onclick="restoreFromDrive()">‚¨áÔ∏è VON DRIVE LADEN</button>
                    </div>
                </div>

                <hr style="border:0; border-top:1px dashed rgba(255,255,255,0.1); margin:15px 0;">

                <div style="font-size:10px; color:#64748b; margin-bottom:10px; text-transform:uppercase; font-weight:bold;">Lokales Datei-Backup</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-action" style="background: rgba(255,255,255,0.05); border:1px solid var(--glass-border); font-size: 10px; padding: 10px; margin:0;" onclick="exportBackup()">üíæ LOKAL SPEICHERN</button>
                    <input type="file" id="fileInput" style="display:none;" accept=".json" onchange="importBackup(event)">
                    <button class="btn-action" style="background: rgba(255,255,255,0.05); border:1px solid var(--glass-border); font-size: 10px; padding: 10px; margin:0;" onclick="document.getElementById('fileInput').click()">üìÇ LOKAL LADEN</button>
                </div>
            </div>
        </div>

        <div class="chart-container" style="padding: 0; background: transparent; border: none; margin: 0 0 15px 0;" id="set-col-security">
            <div class="collapse-header" onclick="tglCollapse('set-col-security')" style="background: var(--glass); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <h3 style="color:var(--day-glow); font-size: 14px; margin: 0;">üîí Sicherheit</h3>
            </div>
            <div class="collapse-content" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 5px;">
                <button class="btn-action" style="background: rgba(255,255,255,0.05); border: 1px dashed var(--accent); color: var(--accent); margin-bottom: 0;" onclick="setupPinLock()">üîí APP-SPERRE EINRICHTEN</button>
            </div>
        </div>

        <button class="modal-btn btn-confirm" style="width:100%; margin-top:15px;" onclick="closeSettingsModal()">SCHLIE√üEN & SPEICHERN</button>
    </div>
</div>

        <button class="modal-btn btn-confirm" style="width:100%; margin-top:15px;" onclick="closeSettingsModal()">SCHLIE√üEN & SPEICHERN</button>
    </div>
</div>

<div id="ranks-modal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="max-width: 90%; width: 350px;">
        <div class="custom-modal-title">BioHacker R√§nge üèÜ</div>
        <div class="custom-modal-text">Sammle XP durch Tracken & Abhaken</div>
        
        <div class="wiki-list" style="margin-top: 15px;" id="ranks-list-container">
            </div>

        <button class="modal-btn btn-confirm" style="margin-top:15px;" onclick="closeRanksModal()">Schlie√üen</button>
    </div>
</div>
<script>
    window.isCardSwiping = false;

    // --- HAPTISCHES FEEDBACK ---
    function vBuz(pattern) {
        if (db.analytics && db.analytics.haptic && 'vibrate' in navigator) {
            navigator.vibrate(pattern);
        }
    }

    // NEU: Globaler Listener f√ºr alle Klicks auf interaktive Elemente
    document.addEventListener('click', function(e) {
        // .closest() f√§ngt den Klick ab, selbst wenn ein Emoji IN einem Button geklickt wird
        if (e.target.closest('button') || 
            e.target.closest('.btn-action') || 
            e.target.closest('.modal-btn') ||
            e.target.closest('.gym-day-tab') ||
            e.target.closest('.num-btn') ||
            e.target.closest('.nav-arrow') ||
            e.target.closest('.icon-box')) {
            
            vBuz(15); // Knackige 15ms Vibration f√ºr Tasten-Feedback
        }
    }, { passive: true });

    function getGermanDay() {
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        return days[new Date().getDay()];
    }

    const STORAGE_KEY = 'biostack_infinite_v19_2_personal'; 
    let pId = null, currentInput = "", weightChart = null, radarChartInstance = null, gymChartInstance = null, bpChartInstance = null, editingId = null, currentPauseId = null;
    let dayOffset = 0;
    let radarMode = '7d';
    
    // NEU: Flex-Planer Status
    let currentFlexDay = getGermanDay();
    
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { 
        startDate: getTodayDate(), 
        userName: "", 
        activeSupps: [], history: {}, weightData: [], 
        customSupps: [], stock: {}, prices: {}, feedback: {},
        measurements: { schultern: '', brust: '', bizeps: '', bauch: '', beine: '', waden: '' },
        measurementsHistory: [],
        fasting: { active: false, startTime: null, duration: 16, notified: false },
        personal: { age: '', height: '', weight: '', birthdate: '', gender: 'm', waist: '', hip: '', pal: { sleep: 8, relax: 4, sit: 8, stand: 3, sport: 1 } },
        analytics: { bmi: null, whtr: null, whr: null, grundumsatz: null, gesamtumsatz: null, leistungsumsatz: null, showGewicht: true, showBmi: true, showWhtr: true, showWhr: true, showGrund: true, showLeistung: true, showGesamt: true, showFasting: true, showMasse: true, showLabor: true, showRadar: true, haptic: true },
        gym: { plans: { 'Montag':[], 'Dienstag':[], 'Mittwoch':[], 'Donnerstag':[], 'Freitag':[], 'Samstag':[], 'Sonntag':[] }, logs: [] }
    };

    if (!localStorage.getItem(STORAGE_KEY)) {
         const d = new Date(); d.setDate(d.getDate() - 1); 
         const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
         db.startDate = local.toISOString().split('T')[0];
         save();
    }
    
    if(!db.fasting) db.fasting = { active: false, startTime: null, duration: 16, notified: false };
    if(!db.personal) db.personal = { age: '', height: '', weight: '', birthdate: '', gender: 'm', waist: '', hip: '', pal: { sleep: 8, relax: 4, sit: 8, stand: 3, sport: 1 } };
    if(!db.personal.pal) db.personal.pal = { sleep: 8, relax: 4, sit: 8, stand: 3, sport: 1 };
    if(!db.measurements) db.measurements = { schultern: '', brust: '', bizeps: '', bauch: '', beine: '', waden: '' };
    if(!db.measurementsHistory) db.measurementsHistory = [];
    if(!db.analytics) db.analytics = { bmi: null, whtr: null, whr: null, grundumsatz: null, gesamtumsatz: null, leistungsumsatz: null, showGewicht: true, showBmi: true, showWhtr: true, showWhr: true, showGrund: true, showLeistung: true, showGesamt: true, showFasting: true, showMasse: true, showLabor: true, showRadar: true, haptic: true };
    if(db.analytics.showGewicht === undefined) { db.analytics.showGewicht = true; db.analytics.showBmi = true; db.analytics.showWhtr = true; db.analytics.showWhr = true; db.analytics.showGrund = true; db.analytics.showLeistung = true; db.analytics.showGesamt = true; }
    if(db.analytics.showFasting === undefined) db.analytics.showFasting = true;
    if(db.analytics.showMasse === undefined) db.analytics.showMasse = true;
    if(!db.analytics.showLabor === undefined) db.analytics.showLabor = true;
    if(db.analytics.showRadar === undefined) db.analytics.showRadar = true;
    if(!db.bpData) db.bpData = [];
    if(db.analytics.showBp === undefined) db.analytics.showBp = true;
    if(db.analytics.haptic === undefined) db.analytics.haptic = true;
    if(!db.deletedSupps) db.deletedSupps = []; // NEU: Speichert gel√∂schte Base-Items
    
    // --- GYM INIT ---
    if(!db.gym) db.gym = { plans: { 'Montag':[], 'Dienstag':[], 'Mittwoch':[], 'Donnerstag':[], 'Freitag':[], 'Samstag':[], 'Sonntag':[] }, logs: [] };

    if(!db.labTrackers) db.labTrackers = [
        { id: 'd3', name: 'Vitamin D3', unit: 'ng/ml' },
        { id: 'testo', name: 'Testosteron', unit: 'ng/dl' },
        { id: 'omega3', name: 'Omega-3 Index', unit: '%' }
    ];
    if(!db.labData) db.labData = {};
    if(!db.labHistory) db.labHistory = [];

    function updateDashboardView() {
        const bpWidget = document.getElementById('body-col-bp');
        if(bpWidget) bpWidget.style.display = db.analytics.showBp ? 'block' : 'none';

        const fWidget = document.getElementById('fasting-widget-container');
        if(fWidget) fWidget.style.display = db.analytics.showFasting ? 'flex' : 'none';
        
        const mWidget = document.getElementById('body-col-masse');
        if(mWidget) mWidget.style.display = db.analytics.showMasse ? 'block' : 'none';

        const lWidget = document.getElementById('body-col-labor');
        if(lWidget) lWidget.style.display = db.analytics.showLabor ? 'block' : 'none';

        const rWidget = document.getElementById('body-col-radar');
        if(rWidget) rWidget.style.display = db.analytics.showRadar ? 'block' : 'none';
        
        if(typeof updateCycleUI === 'function') updateCycleUI();
    }

    function updateBodySummary() {
        const box = document.getElementById('body-analytics-summary');
        const grid = document.getElementById('body-summary-grid');
        if(!grid) return;
        
        // √Ñndert das Grid-Layout programmatisch in unser neues Listen-Layout
        grid.className = "analytics-list-wrapper";

        let html = "";
        let hasData = false;
        
        // Basis-Wert f√ºr die Fortschrittsbalken (100% = Gesamtumsatz, falls vorhanden, sonst 3000 als Dummy)
        const maxKcal = db.analytics.gesamtumsatz ? db.analytics.gesamtumsatz : 3000;

        if(db.analytics.grundumsatz && db.analytics.showGrund) {
            let pct = Math.min((db.analytics.grundumsatz / maxKcal) * 100, 100);
            html += `
            <div class="analytics-list-item">
                <div class="analytics-header">
                    <div class="analytics-label"><span style="color:var(--accent); font-size:18px;">üî•</span> Grundumsatz</div>
                    <div class="analytics-value-wrap">
                        <span class="analytics-value">${db.analytics.grundumsatz}</span>
                        <span class="analytics-subtext">kcal / Tag</span>
                    </div>
                </div>
                <div class="analytics-bar-bg"><div class="analytics-bar-fill" style="width: ${pct}%; background: var(--accent); box-shadow: 0 0 10px rgba(255,140,0,0.5);"></div></div>
            </div>`;
            hasData = true;
        }

        if(db.analytics.leistungsumsatz && db.analytics.showLeistung) {
            let pct = Math.min((db.analytics.leistungsumsatz / maxKcal) * 100, 100);
            html += `
            <div class="analytics-list-item">
                <div class="analytics-header">
                    <div class="analytics-label"><span style="color:var(--day-glow); font-size:18px;">‚ö°</span> Leistungsumsatz</div>
                    <div class="analytics-value-wrap">
                        <span class="analytics-value">${db.analytics.leistungsumsatz}</span>
                        <span class="analytics-subtext">kcal / Tag</span>
                    </div>
                </div>
                <div class="analytics-bar-bg"><div class="analytics-bar-fill" style="width: ${pct}%; background: var(--day-glow); box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);"></div></div>
            </div>`;
            hasData = true;
        }

        if(db.analytics.gesamtumsatz && db.analytics.showGesamt) {
            html += `
            <div class="analytics-list-item">
                <div class="analytics-header">
                    <div class="analytics-label"><span style="color:var(--success); font-size:18px;">üéØ</span> Gesamtumsatz</div>
                    <div class="analytics-value-wrap">
                        <span class="analytics-value" style="color:var(--success);">${db.analytics.gesamtumsatz}</span>
                        <span class="analytics-subtext">kcal / Tag</span>
                    </div>
                </div>
                <div class="analytics-bar-bg"><div class="analytics-bar-fill" style="width: 100%; background: var(--success); box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);"></div></div>
            </div>`;
            hasData = true;
        }

        // Weitere Parameter als schmale Liste anh√§ngen, falls aktiv
        if((db.personal.weight && db.analytics.showGewicht) || (db.analytics.bmi && db.analytics.showBmi) || (db.analytics.whtr && db.analytics.showWhtr) || (db.analytics.whr && db.analytics.showWhr)) {
            html += `<div class="analytics-list-item" style="padding: 10px 15px;">`;
            if(db.personal.weight && db.analytics.showGewicht) html += `<div style="display:flex; justify-content:space-between; margin: 4px 0;"><span style="color:#94a3b8; font-size:12px; font-weight:700;">Aktuelles Gewicht</span><span style="color:white; font-weight:800; font-size:13px;">${db.personal.weight} kg</span></div>`;
            if(db.analytics.bmi && db.analytics.showBmi) html += `<div style="display:flex; justify-content:space-between; margin: 4px 0;"><span style="color:#94a3b8; font-size:12px; font-weight:700;">BMI (Body Mass Index)</span><span style="color:white; font-weight:800; font-size:13px;">${db.analytics.bmi}</span></div>`;
            if(db.analytics.whtr && db.analytics.showWhtr) html += `<div style="display:flex; justify-content:space-between; margin: 4px 0;"><span style="color:#94a3b8; font-size:12px; font-weight:700;">WHtR (Bauchfett-Index)</span><span style="color:white; font-weight:800; font-size:13px;">${db.analytics.whtr}</span></div>`;
            if(db.analytics.whr && db.analytics.showWhr) html += `<div style="display:flex; justify-content:space-between; margin: 4px 0;"><span style="color:#94a3b8; font-size:12px; font-weight:700;">WHR (Taille-H√ºfte)</span><span style="color:white; font-weight:800; font-size:13px;">${db.analytics.whr}</span></div>`;
            html += `</div>`;
            hasData = true;
        }

        if(hasData) {
            grid.innerHTML = html;
            box.style.display = "block";
        } else {
            box.style.display = "none";
        }
    }

    function updatePalStatus() {
        const slp = parseFloat(document.getElementById('pal-sleep').value) || 0;
        const rlx = parseFloat(document.getElementById('pal-relax').value) || 0;
        const sit = parseFloat(document.getElementById('pal-sit').value) || 0;
        const std = parseFloat(document.getElementById('pal-stand').value) || 0;
        const spt = parseFloat(document.getElementById('pal-sport').value) || 0;
        const total = slp + rlx + sit + std + spt;
        
        const counter = document.getElementById('pal-total-counter');
        if(counter) {
            counter.innerText = `Stunden: ${total.toFixed(1)} / 24h`;
            counter.style.color = (total === 24) ? "var(--success)" : "var(--danger)";
        }
    }

    function calcTravelKit() {
        const days = parseInt(document.getElementById('travel-days').value);
        const resDiv = document.getElementById('travel-result');
        if(!days || days <= 0) { resDiv.innerHTML = ""; return; }
        
        const fullCat = getFullCatalog();
        let summary = {};
        
        db.activeSupps.forEach(as => {
            const s = fullCat.find(x => x.id === as.id);
            if(s) {
                if(!summary[as.id]) {
                    summary[as.id] = { name: s.name, icon: s.icon, unit: s.unit, total: 0 };
                }
                summary[as.id].total += (as.amount * days);
            }
        });
        
        let html = `<div class="gsb-card" style="text-align:left; border:1px solid rgba(79, 172, 254, 0.3);">`;
        html += `<div style="font-size:12px; font-weight:800; margin-bottom:10px; color:var(--day-glow);">PACKLISTE F√úR ${days} TAGE</div>`;
        
        for(let id in summary) {
            const item = summary[id];
            html += `<div class="gsb-row">
                <span class="gsb-label">${item.icon} ${item.name}</span>
                <span class="gsb-value" style="color:white;">${item.total} ${item.unit}</span>
            </div>`;
        }
        
        if(Object.keys(summary).length === 0) html += `<div style="font-size:12px; opacity:0.6;">Keine Supplements im Plan gefunden.</div>`;
        
        html += `</div>`;
        resDiv.innerHTML = html;
    }

    function initWelcome() {
        const titleText = document.getElementById('start-text');
        const input = document.getElementById('user-name-input');
        const btn = document.getElementById('user-name-btn');
        const hint = document.getElementById('swipe-hint');
        
        if (!db.userName || db.userName.trim() === "") {
            titleText.innerHTML = "Lass uns beginnen.<br>Wie darf ich dich nennen?";
            input.style.display = "block";
            btn.style.display = "inline-block";
            hint.style.display = "none";
        } else {
            titleText.innerHTML = `Willkommen zur√ºck, <span style="color:var(--accent); font-weight:bold">${db.userName}</span>.<br><br>Dein Stack, deine Daten.<br>Deine Optimierung.`;
            input.style.display = "none";
            btn.style.display = "none";
            hint.style.display = "block";
        }
    }
    
    function saveUserName() {
        const input = document.getElementById('user-name-input');
        const val = input.value.trim();
        if (val) {
            db.userName = val;
            save();
            initWelcome();
        }
    }
    initWelcome();

    function toggleFasting() {
        if(db.fasting.active) {
            db.fasting.active = false;
            db.fasting.startTime = null;
            db.fasting.notified = false;
        } else {
            db.fasting.active = true;
            db.fasting.startTime = new Date().getTime();
            db.fasting.notified = false;
        }
        save(); updateFastingUI();
    }

    function setFastingGoal() {
        db.fasting.duration = parseInt(document.getElementById('f-goal').value);
        save(); updateFastingUI();
    }

    function updateFastingUI() {
        const ring = document.getElementById('f-ring');
        if(!ring) return;
        
        const btn = document.getElementById('f-btn');
        const timeEl = document.getElementById('f-time');
        const lblEl = document.getElementById('f-lbl');
        const goalEl = document.getElementById('f-goal');
        if(goalEl) goalEl.value = db.fasting.duration || 16;

        if(db.fasting.active && db.fasting.startTime) {
            btn.innerText = "BEENDEN";
            btn.style.background = "var(--danger)";
            
            const now = new Date().getTime();
            const elapsedMs = now - db.fasting.startTime;
            const durationMs = (db.fasting.duration || 16) * 3600 * 1000;
            let pct = (elapsedMs / durationMs) * 100;
            if(pct > 100) pct = 100;
            
            ring.style.background = `conic-gradient(var(--day-glow) ${pct}%, rgba(255,255,255,0.05) ${pct}%)`;
            
            const remainingMs = durationMs - elapsedMs;
            if(remainingMs > 0) {
                const h = Math.floor(remainingMs / 3600000);
                const m = Math.floor((remainingMs % 3600000) / 60000);
                timeEl.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                lblEl.innerText = "NOCH";
            } else {
                const extraMs = elapsedMs - durationMs;
                const h = Math.floor(extraMs / 3600000);
                const m = Math.floor((extraMs % 3600000) / 60000);
                timeEl.innerText = `+${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                lblEl.innerText = "FERTIG";
                ring.style.background = `conic-gradient(var(--success) 100%, rgba(255,255,255,0.05) 100%)`;
                
                // Haptisches Feedback bei Ablauf
                if (!db.fasting.notified) {
                    db.fasting.notified = true;
                    save(); 
                    vBuz([200, 100, 200, 100, 400]); 
                }
            }
        } else {
            btn.innerText = "START";
            btn.style.background = "var(--success)";
            ring.style.background = `conic-gradient(rgba(255,255,255,0.05) 100%, rgba(255,255,255,0.05) 100%)`;
            timeEl.innerText = "00:00";
            lblEl.innerText = "BEREIT";
        }
    }

    setInterval(updateFastingUI, 1000);

    function checkAutoReactivation() {
        const now = new Date().getTime();
        let changed = false;
        db.activeSupps.forEach(s => {
            if (s.paused && s.pauseUntil && now >= s.pauseUntil) {
                s.paused = false; s.pauseUntil = null; changed = true;
            }
        });
        if (changed) save();
    }

    function tglCycle(id) {
        const item = db.activeSupps.find(as => as.id === id);
        if(!item) return;
        if(item.paused) {
            item.paused = false; item.pauseUntil = null; save(); renderPlan();
        } else {
            currentPauseId = id;
            document.getElementById('pause-days-input').value = '7';
            document.getElementById('cycle-modal').style.display = 'flex';
        }
    }

    function closeCycleModal() { document.getElementById('cycle-modal').style.display = 'none'; }

    function confirmCyclePause() {
        const days = parseInt(document.getElementById('pause-days-input').value) || 1;
        const item = db.activeSupps.find(as => as.id === currentPauseId);
        if(item) {
            const until = new Date(); until.setHours(0,0,0,0);
            until.setDate(until.getDate() + days);
            item.paused = true; item.pauseUntil = until.getTime();
            save(); closeCycleModal(); renderPlan();
        }
    }
    let swpStartX = 0, swpStartY = 0, swpActiveCard = null, swpSwiping = false, swpMoved = false, swpCurrentOffset = 0;
    const SWIPE_MAX = 140;

    function tsCard(e) {
        if (swpActiveCard && swpActiveCard !== e.currentTarget) {
            swpActiveCard.style.transform = 'translateX(0)';
            swpActiveCard.dataset.open = "false";
            let bg = swpActiveCard.previousElementSibling;
            if(bg && bg.classList.contains('supp-swipe-bg')) bg.style.opacity = '0';
        }
        swpActiveCard = e.currentTarget;
        swpStartX = e.touches[0].clientX;
        swpStartY = e.touches[0].clientY;
        swpSwiping = false;
        swpMoved = false;
        window.isCardSwiping = false;
        swpCurrentOffset = swpActiveCard.dataset.open === "true" ? SWIPE_MAX : 0;
        swpActiveCard.style.transition = 'none';
    }

    function tmCard(e) {
        if (!swpActiveCard) return;
        let deltaX = e.touches[0].clientX - swpStartX;
        let deltaY = e.touches[0].clientY - swpStartY;
        if (!swpMoved) {
            if (Math.abs(deltaY) > Math.abs(deltaX)) {
                swpActiveCard = null; return; 
            } else if (Math.abs(deltaX) > 10) {
                if ((deltaX > 0 && swpCurrentOffset === 0) || (deltaX < 0 && swpCurrentOffset === SWIPE_MAX)) {
                    swpSwiping = true; swpMoved = true; window.isCardSwiping = true;
                    let bg = swpActiveCard.previousElementSibling;
                    if(bg && bg.classList.contains('supp-swipe-bg')) bg.style.opacity = '1';
                } else {
                    swpActiveCard = null; return;
                }
            }
        }
        if (swpSwiping) {
            if (e.cancelable) e.preventDefault(); 
            let newX = swpCurrentOffset + deltaX;
            if (newX < 0) newX = 0; 
            if (newX > SWIPE_MAX + 30) newX = (SWIPE_MAX + 30) + (newX - (SWIPE_MAX + 30)) * 0.2; 
            swpActiveCard.style.transform = `translateX(${newX}px)`;
        }
    }

    function teCard(e, id, name) {
        if (!swpActiveCard) return;
        swpActiveCard.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
        let bg = swpActiveCard.previousElementSibling;
        if (swpSwiping) {
            let deltaX = e.changedTouches[0].clientX - swpStartX;
            let finalX = swpCurrentOffset + deltaX;
            if (finalX > SWIPE_MAX / 2) {
                swpActiveCard.style.transform = `translateX(${SWIPE_MAX}px)`;
                swpActiveCard.dataset.open = "true";
            } else {
                swpActiveCard.style.transform = 'translateX(0)';
                swpActiveCard.dataset.open = "false";
                if(bg) bg.style.opacity = '0';
            }
        } else {
             if (swpCurrentOffset === 0) {
                 swpActiveCard.style.transform = 'translateX(0)';
                 if(bg) bg.style.opacity = '0';
             }
        }
        setTimeout(() => { swpActiveCard = null; window.isCardSwiping = false; }, 50);
    }

    const pageOrder = ['plan', 'market', 'gym', 'weight', 'profile'];
    let touchStartX = 0; let touchStartY = 0;
    
    const startScreen = document.getElementById('start-screen');
    startScreen.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true});
    startScreen.addEventListener('touchend', e => {
        if (!db.userName || db.userName.trim() === "") return;
        let endY = e.changedTouches[0].screenY;
        let endX = e.changedTouches[0].screenX;
        if (touchStartY - endY > 50 || Math.abs(touchStartX - endX) > 50) { startScreen.classList.add('start-hidden'); }
    }, {passive: true});

        let disablePageSwipe = false;
    document.addEventListener('touchstart', e => { 
        touchStartX = e.changedTouches[0].screenX; 
        touchStartY = e.changedTouches[0].screenY; 
        // Seitenwisch wird blockiert bei Supp-Karten ODER der Gym-Tagesauswahl
        disablePageSwipe = !!e.target.closest('#page-plan .supp-card') || !!e.target.closest('.gym-day-tabs');
    }, {passive: true});
    
    document.addEventListener('touchend', e => {
        if (e.target.type === 'range') return; 
        
        // Pr√ºft dynamisch, ob IRGENDEIN Overlay (z.B. L√∂schen, Info, Settings) gerade sichtbar ist
        const isAnyModalOpen = Array.from(document.querySelectorAll('.custom-modal-overlay')).some(m => m.style.display === 'flex');
        if (isAnyModalOpen || document.getElementById('time-modal').style.display === 'flex' || document.getElementById('start-screen').getBoundingClientRect().top === 0) return;
        
        if (window.isCardSwiping || disablePageSwipe) return; // Seiten-Wechsel blockieren, wenn auf Karte gewischt wird
        
        let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY;
        let diffX = touchStartX - touchEndX; let diffY = touchStartY - touchEndY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 60) {
            const currentId = document.querySelector('.page.active').id.replace('page-', '');
            const currIdx = pageOrder.indexOf(currentId);
            if (diffX > 0) { if (currIdx < pageOrder.length - 1) showPage(pageOrder[currIdx + 1]); } 
            else { if (currIdx > 0) showPage(pageOrder[currIdx - 1]); }
        }
    }, {passive: true});

    function getTodayDate() { const d = new Date(); const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)); return local.toISOString().split('T')[0]; }
    function getViewDate() { const d = new Date(); d.setDate(d.getDate() + dayOffset); const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)); return local.toISOString().split('T')[0]; }
    function changeDay(delta) { dayOffset += delta; renderPlan(); if(typeof updateCycleUI === 'function') updateCycleUI(); }
    const kineticData = { 'vm_ashwa': { peak: '2-3h', duration: '8-12h' }, 'esn_crea': { peak: '1h', duration: 'Langzeit' }, 'n_omega': { peak: '4-6h', duration: '24h' }, 'le_neuro': { peak: '1.5h', duration: '6h' }, 'vm_d3k2': { peak: '24h', duration: 'Speicher' }, 'le_multi': { peak: '2-4h', duration: '8h' } };
    
    let confirmCallbackFn = null; let promptCallbackFn = null;
    
    function showAlert(text, title="Hinweis") { document.getElementById('alert-title').innerText = title; document.getElementById('alert-text').innerText = text; document.getElementById('alert-modal').style.display = 'flex'; }
    function closeAlert() { document.getElementById('alert-modal').style.display = 'none'; }
    function showConfirm(text, callback, title="Best√§tigen", btnText="L√∂schen") { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-text').innerText = text; document.getElementById('confirm-ok-btn').innerText = btnText; confirmCallbackFn = callback; document.getElementById('confirm-modal').style.display = 'flex'; }
    function confirmCallback(result) { document.getElementById('confirm-modal').style.display = 'none'; if(confirmCallbackFn) confirmCallbackFn(result); }

    const gymExercises = ["Bankdr√ºcken Langhantel", "Bankdr√ºcken Kurzhantel", "Schr√§gbankdr√ºcken Langhantel", "Schr√§gbankdr√ºcken Kurzhantel", "Negativbankdr√ºcken", "Brustpresse Maschine", "Butterfly Maschine", "Kabel Flys stehend", "Kabel Flys liegend", "Dips", "Liegest√ºtze", "Enges Bankdr√ºcken", "Pullover Kurzhantel", "Pullover Kabel", "Klimmz√ºge breit", "Klimmz√ºge eng", "Klimmz√ºge neutral", "Latzug breit", "Latzug eng", "Latzug Untergriff", "Rudern Langhantel", "Rudern Kurzhantel einarmig", "Kabelrudern sitzend", "T-Bar Rudern", "Rudermaschine", "Face Pulls", "Reverse Flys", "Hyperextensions", "Kreuzheben", "Rum√§nisches Kreuzheben", "Sumo Kreuzheben", "Good Mornings", "Kniebeugen", "Frontkniebeugen", "Hackenschmidt", "Beinpresse", "Beinstrecker", "Beinbeuger liegend", "Beinbeuger sitzend", "Bulgarian Split Squats", "Ausfallschritte", "Walking Lunges", "Step-Ups", "Hip Thrust", "Glute Bridge", "Cable Kickbacks", "Wadenheben stehend", "Wadenheben sitzend", "Wadenheben Beinpresse", "Schulterdr√ºcken Langhantel", "Schulterdr√ºcken Kurzhantel", "Arnold Press", "Seitheben Kurzhantel", "Seitheben Kabel", "Seitheben Maschine", "Vorgebeugtes Seitheben", "Upright Rows", "Shrugs Langhantel", "Shrugs Kurzhantel", "Langhantel Curls", "Kurzhantel Curls", "Hammercurls", "Konzentrationscurls", "Scott Curls", "Kabelcurls", "Reverse Curls", "Preacher Curls Maschine", "Trizepsdr√ºcken Kabel", "French Press", "Skullcrusher", "Overhead Trizepsstrecken", "Trizeps Kickbacks", "Dips eng", "Crunches", "Cable Crunch", "Beinheben liegend", "Beinheben h√§ngend", "Plank", "Seitst√ºtz", "Russian Twists", "Ab Wheel", "Woodchopper Kabel", "Mountain Climbers", "Burpees", "Kettlebell Swings", "Farmers Walk", "Thrusters", "Wall Balls", "Battle Ropes", "Box Jumps", "Schlitten schieben", "Schlitten ziehen", "Laufband Sprint", "Crosstrainer", "Ruderger√§t", "Ergometer Fahrrad", "Stairmaster", "Stepper", "Jump Squats", "Goblet Squats", "Zercher Squats", "Pistols Squats", "Hack Squats frei", "Beinpresse einbeinig", "Beinbeuger einbeinig", "Beinstrecker einbeinig", "Hip Abduction Maschine", "Hip Adduction Maschine", "Cable Pull Through", "Glute Ham Raise", "Nordic Curls", "Reverse Lunges", "Curtsy Lunges", "Donkey Kicks", "Frog Pumps", "Frontheben Kurzhantel", "Frontheben Langhantel", "Frontheben Kabel", "Cuban Press", "Reverse Butterfly Maschine", "Face Pull mit Seil", "Schulterdr√ºcken Maschine", "Landmine Press", "Landmine Row", "Meadows Row", "Pendlay Row", "Inverted Rows", "Deadlift mit Trap Bar", "Snatch", "Clean", "Clean and Jerk", "Push Press", "Push Jerk", "Overhead Squat", "Power Snatch", "Power Clean", "Rack Pulls", "Deficit Deadlift", "Floor Press", "Svend Press", "Isometrische Plank", "Side Plank mit Rotation", "Hanging Knee Raises", "Toes to Bar", "Dragon Flags", "Cable Kickbacks Trizeps", "Trizepsdr√ºcken Untergriff", "Einarmiges Trizepsdr√ºcken", "Zottman Curls", "Spider Curls", "Incline Curls", "Reverse Flys Kabel", "High Pulls", "Seitheben einarmig", "Farmer Hold", "Suitcase Carry", "Turkish Get Up", "Kettlebell Snatch", "Kettlebell Clean", "Kettlebell Press", "Kettlebell Goblet Squat", "Kettlebell Lunges", "Kettlebell Deadlift", "Battle Rope Waves", "Battle Rope Slams", "Seilspringen", "Sprints am Schlitten", "Medizinball Slam", "Medizinball Rotationswurf", "Medizinball Chest Pass", "Reverse Hyper", "Back Extension Maschine", "Glute Bridge einbeinig", "Hip Thrust einbeinig", "Clamshells", "Band Pull Apart", "Resistance Band Rows", "Resistance Band Curls", "Resistance Band Trizepsdr√ºcken", "Resistance Band Squats", "Resistance Band Deadlift", "Resistance Band Lateral Walk", "Resistance Band Kickbacks", "Resistance Band Shoulder Press", "Resistance Band Chest Press", "TRX Rows", "TRX Pushups", "TRX Squats", "TRX Lunges", "TRX Plank", "TRX Pike", "TRX Hamstring Curl", "TRX Bizeps Curl", "TRX Trizeps Extension", "TRX Y-Fly", "Box Step Overs", "Depth Jumps", "Broad Jumps", "Sled Push", "Sled Pull", "Sled Row", "Sled Chest Press", "Farmers Walk einarmig", "Zercher Carry", "Overhead Carry", "Sandbag Squats", "Sandbag Lunges", "Sandbag Shoulder Press", "Sandbag Deadlift", "Sandbag Carry", "Kabelrudern einarmig", "Latzug einarmig", "Brustpresse einarmig", "Butterfly einarmig", "Seitheben vorgebeugt Kabel", "Reverse Crossover Kabel", "High Cable Curl", "Low Cable Curl", "Cable Upright Row", "Cable Front Raise", "Cable Lateral Raise", "Cable Rear Delt Fly", "Cable Chest Press", "Cable Deadlift", "Cable Squats", "Cable Lunges", "Cable Hip Abduction", "Cable Hip Adduction", "Cable Glute Kickback", "Cable Pull Down Trizeps", "Cable Overhead Trizeps", "Cable Rope Hammer Curl", "Cable Preacher Curl", "Incline Bench Press Maschine", "Decline Bench Press Maschine", "Pec Deck Reverse", "Chest Supported Row", "Machine Shoulder Press", "Machine Hack Squat", "Machine Leg Press einbeinig", "Machine Calf Raise", "Machine Glute Kickback", "Machine Ab Crunch", "Machine Back Extension", "Machine Lat Pulldown", "Machine Row", "Smith Machine Squat", "Smith Machine Bench Press", "Smith Machine Shoulder Press", "Smith Machine Lunges"];

    function showPrompt(text, defaultValue, callback, title="Eingabe") { 
        document.getElementById('prompt-title').innerText = title; 
        document.getElementById('prompt-text').innerText = text; 
        let input = document.getElementById('prompt-input');
        input.value = defaultValue || ''; 
        
        let autoList = document.getElementById('exercise-autocomplete-list');
        if(autoList) autoList.style.display = 'none';
        
        input.oninput = null; // Alte Events l√∂schen
        
        // Aktiviere das Dropdown NUR bei "Neue √úbung"
        if(title === "Neue √úbung") { 
            input.oninput = function() {
                let val = this.value.toLowerCase();
                autoList.innerHTML = '';
                if (!val) { autoList.style.display = 'none'; return; }
                
                // Suche die besten Matches und zeige max. 8 St√ºck an
                let matches = gymExercises.filter(ex => ex.toLowerCase().includes(val)).slice(0, 8);
                
                if(matches.length > 0) {
                    autoList.style.display = 'block';
                    matches.forEach(ex => {
                        let itemDiv = document.createElement("div");
                        itemDiv.className = "autocomplete-item";
                        itemDiv.innerText = ex;
                        
                        // Klick auf ein Element im Dropdown
                        itemDiv.onclick = function() {
                            input.value = ex;
                            autoList.style.display = 'none';
                        };
                        autoList.appendChild(itemDiv);
                    });
                } else {
                    autoList.style.display = 'none';
                }
            };
        }
        
        promptCallbackFn = callback; 
        document.getElementById('prompt-modal').style.display = 'flex'; 
        input.focus(); 
    }

    function closePrompt() { document.getElementById('prompt-modal').style.display = 'none'; }
    function promptConfirm() { const val = document.getElementById('prompt-input').value; closePrompt(); if(promptCallbackFn) promptCallbackFn(val); }

    const catalog = [ { id: 'vm_d3k2', brand: 'Vitamaze', name: 'Vitamin D3 + K2', unit: 'Trp', icon: '‚òÄÔ∏è', baseNutri: {'Vit. D3': '1000 IE', 'Vit. K2': '20 ¬µg'} }, { id: 'n_omega', brand: 'Norsan', name: 'Omega-3 Total', unit: 'ml', icon: 'üêü', baseNutri: {'EPA': '140 mg', 'DHA': '64 mg', 'Vit. D3': '100 IE', 'Vit. E': '0.2 mg'} }, { id: 'le_multi', brand: 'Life Extension', name: 'Two Per Day', unit: 'Tab', icon: 'üíä', baseNutri: {'Vit. A': '375 ¬µg', 'Vit. C': '235 mg', 'Zink': '12.5 mg', 'Selen': '100 ¬µg'} }, { id: 'le_neuro', brand: 'Life Extension', name: 'Neuro-Mag', unit: 'Caps', icon: 'üß†', baseNutri: {'Magnesium': '48 mg'} }, { id: 'ne_mag_bis', brand: 'Natural Elements', name: 'Magnesium', sub: 'Bisglycinat', unit: 'Caps', icon: 'üí§', baseNutri: {'Magnesium': '100 mg'} }, { id: 'esn_crea', brand: 'ESN', name: 'Creapure Creatine', unit: 'g', icon: 'üí™', baseNutri: {'Kreatin': '1 g'} }, { id: 'vm_ashwa', brand: 'Vitamaze', name: 'Ashwagandha', sub: 'KSM-66', unit: 'Caps', icon: 'üåø', baseNutri: {'Ashwa': '600 mg'} } ];
    
    function getFullCatalog() { 
        let base = JSON.parse(JSON.stringify(catalog));
        (db.customSupps || []).forEach(cs => {
            const idx = base.findIndex(b => b.id === cs.id);
            if(idx !== -1) base[idx] = cs; else base.push(cs);
        });
        // NEU: Gel√∂schte Standard-Items herausfiltern
        if(db.deletedSupps) {
            base = base.filter(s => !db.deletedSupps.includes(s.id));
        }
        return base; 
    }
    
    function tglAddForm() { const f = document.getElementById('add-supp-form'); f.style.display = (f.style.display === 'block') ? 'none' : 'block'; }
    function tglCollapse(id) { document.getElementById(id).classList.toggle('collapse-active'); }
    function updSl(type, val) { document.getElementById('val-'+type).innerText = val + '%'; document.getElementById('fill-'+type).style.width = val + '%'; }
    
    function saveFeedback() { 
        const viewDate = getViewDate(); 
        db.feedback[viewDate] = { 
            energy: document.getElementById('sl-energy').value, 
            focus: document.getElementById('sl-focus').value, 
            sleep: document.getElementById('sl-sleep').value 
        }; 
        save(); 
        updateRadarChart();
        vBuz([30, 50, 30]); // Haptisches Feedback
        document.getElementById('feedback-msg').innerText = "Gespeichert!"; 
        setTimeout(() => document.getElementById('feedback-msg').innerText = "", 2000); 
    }

    // --- LABORWERTE LOGIK ---
¬† ¬† function renderLabWidget() {
        const list = document.getElementById('labor-list');
        if(!list) return;
        
        const dEl = document.getElementById('l-date');
        if(dEl && !dEl.value) dEl.value = getTodayDate();

        list.innerHTML = '';
        db.labTrackers.forEach(lab => {
            list.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="display:flex; flex-direction:column; flex:1; min-width:0; margin-right:10px; text-align:left;">
                        <span style="font-size: 13px; color: var(--labor-glow); font-weight: 800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${lab.name.toUpperCase()}</span>
                        <span style="font-size: 10px; color: #64748b;">${lab.unit}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="number" step="any" id="lab-input-${lab.id}" placeholder="Wert" style="width: 75px; box-sizing: border-box; background:rgba(255,255,255,0.05); border:1px solid #334155; padding:8px 5px; border-radius:8px; color:white; text-align:center; font-size:14px; font-weight:bold; font-family:inherit; outline:none; margin:0;">
                        <button onclick="deleteLabTracker('${lab.id}', '${lab.name}')" style="background:rgba(239, 68, 68, 0.1); border:none; border-radius:8px; color:var(--danger); width:34px; height:34px; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin:0; padding:0;">‚úñ</button>
                    </div>
                </div>
            `;
        });
        
        renderLabHistory();
    }

¬† ¬† function promptAddLab() {
¬† ¬† ¬† ¬† showPrompt("Name des neuen Wertes (z.B. Eisen):", "", function(name) {
¬† ¬† ¬† ¬† ¬† ¬† if(name) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showPrompt(`Einheit f√ºr ${name} (z.B. ¬µg/dl):`, "", function(unit) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(unit) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const id = 'lab_' + Date.now();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.labTrackers.push({id, name, unit});
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† save(); renderLabWidget();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }, "Einheit eingeben");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }, 350); 
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }, "Neuer Laborwert");
¬† ¬† }

¬† ¬† function deleteLabTracker(id, name) {
¬† ¬† ¬† ¬† showConfirm(`M√∂chtest du den Wert "${name}" wirklich aus dem Dashboard entfernen? (Die Historie bleibt unber√ºhrt)`, function(res) {
¬† ¬† ¬† ¬† ¬† ¬† if(res) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.labTrackers = db.labTrackers.filter(l => l.id !== id);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† delete db.labData[id];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† save(); renderLabWidget();
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† }

¬† ¬† function saveLabValues() {
¬† ¬† ¬† ¬† const dateStr = document.getElementById('l-date').value || getTodayDate();
¬† ¬† ¬† ¬† const dateDisplay = new Date(dateStr).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† let hasData = false;
¬† ¬† ¬† ¬† let dayValues = {};

¬† ¬† ¬† ¬† db.labTrackers.forEach(lab => {
¬† ¬† ¬† ¬† ¬† ¬† const el = document.getElementById(`lab-input-${lab.id}`);
¬† ¬† ¬† ¬† ¬† ¬† if(el && el.value !== "") {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† dayValues[lab.id] = el.value;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.labData[lab.id] = el.value;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† hasData = true;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† el.value = ""; // Feld leeren
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† if(!hasData) { showAlert("Bitte trage mindestens einen Laborwert ein."); return; }

¬† ¬† ¬† ¬† if(!db.labHistory) db.labHistory = [];
¬† ¬† ¬† ¬† let existingEntry = db.labHistory.find(h => h.isoDate === dateStr);
¬† ¬† ¬† ¬† if(existingEntry) {
¬† ¬† ¬† ¬† ¬† ¬† existingEntry.values = { ...existingEntry.values, ...dayValues };
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† db.labHistory.push({ date: dateDisplay, isoDate: dateStr, values: dayValues });
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† db.labHistory.sort((a,b) => new Date(b.isoDate) - new Date(a.isoDate));
¬† ¬† ¬† ¬† save();
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† vBuz([30, 50, 30]);
¬† ¬† ¬† ¬† document.getElementById('labor-msg').innerText = "Laborwerte gesichert!";
¬† ¬† ¬† ¬† setTimeout(() => document.getElementById('labor-msg').innerText = "", 2000);
¬† ¬† ¬† ¬† renderLabHistory();
¬† ¬† }

¬† ¬† function renderLabHistory() {
        const cont = document.getElementById('lab-history-list');
        if (!cont) return;
        cont.innerHTML = '';
        if (!db.labHistory || db.labHistory.length === 0) {
            cont.innerHTML = '<div style="font-size:11px; opacity:0.5; text-align:center;">Keine Labor-Historie vorhanden.</div>';
            return;
        }

        const yearGroups = {};
        db.labHistory.forEach(h => {
            const yKey = h.isoDate.substring(0, 4);
            const mKey = h.isoDate.substring(5, 7);
            if (!yearGroups[yKey]) yearGroups[yKey] = {};
            if (!yearGroups[yKey][mKey]) yearGroups[yKey][mKey] = [];
            yearGroups[yKey][mKey].push(h);
        });

        Object.keys(yearGroups).sort().reverse().forEach(yKey => {
            let yearHtml = `
            <details style="margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; overflow:hidden;">
                <summary style="padding:15px; font-weight:900; color:white; font-size:14px; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05);">
                    <span>üìÖ JAHR ${yKey}</span><span style="font-size:10px; opacity:0.6;">Aufklappen ‚ñæ</span>
                </summary>
                <div style="padding:10px;">`;

            Object.keys(yearGroups[yKey]).sort().reverse().forEach(mKey => {
                const dateObj = new Date(`${yKey}-${mKey}-01`);
                const monthLabel = dateObj.toLocaleDateString('de-DE', { month: 'long' });
                
                yearHtml += `
                <details style="margin-bottom:10px; border:1px solid var(--labor-glow); border-radius:12px; overflow:hidden;">
                    <summary style="padding:12px; font-weight:900; color:var(--labor-glow); cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(168, 85, 247, 0.05);">
                        <span>ü©∏ ${monthLabel.toUpperCase()}</span><span style="font-size:10px; opacity:0.6;">${yearGroups[yKey][mKey].length} Berichte ‚ñæ</span>
                    </summary>
                    <div style="padding:10px;">`;
                
                yearGroups[yKey][mKey].forEach(entry => {
                    let detailsHtml = "";
                    for (let [labId, val] of Object.entries(entry.values)) {
                        const trk = db.labTrackers.find(t => t.id === labId);
                        detailsHtml += `<div style="font-size:11px; color:#cbd5e1; margin-bottom:4px;"><b>${trk ? trk.name : labId}</b>: ${val} ${trk ? trk.unit : ''}</div>`;
                    }
                    yearHtml += `
                    <details style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid var(--glass-border);">
                        <summary style="font-weight:bold; font-size:12px; color:white; cursor:pointer; list-style:none; display:flex; justify-content:space-between;">
                            <span>üóìÔ∏è ${entry.date}</span><span style="font-size:10px; opacity:0.5;">Werte ‚ñæ</span>
                        </summary>
                        <div style="margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.1);">${detailsHtml}</div>
                    </details>`;
                });
                yearHtml += `</div></details>`;
            });
            yearHtml += `</div></details>`;
            cont.innerHTML += yearHtml;
        });
    }

¬† ¬† function editLabHistoryValue(isoDate, labId, oldVal, name) {
¬† ¬† ¬† ¬† showPrompt(`Neuer Wert f√ºr ${name}:`, oldVal, function(newVal) {
¬† ¬† ¬† ¬† ¬† ¬† if(newVal && newVal.trim() !== "") {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const entry = db.labHistory.find(h => h.isoDate === isoDate);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(entry) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† entry.values[labId] = newVal.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† save(); renderLabHistory();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }, "Wert bearbeiten");
¬† ¬† }

¬† ¬† function deleteLabHistoryValue(isoDate, labId, name) {
¬† ¬† ¬† ¬† showConfirm(`Wert f√ºr "${name}" an diesem Tag wirklich l√∂schen?`, function(res) {
¬† ¬† ¬† ¬† ¬† ¬† if(res) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const entry = db.labHistory.find(h => h.isoDate === isoDate);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(entry) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† delete entry.values[labId];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(Object.keys(entry.values).length === 0) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.labHistory = db.labHistory.filter(h => h.isoDate !== isoDate);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† save(); renderLabHistory();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† }

¬† ¬† function deleteLabHistoryDay(isoDate) {
¬† ¬† ¬† ¬† showConfirm(`Alle Laborwerte vom ${new Date(isoDate).toLocaleDateString('de-DE')} l√∂schen?`, function(res) {
¬† ¬† ¬† ¬† ¬† ¬† if(res) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.labHistory = db.labHistory.filter(h => h.isoDate !== isoDate);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† save(); renderLabHistory();
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† }

    // --- DEEP ANALYTICS RADAR LOGIK ---
    function setRadarMode(mode) {
        radarMode = mode;
        if(mode === '7d') {
            document.getElementById('btn-radar-7d').style.background = 'var(--accent)';
            document.getElementById('btn-radar-all').style.background = 'rgba(255,255,255,0.1)';
        } else {
            document.getElementById('btn-radar-all').style.background = 'var(--accent)';
            document.getElementById('btn-radar-7d').style.background = 'rgba(255,255,255,0.1)';
        }
        updateRadarChart();
    }

    function updateRadarChart() {
        const ctxEl = document.getElementById('radarChart');
        if(!ctxEl) return;
        
        let eSum = 0, fSum = 0, sSum = 0, count = 0;
        const dates = Object.keys(db.feedback).sort().reverse();
        
        let filterDates = dates;
        if (radarMode === '7d') {
            const now = new Date().getTime();
            filterDates = dates.filter(d => {
                const diff = now - new Date(d).getTime();
                return diff <= 7 * 24 * 60 * 60 * 1000;
            });
        }
        
        filterDates.forEach(d => {
            const fb = db.feedback[d];
            if(fb) {
                eSum += parseInt(fb.energy) || 0;
                fSum += parseInt(fb.focus) || 0;
                sSum += parseInt(fb.sleep) || 0;
                count++;
            }
        });
        
        const avgE = count ? Math.round(eSum / count) : 0;
        const avgF = count ? Math.round(fSum / count) : 0;
        const avgS = count ? Math.round(sSum / count) : 0;

        if(radarChartInstance) radarChartInstance.destroy();
        
        radarChartInstance = new Chart(ctxEl.getContext('2d'), {
            type: 'radar',
            data: {
                labels: ['Energie', 'Fokus', 'Schlaf'],
                datasets: [{
                    label: radarMode === '7d' ? '√ò 7 Tage' : '√ò Gesamt',
                    data: [avgE, avgF, avgS],
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderColor: '#10b981',
                    pointBackgroundColor: '#FF8C00',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#FF8C00',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        pointLabels: { color: '#cbd5e1', font: { size: 12, weight: 'bold' } },
                        ticks: { display: false, min: 0, max: 100, stepSize: 20 }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#cbd5e1' } }
                }
            }
        });
    }

    // --- GYM LOGIK ---
    
    function setFlexDay(day) {
        currentFlexDay = day;
        document.querySelectorAll('.gym-day-tab').forEach(el => el.classList.remove('active'));
        const tab = document.getElementById('ftab-' + day);
        if(tab) tab.classList.add('active');
        renderGymToday();
    }

    function gymPlannerTargetChanged() {
        const sel = document.getElementById('gym-day-select').value;
        const dateInput = document.getElementById('gym-date-select');
        if(sel === 'DATE') {
            dateInput.style.display = 'block';
            if(!dateInput.value) dateInput.value = getTodayDate();
        } else {
            dateInput.style.display = 'none';
        }
        renderGymPlaner();
    }
    
    function getGymPlannerTarget() {
        const sel = document.getElementById('gym-day-select').value;
        if(sel === 'DATE') {
            return document.getElementById('gym-date-select').value || getTodayDate();
        }
        return sel;
    }

    function renderGymPlaner() {
        const target = getGymPlannerTarget();
        const list = document.getElementById('gym-planer-list');
        list.innerHTML = '';
        if(!db.gym.plans[target]) db.gym.plans[target] = [];
        db.gym.plans[target].forEach((ex, idx) => {
            let targetW = (ex.weight && ex.weight > 0) ? ` | ${ex.weight} kg` : '';
            list.innerHTML += `
                <div class="gsb-row" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 8px;">
                    <div>
                        <span style="color:white; font-weight:900; font-size:14px; display:block;">${ex.name}</span>
                        <span style="color:var(--day-glow); font-weight:700; font-size:12px;">${ex.sets} S√§tze x ${ex.reps} Reps${targetW}</span>
                    </div>
                    <button class="swipe-delete" style="padding: 8px 12px; border-radius:8px; border:none; color:white; font-size:12px; font-weight:bold; cursor:pointer;" onclick="removeGymExercise('${target}', ${idx})">‚úñ</button>
                </div>
            `;
        });
    }

    function addGymExercise() {
        // Felder zur√ºcksetzen auf Standardwerte
        document.getElementById('gym-mod-name').value = '';
        document.getElementById('gym-mod-sets').value = '3';
        document.getElementById('gym-mod-reps').value = '8-12';
        document.getElementById('gym-mod-weight').value = '';
        
        const autoList = document.getElementById('gym-mod-autocomplete-list');
        if(autoList) autoList.style.display = 'none';

        // Autocomplete-Logik f√ºr dieses neue Fenster aktivieren
        const input = document.getElementById('gym-mod-name');
        input.oninput = function() {
            let val = this.value.toLowerCase();
            autoList.innerHTML = '';
            if (!val) { autoList.style.display = 'none'; return; }
            
            // Suche die besten Matches
            let matches = gymExercises.filter(ex => ex.toLowerCase().includes(val)).slice(0, 8);
            
            if(matches.length > 0) {
                autoList.style.display = 'block';
                matches.forEach(ex => {
                    let itemDiv = document.createElement("div");
                    itemDiv.className = "autocomplete-item";
                    itemDiv.innerText = ex;
                    
                    itemDiv.onclick = function() {
                        input.value = ex;
                        autoList.style.display = 'none';
                    };
                    autoList.appendChild(itemDiv);
                });
            } else {
                autoList.style.display = 'none';
            }
        };

        // Fenster anzeigen
        document.getElementById('gym-add-modal').style.display = 'flex';
        setTimeout(() => input.focus(), 100);
    }

    function closeGymModal() {
        document.getElementById('gym-add-modal').style.display = 'none';
    }

    function saveGymModal() {
        const name = document.getElementById('gym-mod-name').value.trim();
        const sets = document.getElementById('gym-mod-sets').value;
        const reps = document.getElementById('gym-mod-reps').value.trim();
        const weight = document.getElementById('gym-mod-weight').value;

        if(!name || !sets || !reps) {
            showAlert("Bitte f√ºlle √úbungsname, S√§tze und Wiederholungen aus.");
            return;
        }

        const target = getGymPlannerTarget();
        if(!db.gym.plans[target]) db.gym.plans[target] = [];
        
        db.gym.plans[target].push({
            name: name, 
            sets: parseInt(sets) || 3, 
            reps: reps,
            weight: parseFloat(weight) || 0
        });
        
        save();
        renderGymPlaner();
        renderGymToday();
        if(typeof vBuz === 'function') vBuz([30, 50, 30]); // Kurze Vibration
        
        closeGymModal();
    }

    function removeGymExercise(target, idx) {
        db.gym.plans[target].splice(idx, 1);
        save();
        renderGymPlaner();
        renderGymToday();
    }
    
    function toggleGymEx(idx) {
        const content = document.getElementById(`gym-ex-content-${idx}`);
        const icon = document.getElementById(`gym-ex-icon-${idx}`);
        if(content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function renderGymToday() {
        const day = currentFlexDay;
        const dateStr = getTodayDate();
        const cont = document.getElementById('gym-today-content');
        
        // Pr√ºfen ob es f√ºr HEUTE ein spezielles Datum-Override gibt, ansonsten den normalen Wochentag nehmen
        const specificPlan = db.gym.plans[dateStr];
        const weeklyPlan = db.gym.plans[day];
        // Override gilt nur, wenn der FlexDay auch wirklich dem heutigen Tag entspricht
        const isOverride = (day === getGermanDay() && specificPlan && specificPlan.length > 0);
        const todayPlan = isOverride ? specificPlan : weeklyPlan;
        
        let headerText = isOverride ? `Plan f√ºr Heute (${dateStr})` : `Plan f√ºr: ${day.toUpperCase()}`;
        let html = `<div style="text-align:center; font-size:12px; color:#94a3b8; margin-bottom:15px; font-weight:bold;">${headerText.replace(day.toUpperCase(), `<span style="color:var(--morning-glow);">${day.toUpperCase()}</span>`)}</div>`;
        
        if(!todayPlan || todayPlan.length === 0) {
            cont.innerHTML = html + `<div style="text-align:center; opacity:0.6; font-size:13px; padding: 20px 0;">Kein Plan hinterlegt.<br>Nutze den Planer unten!</div>`;
            return;
        }

        todayPlan.forEach((ex, exIdx) => {
            let setsHtml = '';
            let allDone = true;

            for(let s=1; s<=ex.sets; s++) {
                const log = db.gym.logs.find(l => l.date === dateStr && l.ex === ex.name && l.set === s && (l.planDay === day || !l.planDay));
                const isDone = !!log;
                if(!isDone) allDone = false;

                const weightVal = log ? log.w : '';
                const repsVal = log ? log.r : '';
                
                setsHtml += `
                <div class="gym-set-row">
                    <span style="width:25px; color:#94a3b8; font-size:14px; font-weight:bold; text-align:center;">${s}</span>
                    <input type="number" step="0.5" id="g-w-${exIdx}-${s}" class="gym-set-input" placeholder="kg" value="${weightVal}" ${isDone ? 'disabled' : ''}>
                    <input type="number" id="g-r-${exIdx}-${s}" class="gym-set-input" placeholder="Wdh" value="${repsVal}" ${isDone ? 'disabled' : ''}>
                    <button class="gym-set-btn ${isDone?'done':'open'}" onclick="toggleGymSet('${ex.name}', ${s}, ${exIdx}, this)">${isDone?'‚úì':'OK'}</button>
                </div>`;
            }

            let targetW = (ex.weight && ex.weight > 0) ? ` | ${ex.weight} kg` : '';
            
            // Wenn alles fertig ist, klappen wir es direkt zu
            let displayState = allDone ? 'none' : 'block';
            let rotateState = allDone ? '0deg' : '180deg';

            html += `
            <div class="gym-ex-card" id="gym-today-ex-${exIdx}">
                <div onclick="toggleGymEx(${exIdx})" style="margin-bottom:0; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; flex-direction:column; gap:3px;">
                        <span onclick="event.stopPropagation(); renameGymPlanEx('${day}', ${exIdx}, '${ex.name.replace(/'/g, "\\'")}', '${dateStr}')" style="color:white; font-size:15px; font-weight:800; display:inline-flex; align-items:center; gap:6px;">${ex.name} <span style="font-size:10px; opacity:0.6;">‚úèÔ∏è</span></span> 
                        <span style="color:var(--morning-glow); font-size:11px; font-weight:700;">Ziel: ${ex.reps}${targetW}</span>
                    </div>
                    <span id="gym-ex-icon-${exIdx}" style="color:var(--accent); transition:0.3s; transform:rotate(${rotateState}); font-size:20px;">‚ñæ</span>
                </div>
                <div id="gym-ex-content-${exIdx}" style="display:${displayState}; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                    ${setsHtml}
                </div>
            </div>`;
        });
        cont.innerHTML = html;
    }

    function toggleGymSet(exName, setNum, exIdx, btn) {
        const dateStr = getTodayDate();
        const day = currentFlexDay;
        let logIdx = db.gym.logs.findIndex(l => l.date === dateStr && l.ex === exName && l.set === setNum && (l.planDay === day || !l.planDay));
        
        const wInput = document.getElementById(`g-w-${exIdx}-${setNum}`);
        const rInput = document.getElementById(`g-r-${exIdx}-${setNum}`);

        if(logIdx !== -1) {
            // UNCHECK: Log entfernen & Felder zum Editieren entsperren
            db.gym.logs.splice(logIdx, 1);
            save();
            
            btn.classList.remove('done');
            btn.classList.add('open');
            btn.innerText = 'OK';
            wInput.disabled = false;
            rInput.disabled = false;
            
            vBuz(30); 
        } else {
            // CHECK: Felder speichern & sperren
            const w = wInput.value;
            const r = rInput.value;
            if(!w || !r) { showAlert("Bitte Gewicht und Wiederholungen eintragen!"); return; }
            
            db.gym.logs.push({ date: dateStr, planDay: day, ex: exName, set: setNum, w: parseFloat(w), r: parseInt(r) });
            save();
            
            btn.classList.remove('open');
            btn.classList.add('done');
            btn.innerText = '‚úì';
            wInput.disabled = true;
            rInput.disabled = true;
            
            vBuz([50, 100, 50]);
            
            // Auto-Collapse pr√ºfen: Sind alle S√§tze dieser √úbung jetzt fertig?
            const specificPlan = db.gym.plans[dateStr];
            const isOverride = (day === getGermanDay() && specificPlan && specificPlan.length > 0);
            const todayPlan = isOverride ? specificPlan : db.gym.plans[day];
            
            const exObj = todayPlan[exIdx];
            if(exObj) {
                const logsForEx = db.gym.logs.filter(l => l.date === dateStr && l.ex === exName && (l.planDay === day || !l.planDay));
                if(logsForEx.length >= exObj.sets) {
                    setTimeout(() => {
                        const cont = document.getElementById(`gym-ex-content-${exIdx}`);
                        const icon = document.getElementById(`gym-ex-icon-${exIdx}`);
                        if(cont) cont.style.display = 'none';
                        if(icon) icon.style.transform = 'rotate(0deg)';
                    }, 500); // Eine halbe Sekunde warten f√ºr ein smoothes Erlebnis
                }
            }
        }
        
        updateGymChartSelect(); 
        updateGymChart();
        renderGymHistory();
    }

    function updateGymChartSelect() {
        const sel = document.getElementById('gym-chart-select');
        const exNames = [...new Set(db.gym.logs.map(l => l.ex))];
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">-- √úbung w√§hlen --</option>';
        exNames.forEach(name => {
            sel.innerHTML += `<option value="${name}">${name}</option>`;
        });
        if(exNames.includes(currentVal)) sel.value = currentVal;
    }

    function updateGymChart() {
        const sel = document.getElementById('gym-chart-select').value;
        const ctxEl = document.getElementById('gymChart');
        const statsRow = document.getElementById('gym-stats-row');
        
        if(gymChartInstance) gymChartInstance.destroy();
        
        if(!sel) {
            if(statsRow) statsRow.style.display = 'none';
            return;
        }
        
        // Daten f√ºr die Analyse sammeln
        const exLogs = db.gym.logs.filter(l => l.ex === sel);
        const dailyMax = {};
        
        let max1RM = 0;
        const volumeByDate = {};
        
        exLogs.forEach(l => {
            // 1. Maximalgewicht f√ºr den Chart pro Tag
            if(!dailyMax[l.date] || l.w > dailyMax[l.date]) {
                dailyMax[l.date] = l.w;
            }
            
            // 2. 1RM (Epley-Formel) berechnen und das All-Time-Max speichern
            const current1RM = l.w * (1 + l.r / 30);
            if(current1RM > max1RM) max1RM = current1RM;
            
            // 3. Volumen (Gewicht * Wiederholungen) f√ºr jeden Tag aufsummieren
            if(!volumeByDate[l.date]) volumeByDate[l.date] = 0;
            volumeByDate[l.date] += (l.w * l.r);
        });
        
        const dates = Object.keys(dailyMax).sort();
        const data = dates.map(d => dailyMax[d]);
        
        // UI Updates f√ºr die neuen Stats
        if(statsRow && dates.length > 0) {
            statsRow.style.display = 'grid';
            const lastDate = dates[dates.length - 1]; // Das letzte Trainingsdatum
            const lastVolume = volumeByDate[lastDate];
            
            document.getElementById('gym-stat-1rm').innerText = Math.round(max1RM) + ' kg';
            document.getElementById('gym-stat-vol').innerText = Math.round(lastVolume) + ' kg';
        } else if(statsRow) {
            statsRow.style.display = 'none';
        }
        
        const labels = dates.map(d => {
            const parts = d.split('-');
            return `${parts[2]}.${parts[1]}`;
        });

        gymChartInstance = new Chart(ctxEl.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Max Gewicht (kg)',
                    data: data,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.15)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 6,
                    pointBackgroundColor: '#10b981'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: false, ticks: {color: '#cbd5e1'} }, 
                    x: { ticks: {color: '#cbd5e1'} } 
                }
            }
        });
    }

    function renderGymHistory() {
        const cont = document.getElementById('gym-history-list');
        if (!cont) return;
        cont.innerHTML = '';

        if (!db.gym.logs || db.gym.logs.length === 0) {
            cont.innerHTML = '<div style="font-size:11px; opacity:0.5; text-align:center;">Noch keine Trainingsdaten gespeichert.</div>';
            return;
        }

        // 1. Logs nach Datum gruppieren
        const logsByDate = {};
        db.gym.logs.forEach(log => {
            if (!logsByDate[log.date]) logsByDate[log.date] = {};
            if (!logsByDate[log.date][log.ex]) logsByDate[log.date][log.ex] = [];
            logsByDate[log.date][log.ex].push(log);
        });

        // 2. Daten nach Jahr und Monat gruppieren
        const yearGroups = {};
        Object.keys(logsByDate).forEach(d => {
            const yKey = d.substring(0, 4); // Jahr (z.B. "2026")
            const mKey = d.substring(5, 7); // Monat (z.B. "02")
            if (!yearGroups[yKey]) yearGroups[yKey] = {};
            if (!yearGroups[yKey][mKey]) yearGroups[yKey][mKey] = [];
            yearGroups[yKey][mKey].push(d);
        });

        // 3. Jahre absteigend anzeigen
        Object.keys(yearGroups).sort().reverse().forEach(yKey => {
            let yearHtml = `
            <details style="margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; overflow:hidden;">
                <summary style="padding:15px; font-weight:900; color:white; font-size:14px; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05);">
                    <span>üìÖ JAHR ${yKey}</span>
                    <span style="font-size:10px; opacity:0.6;">Aufklappen ‚ñæ</span>
                </summary>
                <div style="padding:10px;">`;

            // 4. Monate absteigend anzeigen
            Object.keys(yearGroups[yKey]).sort().reverse().forEach(mKey => {
                const dateObj = new Date(`${yKey}-${mKey}-01`);
                const monthLabel = dateObj.toLocaleDateString('de-DE', { month: 'long' });
                
                yearHtml += `
                <details style="margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; overflow:hidden;">
                    <summary style="padding:12px; font-weight:900; color:var(--day-glow); cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(79, 172, 254, 0.05);">
                        <span>üèãÔ∏è ${monthLabel.toUpperCase()}</span>
                        <span style="font-size:10px; opacity:0.6;">${yearGroups[yKey][mKey].length} Trainings ‚ñæ</span>
                    </summary>
                    <div style="padding:10px;">`;

                // 5. Tage anzeigen
                yearGroups[yKey][mKey].sort().reverse().forEach(date => {
                    const displayDate = new Date(date).toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
                    yearHtml += `
                    <details style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid var(--glass-border);">
                        <summary style="font-weight:bold; font-size:12px; color:white; cursor:pointer; list-style:none; display:flex; justify-content:space-between;">
                            <span>üóìÔ∏è ${displayDate}</span>
                            <span style="font-size:10px; opacity:0.5;">Details ‚ñæ</span>
                        </summary>
                        <div style="margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.1);">`;

                    const exercises = logsByDate[date];
                    for (const [exName, sets] of Object.entries(exercises)) {
                        yearHtml += `<div style="margin-bottom:8px;"><b style="color:var(--accent); font-size:11px;">${exName}</b><br>`;
                        sets.forEach(s => {
                            yearHtml += `<span style="font-size:10px; color:#cbd5e1;">Satz ${s.set}: ${s.w}kg x ${s.r}</span><br>`;
                        });
                        yearHtml += `</div>`;
                    }
                    yearHtml += `</div></details>`;
                });
                yearHtml += `</div></details>`;
            });
            yearHtml += `</div></details>`;
            cont.innerHTML += yearHtml;
        });
    }

    function editGymExName(date, oldName) {
        showPrompt("Neuer Name f√ºr die √úbung:", oldName, function(newName) {
            if(newName && newName.trim() !== "" && newName !== oldName) {
                db.gym.logs.forEach(l => {
                    if(l.date === date && l.ex === oldName) { l.ex = newName.trim(); }
                });
                save(); renderGymHistory(); updateGymChartSelect(); updateGymChart();
                if(date === getTodayDate()) renderGymToday();
            }
        }, "√úbung umbenennen");
    }

    function editGymSet(date, exName, setNum, oldW, oldR) {
        showPrompt(`Neues Gewicht f√ºr Satz ${setNum} (kg):`, oldW, function(newW) {
            if(newW) {
                setTimeout(() => { // Kurze Pause, um das zweite Modal sanft zu √∂ffnen
                    showPrompt(`Neue Wiederholungen f√ºr Satz ${setNum}:`, oldR, function(newR) {
                        if(newR) {
                            const log = db.gym.logs.find(l => l.date === date && l.ex === exName && l.set === setNum);
                            if(log) {
                                log.w = parseFloat(newW); log.r = parseInt(newR);
                                save(); renderGymHistory(); updateGymChart();
                                if(date === getTodayDate()) renderGymToday();
                            }
                        }
                    }, "Wiederholungen");
                }, 350);
            }
        }, "Gewicht");
    }

    function deleteGymSet(date, exName, setNum) {
        showConfirm(`Satz ${setNum} wirklich l√∂schen?`, function(res) {
            if(res) {
                db.gym.logs = db.gym.logs.filter(l => !(l.date === date && l.ex === exName && l.set === setNum));
                save(); renderGymHistory(); updateGymChart();
                if(date === getTodayDate()) renderGymToday();
            }
        });
    }

    function deleteGymHistoryEx(date, exName) {
        showConfirm(`M√∂chtest du "${exName}" (alle S√§tze) vom ${new Date(date).toLocaleDateString('de-DE')} wirklich l√∂schen?`, function(res) {
            if(res) {
                db.gym.logs = db.gym.logs.filter(l => !(l.date === date && l.ex === exName));
                save(); renderGymHistory(); updateGymChartSelect(); updateGymChart();
                if(date === getTodayDate()) renderGymToday();
            }
        });
    }
function renameGymPlanEx(day, exIdx, oldName, dateStr) {
        showPrompt("√úbung im Plan umbenennen:", oldName, function(newName) {
            if(newName && newName.trim() !== "" && newName !== oldName) {
                const finalName = newName.trim();
                // 1. Namen im Trainingsplan aktualisieren
                if(db.gym.plans[day] && db.gym.plans[day][exIdx]) {
                    db.gym.plans[day][exIdx].name = finalName;
                }
                // 2. Alle heutigen Logs aktualisieren, damit die H√§kchen (‚úì) nicht verschwinden
                db.gym.logs.forEach(l => {
                    if(l.date === dateStr && l.ex === oldName && l.planDay === day) { 
                        l.ex = finalName; 
                    }
                });
                save();
                renderGymPlaner();
                renderGymToday();
                renderGymHistory();
                updateGymChartSelect();
            }
        }, "√úbung bearbeiten");
    }
    function loadMasse() {
    document.getElementById('m-date').value = getTodayDate();
    let data = null;
    if(db.measurementsHistory && db.measurementsHistory.length > 0) {
        data = db.measurementsHistory[0];
    } else if(db.measurements) { 
        data = db.measurements; 
    }
    
    if(data) {
        document.getElementById('m-schultern').value = data.schultern || '';
        document.getElementById('m-brust').value = data.brust || '';
        document.getElementById('m-bauch').value = data.bauch || '';
        document.getElementById('m-bizeps-l').value = data.bizepsL || '';
        document.getElementById('m-bizeps-r').value = data.bizepsR || '';
        document.getElementById('m-beine-l').value = data.beineL || '';
        document.getElementById('m-beine-r').value = data.beineR || '';
        document.getElementById('m-waden-l').value = data.wadenL || '';
        document.getElementById('m-waden-r').value = data.wadenR || '';
    }
    renderMasseHistory();
}

    function saveMasse() {
    const dateStr = document.getElementById('m-date').value || getTodayDate(); 
    const dateDisplay = new Date(dateStr).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
    
    const newEntry = {
        date: dateDisplay,
        isoDate: dateStr,
        schultern: document.getElementById('m-schultern').value,
        brust: document.getElementById('m-brust').value,
        bauch: document.getElementById('m-bauch').value,
        bizepsL: document.getElementById('m-bizeps-l').value,
        bizepsR: document.getElementById('m-bizeps-r').value,
        beineL: document.getElementById('m-beine-l').value,
        beineR: document.getElementById('m-beine-r').value,
        wadenL: document.getElementById('m-waden-l').value,
        wadenR: document.getElementById('m-waden-r').value
    };

    db.measurementsHistory = db.measurementsHistory.filter(m => m.isoDate !== dateStr);
    db.measurementsHistory.push(newEntry);
    db.measurementsHistory.sort((a,b) => new Date(b.isoDate) - new Date(a.isoDate));
    db.measurements = newEntry; 

    save();
    vBuz([30, 50, 30]); 
    document.getElementById('masse-msg').innerText = "Ma√üe erfolgreich gespeichert!";
    setTimeout(() => document.getElementById('masse-msg').innerText = "", 2000);
    renderMasseHistory();
}
    
    function getTrendHtml(name, curStr, prevStr, invert=false) {
        const cur = parseFloat(curStr);
        const prev = parseFloat(prevStr);
        if(!cur || !prev || cur === prev) return `<span style="color:#cbd5e1">¬±0 cm</span>`;
        const diff = cur - prev;
        const sign = diff > 0 ? '+' : '';
        // Bei Bauch ist negativ gr√ºn, bei Muskeln positiv gr√ºn
        const isGood = invert ? diff < 0 : diff > 0;
        const color = isGood ? 'var(--success)' : 'var(--danger)';
        return `<span style="color:${color}">${sign}${diff.toFixed(1)} cm</span>`;
    }

    function renderMasseHistory() {
    const cont = document.getElementById('masse-history-list');
    if (!cont) return;
    cont.innerHTML = '';
    if (!db.measurementsHistory || db.measurementsHistory.length === 0) {
        cont.innerHTML = '<div style="font-size:11px; opacity:0.5; text-align:center;">Keine Historie vorhanden.</div>';
        return;
    }

    const yearGroups = {};
    db.measurementsHistory.forEach(m => {
        const yKey = m.isoDate.substring(0, 4);
        const mKey = m.isoDate.substring(5, 7);
        if (!yearGroups[yKey]) yearGroups[yKey] = {};
        if (!yearGroups[yKey][mKey]) yearGroups[yKey][mKey] = [];
        yearGroups[yKey][mKey].push(m);
    });

    Object.keys(yearGroups).sort().reverse().forEach(yKey => {
        let yearHtml = `
        <details style="margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; overflow:hidden;">
            <summary style="padding:15px; font-weight:900; color:white; font-size:14px; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05);">
                <span>üìÖ JAHR ${yKey}</span><span style="font-size:10px; opacity:0.6;">Aufklappen ‚ñæ</span>
            </summary>
            <div style="padding:10px;">`;

        Object.keys(yearGroups[yKey]).sort().reverse().forEach(mKey => {
            const dateObj = new Date(`${yKey}-${mKey}-01`);
            const monthLabel = dateObj.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            
            yearHtml += `
            <details style="margin-bottom:10px; border:1px solid rgba(255, 140, 0, 0.2); border-radius:12px; overflow:hidden;">
                <summary style="padding:12px; font-weight:900; color:var(--accent); cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255, 140, 0, 0.05);">
                    <span>üìè ${monthLabel.toUpperCase()}</span><span style="font-size:10px; opacity:0.6;">${yearGroups[yKey][mKey].length} Messungen ‚ñæ</span>
                </summary>
                <div style="padding:10px;">`;
            
            yearGroups[yKey][mKey].forEach(m => {
                yearHtml += `
                <details style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid var(--glass-border);">
                    <summary style="font-weight:bold; font-size:12px; color:white; cursor:pointer; list-style:none; display:flex; justify-content:space-between;">
                        <span>üóìÔ∏è ${m.date}</span><span style="font-size:10px; opacity:0.5;">Werte ‚ñæ</span>
                    </summary>
                    <div style="font-size:11px; margin-top:8px; color:#cbd5e1; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <span>Bauch: ${m.bauch}cm</span>
                        <span>Brust: ${m.brust}cm</span>
                        <span>Bizeps L: ${m.bizepsL}cm</span>
                        <span>Bizeps R: ${m.bizepsR}cm</span>
                        <span>Bein L: ${m.beineL}cm</span>
                        <span>Bein R: ${m.beineR}cm</span>
                        <span>Wade L: ${m.wadenL}cm</span>
                        <span>Wade R: ${m.wadenR}cm</span>
                    </div>
                </details>`;
            });
            yearHtml += `</div></details>`;
        });
        yearHtml += `</div></details>`;
        cont.innerHTML += yearHtml;
    });
}

    function getStock(id) { if (!db.stock || !db.stock[id]) return null; if (typeof db.stock[id] === 'number') { db.stock[id] = { current: db.stock[id], initial: db.stock[id] }; save(); } return db.stock[id]; }
    function updStock(id, delta) { if(!db.stock || !db.stock[id]) return; db.stock[id].current += delta; save(); }
    function refillStock(id) {
    const stockData = getStock(id);
    const current = stockData ? stockData.current : 0;
    const stdAmount = (db.restockAmounts && db.restockAmounts[id]) ? db.restockAmounts[id] : null;

    // Falls eine Standardmenge hinterlegt ist, fragen wir nach dem Quick-Refill
    if (stdAmount) {
        showConfirm(`Schnell-Auff√ºllung f√ºr dieses Supplement?\nStandard-Menge: ${stdAmount} Einheiten.`, function(res) {
            if (res) {
                db.stock[id] = { current: stdAmount, initial: stdAmount };
                save(); renderPlan();
                if(typeof vBuz === 'function') vBuz([50, 30, 50]);
                showAlert("Bestand erfolgreich aufgef√ºllt!");
            } else {
                // Falls der User "Abbrechen" dr√ºckt, √∂ffnen wir das manuelle Fenster
                manualRefill(id, current);
            }
        }, "Bestand auff√ºllen", "QUICK REFILL");
    } else {
        // Falls keine Standardmenge da ist, direkt manuell
        manualRefill(id, current);
    }
}

// NEU: Hilfsfunktion f√ºr die manuelle Eingabe (damit der Code sauber bleibt)
function manualRefill(id, current) {
    showPrompt(`Aktueller Bestand: ${current}.\nNeuen Gesamtinhalt eingeben:`, "60", function(val) {
        if(val && !isNaN(parseInt(val))) {
            db.stock = db.stock || {};
            const newTotal = parseInt(val);
            db.stock[id] = { current: newTotal, initial: newTotal };
            save(); renderPlan();
        }
    }, "Bestand anpassen");
}
    function clickGear(id) { editSupp(id); }
    
    function editSupp(id) { 
        const s = getFullCatalog().find(x => x.id === id); if(!s) return; editingId = id; 
        document.getElementById('new-icon').value = s.icon; 
        document.getElementById('new-brand').value = s.brand; 
        document.getElementById('new-name').value = s.name.replace('<br><small>','').replace('</small>',''); 
        document.getElementById('new-unit').value = s.unit; 
        const stockData = getStock(id); document.getElementById('new-stock').value = stockData ? stockData.initial : ''; 
        document.getElementById('new-price').value = (db.prices && db.prices[id]) ? db.prices[id] : '';
    
    // NEU: Std-Kaufmenge in das Feld laden
    document.getElementById('new-restock-qty').value = (db.restockAmounts && db.restockAmounts[id]) ? db.restockAmounts[id] : '';
    
    let nutriText = ""; if(s.baseNutri) { for(let [k,v] of Object.entries(s.baseNutri)) nutriText += `${k}: ${v}\n`; } 
        document.getElementById('new-nutri').value = nutriText; 
        document.getElementById('btn-save-supp').innerText = "√ÑNDERUNG SPEICHERN"; 
        document.getElementById('add-supp-form').style.display = 'block'; 
        window.scrollTo(0, document.getElementById('add-supp-form').offsetTop); 
    }
    
    function saveNewSupp() { 
        const icon = document.getElementById('new-icon').value || 'üíä'; 
        const brand = document.getElementById('new-brand').value; 
        const name = document.getElementById('new-name').value; 
        const unit = document.getElementById('new-unit').value || 'Stk'; 
        const stockInit = parseInt(document.getElementById('new-stock').value); 
        const price = parseFloat(document.getElementById('new-price').value); 
        const nutriLines = document.getElementById('new-nutri').value.split('\n'); 
        if(!brand || !name) { showAlert("Marke und Name fehlen!", "Fehler"); return; } 
        let nutriObj = {}; nutriLines.forEach(line => { if(line.includes(':')) { const parts = line.split(':'); nutriObj[parts[0].trim()] = parts[1].trim(); } }); 
        const targetId = editingId || 'custom_' + Date.now();
    
    // NEU: Std-Kaufmenge sichern
    if(!db.restockAmounts) db.restockAmounts = {};
    const restockQty = parseInt(document.getElementById('new-restock-qty').value);
    if(!isNaN(restockQty)) db.restockAmounts[targetId] = restockQty;

    if(!isNaN(stockInit)) { if(!db.stock) db.stock = {}; db.stock[targetId] = { current: stockInit, initial: stockInit }; } 
        if(!isNaN(price)) { if(!db.prices) db.prices = {}; db.prices[targetId] = price; } 
        
        if(editingId) { 
            if(!db.customSupps) db.customSupps = [];
            const idx = db.customSupps.findIndex(x => x.id === targetId); 
            if (idx !== -1) { db.customSupps[idx] = { id: targetId, brand, name, unit, icon, baseNutri: nutriObj }; } 
            else { db.customSupps.push({ id: targetId, brand, name, unit, icon, baseNutri: nutriObj }); }
            editingId = null; 
        } else { 
            const newEntry = { id: targetId, brand, name, unit, icon, baseNutri: nutriObj }; 
            if(!db.customSupps) db.customSupps = []; db.customSupps.push(newEntry); 
        } 
        save(); renderMarket(); tglAddForm(); 
        ['new-icon','new-brand','new-name','new-unit','new-stock','new-price','new-nutri'].forEach(id => document.getElementById(id).value = ''); 
        document.getElementById('btn-save-supp').innerText = "IM KATALOG SPEICHERN"; 
    }
    
    function closeModal() { document.getElementById('time-modal').style.display = 'none'; }
    function pressNum(v) { if(v==='C') currentInput=""; else if(v==='OK') { document.getElementById('numpad-grid').style.display='none'; document.getElementById('time-select').style.display='block'; return; } else if(currentInput.length<3) currentInput+=v; document.getElementById('num-display').innerText=currentInput||"0"; }
    function opnMod(id) { pId=id; currentInput=""; document.getElementById('num-display').innerText="0"; document.getElementById('numpad-grid').style.display='grid'; document.getElementById('time-select').style.display='none'; document.getElementById('time-modal').style.display='flex'; }
    function confirmAdd(time) { db.activeSupps.push({id:pId, time, amount: parseInt(currentInput)||1}); save(); closeModal(); renderPlan(); }
    
    let dragSrcEl = null;
    function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
    function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
            const container = this.closest('.cycle-box'); 
            const items = Array.from(container.querySelectorAll('.supp-swipe-wrapper'));
            const fromIdx = items.indexOf(dragSrcEl.parentNode);
            const toIdx = items.indexOf(this.parentNode);
            const time = container.querySelector('.cycle-label').innerText.toLowerCase();
            let timeGroup = db.activeSupps.filter(as => as.time === time);
            let others = db.activeSupps.filter(as => as.time !== time);
            const movedItem = timeGroup.splice(fromIdx, 1)[0];
            timeGroup.splice(toIdx, 0, movedItem);
            db.activeSupps = [...others, ...timeGroup];
            save(); renderPlan();
        }
        return false;
    }
    function handleDragEnd() { this.classList.remove('dragging'); }

    function renderPlan() {
        checkAutoReactivation();
        const cont = document.getElementById('plan-content'); cont.innerHTML = '';
        const viewDate = getViewDate(); 
        const dObj = new Date(viewDate);
        const dayName = dObj.toLocaleDateString('de-DE', {weekday: 'short'});
        const dayDate = dObj.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'});
        document.getElementById('date-display').innerHTML = `${dayName}, ${dayDate}<br><span style="font-size:10px; opacity:0.6; font-weight:400;">${dayOffset === 0 ? 'HEUTE' : (dayOffset === -1 ? 'GESTERN' : '')}</span>`;

        if(!db.history[viewDate]) db.history[viewDate] = [];
        const start = new Date(db.startDate).getTime(); const current = new Date(viewDate).getTime(); const diff = current - start; const dayCount = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1; 
        document.getElementById('f-counter').innerText = dayCount > 0 ? `üî• Tag ${dayCount}` : `‚è≥ Bald`;
        let totalNutri = {}; let totalDailyCost = 0; const fullCat = getFullCatalog();
        
        ['morning', 'day', 'evening'].forEach(t => {
            const items = db.activeSupps.filter(as => as.time === t);
            if(items.length > 0) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'cycle-box';
                groupDiv.innerHTML = `<div class="cycle-label label-${t}">${t.toUpperCase()}</div>`;
                items.forEach(item => {
                    const s = fullCat.find(x => x.id === item.id); if(!s) return;
                    const done = db.history[viewDate].includes(item.id);
                    const isPaused = item.paused || false;
                    let timerBadgeHtml = "";
                    if(isPaused && item.pauseUntil) {
                        const diff = Math.ceil((item.pauseUntil - new Date().getTime()) / (1000*60*60*24));
                        timerBadgeHtml = `<div class="timer-badge">OFF: ${diff > 0 ? diff : 0}d</div>`;
                    }
                    const stockData = getStock(item.id); let stockBadge = ""; let bgStyle = "";
                    if(stockData !== null) { 
                        const current = stockData.current; const initial = stockData.initial > 0 ? stockData.initial : 1; const pctRemaining = (current / initial) * 100; 
                        let color = "var(--success)"; let textClass = "stock-text-ok"; if (pctRemaining <= 25) { color = "var(--danger)"; textClass = "stock-text-low"; } else if (pctRemaining <= 45) { color = "var(--warning)"; textClass = "stock-text-warn"; } 
                        bgStyle = `width:${pctRemaining}%; background:${color};`; stockBadge = `<div class="stock-badge ${textClass}" onclick="refillStock('${item.id}')">Noch ${current} ${s.unit}</div>`; 
                    }
                    if(!isPaused && db.prices && db.prices[item.id] && stockData && stockData.initial > 0) { const pricePerUnit = db.prices[item.id] / stockData.initial; totalDailyCost += (pricePerUnit * item.amount); }
                    let subHtml = s.sub ? `<span class="sub-name">${s.sub}</span>` : ''; let nutriRows = "";
                    if(s.baseNutri){ for(let [k,v] of Object.entries(s.baseNutri)){ const val = parseFloat(v) * item.amount; const unit = v.replace(/[0-9.]/g, '').trim(); nutriRows += `<div class="gsb-row" style="border:none;padding:2px 0;opacity:0.7"><span class="gsb-label">${k}</span><span class="gsb-value">${val.toFixed(1)} ${unit}</span></div>`; const key = `${k} (${unit})`; if(!isPaused) { totalNutri[key] = (totalNutri[key] || 0) + val; } } }
                    const card = document.createElement('div');
                    card.className = `supp-card ${done?'checked':''} ${isPaused?'paused':''}`;
                    card.draggable = true;
                    card.setAttribute('ontouchstart', 'tsCard(event)');
                    card.setAttribute('ontouchmove', 'tmCard(event)');
                    card.setAttribute('ontouchend', `teCard(event, '${item.id}', '${s.name}')`);
                    card.innerHTML = `${timerBadgeHtml}<div class="stock-bg-bar" style="${bgStyle}"></div><div class="icon-box" onclick="tglNutri('${item.id}')">${s.icon}</div><div class="supp-meta"><b>${s.brand}</b><span class="supp-name">${s.name}</span>${subHtml}<span class="supp-unit">${item.amount} ${s.unit}</span></div><div class="right-section">${stockBadge}<div class="check-btn" onclick="${isPaused?'':'chk(\''+item.id+'\', '+item.amount+')'}"></div></div><div id="nutri-${item.id}" class="nutri-dropdown" style="width:100%">${nutriRows}</div>`;
                    card.addEventListener('dragstart', handleDragStart); card.addEventListener('dragover', handleDragOver); card.addEventListener('drop', handleDragEnd); card.addEventListener('dragend', handleDragEnd);
                    const wrapper = document.createElement('div');
                    wrapper.className = 'supp-swipe-wrapper'; wrapper.id = `swipe-wrap-${item.id}`;
                    const pauseBtnHtml = isPaused ? `<div class="swipe-action-btn swipe-pause is-paused" onclick="tglCycle('${item.id}')"><div class="swipe-icon">‚ñ∂</div>PLAY</div>` : `<div class="swipe-action-btn swipe-pause" onclick="tglCycle('${item.id}')"><div class="swipe-icon">‚è∏</div>PAUSE</div>`;
                    const delBtnHtml = `<div class="swipe-action-btn swipe-delete" onclick="rem('${item.id}', '${s.name}')"><div class="swipe-icon">‚úñ</div>L√ñSCHEN</div>`;
                    wrapper.innerHTML = `<div class="supp-swipe-bg">${pauseBtnHtml}${delBtnHtml}</div>`;
                    wrapper.appendChild(card); groupDiv.appendChild(wrapper);
                });
                cont.appendChild(groupDiv);
            }
        });
        renderSum(totalNutri, totalDailyCost);
    }
    
    function tglNutri(id) { const e = document.getElementById('nutri-'+id); e.style.display = e.style.display==='block'?'none':'block'; }
    
    function chk(id, amount) { 
        const t = getViewDate(); 
        const isChecked = db.history[t].includes(id); 
        if(isChecked) { 
            db.history[t] = db.history[t].filter(x => x !== id); 
            updStock(id, amount); 
            vBuz(30); // Sanftes Feedback beim Uncheck
        } else { 
            db.history[t].push(id); 
            updStock(id, -amount); 
            vBuz(50); // Knackiges Feedback beim Check
        } 
        save(); renderPlan(); updateLevel(); 
    }
    
    function rem(id, name) { showConfirm(`${name.replace('<br><small>',' ')} aus dem Tagesplan entfernen?`, function(result) { if(result) { db.activeSupps = db.activeSupps.filter(as => as.id !== id); save(); renderPlan(); updateLevel(); } }); }
    function calculateInsights() { const days = Object.keys(db.history); if (days.length < 3) return ""; let correlations = { energy: {}, focus: {}, sleep: {} }; days.forEach(date => { const taken = db.history[date]; const fb = db.feedback && db.feedback[date]; if (fb && taken && taken.length > 0) { taken.forEach(id => { ['energy', 'focus', 'sleep'].forEach(key => { if (!correlations[key][id]) correlations[key][id] = []; correlations[key][id].push(parseInt(fb[key])); }); }); } }); let html = ""; const fullCat = getFullCatalog(); let foundAny = false; Object.keys(correlations).forEach(key => { for (let id in correlations[key]) { const arr = correlations[key][id]; if(arr.length < 2) continue; const avg = arr.reduce((a, b) => a + b, 0) / arr.length; if (avg > 70) { const s = fullCat.find(x => x.id === id); if (s) { html += `<span class="insight-tag">‚ö°Ô∏è ${s.name} ‚ûî ${key.toUpperCase()}: ${avg.toFixed(0)}%</span> `; foundAny = true; } } } }); if(foundAny) return `<div class="gsb-card" style="margin-top:10px;"><div style="font-size:12px;font-weight:800;color:#64748b;margin-bottom:10px;text-transform:uppercase;">Bio-Insights (Beta)</div>${html}</div>`; return ""; }
    function renderSum(nutriData, dailyCost) { const s = document.getElementById('sum-details'); const monthlyCost = dailyCost * 30.44; let html = `<div class="gsb-card"><div class="gsb-row"><span class="gsb-label">Tageskosten (Aktiv)</span><span class="price-tag">${dailyCost.toFixed(2)} ‚Ç¨</span></div><div class="gsb-row"><span class="gsb-label">Monatsprognose (√ò)</span><span class="gsb-value">${monthlyCost.toFixed(2)} ‚Ç¨</span></div></div>`; let timingHtml = ""; db.activeSupps.forEach(as => { if(!(as.paused || false)) { const k = kineticData[as.id]; if(k) { const supp = getFullCatalog().find(x => x.id === as.id); if(supp) { timingHtml += `<div class="gsb-row"><span class="gsb-label">${supp.name}</span><span class="gsb-value" style="font-size:12px">Peak: ${k.peak} / ${k.duration}</span></div>`; } } } }); if(timingHtml) { html += `<div class="gsb-card" style="margin-top:10px;"><div style="font-size:12px;font-weight:800;color:#64748b;margin-bottom:10px;text-transform:uppercase;">Wirkungs-Timing</div>${timingHtml}</div>`; } html += calculateInsights(); html += `<div class="gsb-card" style="margin-top:10px;">`; for(let [k,v] of Object.entries(nutriData)) { html += `<div class="gsb-row"><span class="gsb-label">${k}</span><span class="gsb-value">${v.toFixed(1)}</span></div>`; } html += `</div>`; s.innerHTML = html; }
    function tglSum() { const e=document.getElementById('sum-details'); e.style.display=e.style.display==='block'?'none':'block'; }
    function renderHistory() {
        const hList = document.getElementById('history-list');
        if (!hList) return;
        hList.innerHTML = '';
        const dates = Object.keys(db.history).sort().reverse();
        const fullCat = getFullCatalog();
        
        // Gruppierung nach Jahr und Monat
        const yearGroups = {};
        dates.forEach(d => {
            const yKey = d.substring(0, 4);
            const mKey = d.substring(5, 7);
            if (!yearGroups[yKey]) yearGroups[yKey] = {};
            if (!yearGroups[yKey][mKey]) yearGroups[yKey][mKey] = [];
            yearGroups[yKey][mKey].push(d);
        });

        Object.keys(yearGroups).sort().reverse().forEach(yKey => {
            let yearHtml = `
            <details style="margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; overflow:hidden;">
                <summary style="padding:15px; font-weight:900; color:white; font-size:14px; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05);">
                    <span>üìÖ JAHR ${yKey}</span><span style="font-size:10px; opacity:0.6;">Aufklappen ‚ñæ</span>
                </summary>
                <div style="padding:10px;">`;

            Object.keys(yearGroups[yKey]).sort().reverse().forEach(mKey => {
                const dateObj = new Date(`${yKey}-${mKey}-01`);
                const monthLabel = dateObj.toLocaleDateString('de-DE', { month: 'long' });
                
                yearHtml += `
                <details style="margin-bottom:10px; background:rgba(255,255,255,0.03); border:1px solid var(--glass-border); border-radius:16px; overflow:hidden;">
                    <summary style="padding:15px; font-weight:900; color:var(--accent); cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255,140,0,0.05);">
                        <span>üóìÔ∏è ${monthLabel.toUpperCase()}</span><span style="font-size:10px; opacity:0.6;">${yearGroups[yKey][mKey].length} Tage ‚ñæ</span>
                    </summary>
                    <div style="padding:10px;">`;

                yearGroups[yKey][mKey].forEach(d => {
                    const takenIds = db.history[d], totalSupps = db.activeSupps;
                    const countTaken = takenIds.filter(id => totalSupps.some(as => as.id === id)).length;
                    const fb = db.feedback && db.feedback[d] ? db.feedback[d] : null;
                    const fbHtml = fb ? `<div class="fb-tags">‚ö°Ô∏è${fb.energy}% &nbsp; üß†${fb.focus}% &nbsp; üí§${fb.sleep}%</div>` : '';
                    let listHtml = "";
                    
                    totalSupps.forEach(as => {
                        const s = fullCat.find(x => x.id === as.id), isTaken = takenIds.includes(as.id);
                        listHtml += `<div class="hist-list-item ${isTaken ? 'hist-status-ok' : 'hist-status-fail'}">${isTaken ? '‚úì' : '‚úï'} ${s ? s.name : 'Unbekannt'}</div>`;
                    });
                    
                    yearHtml += `
                    <div class="history-item" onclick="tglHist('${d}')" style="margin-bottom:8px; background:rgba(0,0,0,0.2);">
                        <div class="history-header">
                            <div><div class="history-date">${d.split('-').reverse().join('.')}</div>${fbHtml}</div>
                            <span class="history-stat">${countTaken}/${totalSupps.length}</span>
                        </div>
                        <div id="hist-det-${d}" class="hist-details">${listHtml}</div>
                    </div>`;
                });
                yearHtml += `</div></details>`;
            });
            yearHtml += `</div></details>`;
            hList.innerHTML += yearHtml;
        });
    }
    function tglHist(date) { const e = document.getElementById('hist-det-'+date); if(e) e.style.display = e.style.display==='block'?'none':'block'; }
    function initChart() { const ctx = document.getElementById('weightChart').getContext('2d'); if(weightChart) weightChart.destroy(); const sortedData = [...db.weightData].sort((a,b) => { const dateA = a.isoDate ? new Date(a.isoDate) : new Date(a.date.split('.').reverse().join('-')); const dateB = b.isoDate ? new Date(b.isoDate) : new Date(b.date.split('.').reverse().join('-')); return dateA - dateB; }); const labels = sortedData.map(d => d.date); const data = sortedData.map(d => d.val); const trend = data.map((val, i, arr) => { const start = Math.max(0, i - 6); const subset = arr.slice(start, i + 1); const sum = subset.reduce((a, b) => a + b, 0); return sum / subset.length; }); if(trend.length > 1) { const currentTrend = trend[trend.length - 1]; const prevTrend = trend[trend.length >= 8 ? trend.length - 8 : 0]; const diff = currentTrend - prevTrend; const arrow = diff > 0 ? 'üìà' : 'üìâ'; const displayVal = Math.abs(diff) > 0.9 ? `${Math.abs(diff).toFixed(2)}kg` : `${(Math.abs(diff) * 1000).toFixed(0)}g`; const el = document.getElementById('trend-ui'); if(el) el.innerHTML = `<span style="color:${diff > 0 ? '#f87171' : '#4ade80'}">${arrow} Echter Trend: ${diff > 0 ? '+' : '-'}${displayVal} / Woche</span>`; } weightChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'kg', data: data, borderColor: '#FF8C00', tension: 0.4, fill: true, backgroundColor: 'rgba(255, 140, 0, 0.1)', pointRadius: 6, pointHitRadius: 30 }, { label: 'Trend (7d)', data: trend, borderColor: '#4facfe', borderDash: [5, 5], tension: 0.4, pointRadius: 0, fill: false } ] }, options: { plugins: { legend: { display: false } } } }); }
    
    function addWeight() { 
        const val = document.getElementById('w-val').value; 
        const dateInput = document.getElementById('w-date').value; 
        if(!val || !dateInput) { showAlert("Bitte Gewicht und Datum angeben!"); return; } 
        const dObj = new Date(dateInput); 
        const dateDisplay = dObj.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'}); 
        db.weightData = db.weightData.filter(d => d.isoDate !== dateInput); 
        db.weightData.push({ date: dateDisplay, isoDate: dateInput, val: parseFloat(val) }); 
        db.personal.weight = val; 
        save(); initChart(); updateBodySummary(); 
        vBuz([30, 50, 30]); // Haptisches Feedback
        showAlert("Gewicht gespeichert!"); updateLevel(); 
    }
    
    // --- LONG PRESS LOGIK F√úR KATALOG ---
    let pressTimer;
    let pressStartX = 0;
    let pressStartY = 0;

    function startPress(e, id, name) {
        if (e.target.closest('.btn-action') || e.target.closest('.gear-icon')) return;
        
        if(e.touches && e.touches.length > 0) {
            pressStartX = e.touches[0].clientX;
            pressStartY = e.touches[0].clientY;
        }
        
        clearTimeout(pressTimer);
        pressTimer = setTimeout(() => {
            if(typeof vBuz === 'function') vBuz([50, 50]);
            deleteCatalogItem(id, name);
        }, 700); // Auf 0.7 Sekunden reduziert f√ºr ein snappigeres Gef√ºhl
    }

    function movePress(e) {
        if (!pressTimer) return;
        if(e.touches && e.touches.length > 0) {
            let dx = Math.abs(e.touches[0].clientX - pressStartX);
            let dy = Math.abs(e.touches[0].clientY - pressStartY);
            // Toleranz: Brich nur ab, wenn der Finger weiter als 15px bewegt wird
            if (dx > 15 || dy > 15) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        }
    }

    function cancelPress() {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
    function renderMarket() { 
        const l = document.getElementById('market-list'); 
        l.innerHTML = ''; 
        getFullCatalog().forEach(s => { 
            let subHtml = s.sub ? `<span class="sub-name">${s.sub}</span>` : ''; 
            
            // Karte nutzt jetzt Long-Press statt Swipe
            // oncontextmenu verhindert, dass das Standard-Browser-Men√º hochkommt
            l.innerHTML += `
            <div class="supp-card" 
                 ontouchstart="startPress(event, '${s.id}', '${s.name.replace(/'/g, "\\'")}')" 
                 ontouchend="cancelPress()" 
                 ontouchmove="movePress(event)" 
                 ontouchcancel="cancelPress()"
                 oncontextmenu="event.preventDefault();"
                 style="-webkit-user-select: none; user-select: none;">
                <div class="icon-box">${s.icon}</div>
                <div class="supp-meta"><b>${s.brand}</b><span class="supp-name">${s.name}</span>${subHtml}</div>
                <div class="gear-icon" onclick="clickGear('${s.id}')">‚öôÔ∏è</div>
                <button class="btn-action btn-add-katalog" style="width:auto; margin:0;" onclick="opnMod('${s.id}')">ADD</button>
            </div>`;
        }); 
    }

    function deleteCatalogItem(id, name) {
        showConfirm(`M√∂chtest du "${name}" wirklich komplett aus dem Katalog l√∂schen? (Es wird auch aus deinem aktiven Plan entfernt)`, function(res) {
            if(res) {
                if(!db.deletedSupps) db.deletedSupps = [];
                db.deletedSupps.push(id); // Merkt sich das gel√∂schte Base-Item
                
                db.customSupps = db.customSupps.filter(cs => cs.id !== id);
                db.activeSupps = db.activeSupps.filter(as => as.id !== id);
                delete db.stock[id];
                delete db.prices[id];
                
                save();
                renderMarket();
                renderPlan();
            }
        });
    }

    // NEU: Logik zum restlosen Entfernen eines Custom Supplements
    function deleteCustomSupp(id, name) {
        showConfirm(`M√∂chtest du "${name}" wirklich komplett aus dem Katalog l√∂schen? (Es wird auch aus deinem aktiven Plan entfernt)`, function(res) {
            if(res) {
                db.customSupps = db.customSupps.filter(cs => cs.id !== id);
                db.activeSupps = db.activeSupps.filter(as => as.id !== id);
                delete db.stock[id];
                delete db.prices[id];
                save();
                renderMarket();
                renderPlan();
            }
        });
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    function showPage(p) { 
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active')); 
        document.querySelectorAll('.nav button').forEach(bn => bn.classList.remove('active')); 
        document.getElementById('page-'+p).classList.add('active'); 
        document.getElementById('n-'+p).classList.add('active'); 
        if(p==='plan') renderPlan(); 
        if(p==='market') renderMarket(); 
        if(p==='gym') {
            document.getElementById('gym-day-select').value = getGermanDay();
            document.getElementById('gym-date-select').style.display = 'none';
            renderGymPlaner();
            setFlexDay(getGermanDay());
            updateGymChartSelect();
            updateGymChart();
            renderGymHistory();
        }
        if(p==='weight') { 
            document.getElementById('bp-date').value = getTodayDate();
            renderBpHistory();
            initBpChart();
            document.getElementById('w-date').value = getTodayDate(); 
            initChart(); 
            updateFastingUI(); 
            updateBodySummary(); 
            loadMasse(); 
            renderLabWidget(); 
            updateRadarChart(); 
        } 
        if(p==='profile') { 
            renderHistory(); 
            updateLevel(); 
        } 
    }
    
    function calcBMI() {
        const h = parseFloat(document.getElementById('set-height').value);
        const w = parseFloat(document.getElementById('set-weight').value);
        const resDiv = document.getElementById('res-bmi');
        if(!h || !w) { resDiv.innerHTML = "Bitte f√ºlle erst Gr√∂√üe und Gewicht (derzeit " + (w||0) + "kg) in den pers√∂nlichen Daten aus."; resDiv.style.display = 'block'; return; }
        const bmi = (w / ((h / 100) * (h / 100))).toFixed(1);
        db.analytics.bmi = bmi;
        
        let status = "Normalgewicht";
        let zClass = 1;
        if(bmi < 18.5) { status = "Untergewicht"; zClass = 0; }
        else if(bmi >= 25 && bmi < 30) { status = "√úbergewicht"; zClass = 2; }
        else if(bmi >= 30 && bmi < 35) { status = "Adipositas Grad 1"; zClass = 3; }
        else if(bmi >= 35 && bmi < 40) { status = "Adipositas Grad 2"; zClass = 4; }
        else if(bmi >= 40) { status = "Adipositas Grad 3"; zClass = 5; }

        resDiv.innerHTML = `<strong style="color:var(--accent); font-size:14px;">BMI: ${db.analytics.bmi} (${status})</strong><br>
        <span style="font-size:10px; color:#94a3b8; display:block; margin-top:5px;">‚ö†Ô∏è Hinweis: F√ºr √úbergewicht genauer (bei hohem Muskelanteil oft ungenau).</span>
        <table class="info-table">
            <tr class="${zClass===0?'row-active':''}"><td>< 18.5</td><td>Untergewicht</td></tr>
            <tr class="${zClass===1?'row-active':''}"><td><b>18.5 - 24.9</b></td><td><b>Normal</b></td></tr>
            <tr class="${zClass===2?'row-active':''}"><td>25.0 - 29.9</td><td>√úbergewicht</td></tr>
            <tr class="${zClass===3?'row-active':''}"><td>30.0 - 34.9</td><td>Adipositas Grad 1</td></tr>
            <tr class="${zClass===4?'row-active':''}"><td>35.0 - 39.9</td><td>Adipositas Grad 2</td></tr>
            <tr class="${zClass===5?'row-active':''}"><td>40.0+</td><td>Adipositas Grad 3</td></tr>
        </table>`;
        resDiv.style.display = 'block'; save();
    }

    function calcWHR() {
        const h = parseFloat(document.getElementById('set-height').value);
        const waist = parseFloat(document.getElementById('set-waist').value);
        const hip = parseFloat(document.getElementById('set-hip').value);
        const resDiv = document.getElementById('res-whr');
        if(!waist || !h) { resDiv.innerHTML = "Bitte f√ºlle Gr√∂√üe und Taillenumfang aus."; resDiv.style.display = 'block'; return; }
        const whtr = (waist / h).toFixed(2); db.analytics.whtr = whtr;
        
        let zone = whtr < 0.4 ? 0 : whtr <= 0.5 ? 1 : whtr <= 0.6 ? 2 : 3;
        
        let html = `<div style="margin-bottom:10px;"><strong style="color:${whtr<0.5?"var(--success)":"var(--warning)"}; font-size:14px;">WHtR: ${db.analytics.whtr}</strong><br>
        <span style="font-size:10px; color:#94a3b8;">Optimaler Bereich (WHtR):</span>
        <table class="info-table">
            <tr class="${zone===0?'row-active':''}"><td>< 0.4</td><td>Untergewicht</td></tr>
            <tr class="${zone===1?'row-active':''}"><td><b>0.4 - 0.5</b></td><td><b>Gesund (Ideal)</b></td></tr>
            <tr class="${zone===2?'row-active':''}"><td>0.5 - 0.6</td><td>√úbergewicht</td></tr>
            <tr class="${zone===3?'row-active':''}"><td>> 0.6</td><td>Erh√∂htes Risiko</td></tr>
        </table></div>`;
        
        if (hip) { 
            const whr = (waist / hip).toFixed(2); db.analytics.whr = whr; 
            html += `<div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;"><strong style="color:var(--accent); font-size:14px;">WHR: ${db.analytics.whr}</strong><br>
            <span style="font-size:10px; color:#94a3b8;">Taille-H√ºfte-Verh√§ltnis:</span>
            <table class="info-table">
                <tr><td>M√§nner</td><td>< 0.90 (Normal)</td></tr>
                <tr><td>Frauen</td><td>< 0.85 (Normal)</td></tr>
            </table></div>`; 
        }
        resDiv.innerHTML = html; resDiv.style.display = 'block'; save();
    }

    function calcCalories() {
        const age = parseFloat(document.getElementById('set-age').value), h = parseFloat(document.getElementById('set-height').value), w = parseFloat(document.getElementById('set-weight').value), gender = document.getElementById('set-gender').value, resDiv = document.getElementById('res-cal');
        if(!age || !h || !w) { resDiv.innerHTML = "Fehlende Daten (Alter, Gr√∂√üe, Gewicht) in den Einstellungen."; resDiv.style.display = 'block'; return; }
        const slp = parseFloat(document.getElementById('pal-sleep').value) || 0, rlx = parseFloat(document.getElementById('pal-relax').value) || 0, sit = parseFloat(document.getElementById('pal-sit').value) || 0, std = parseFloat(document.getElementById('pal-stand').value) || 0, spt = parseFloat(document.getElementById('pal-sport').value) || 0;
        if(Math.abs((slp+rlx+sit+std+spt) - 24) > 0.01) { resDiv.innerHTML = `<span style="color:var(--danger); font-weight:bold;">Fehler: Summe muss 24h sein (aktuell ${(slp+rlx+sit+std+spt).toFixed(1)}h).</span>`; resDiv.style.display = 'block'; return; }
        const avgPal = ((slp * 0.95) + (rlx * 1.2) + (sit * 1.45) + (std * 1.65) + (spt * 2.0)) / 24;
        let grund = (10 * w) + (6.25 * h) - (5 * age) + (gender === 'm' ? 5 : -161);
        const gesamt = grund * avgPal; 
        db.analytics.grundumsatz = Math.round(grund); 
        db.analytics.gesamtumsatz = Math.round(gesamt);
        db.analytics.leistungsumsatz = Math.round(gesamt - grund);

        resDiv.innerHTML = `<div style="margin-bottom:10px;"><strong style="color:var(--day-glow); font-size:14px;">Grundumsatz: ${db.analytics.grundumsatz} kcal</strong></div>
        <div style="margin-bottom:10px;"><strong style="color:white; font-size:14px;">Leistungsumsatz: ${db.analytics.leistungsumsatz} kcal</strong></div>
        <div><strong style="color:var(--success); font-size:14px;">Gesamtumsatz: ${db.analytics.gesamtumsatz} kcal</strong><br><span style="font-size:10px; color:#94a3b8;">Berechnet bei ${w}kg und √ò PAL ${avgPal.toFixed(2)}</span></div>`;
        resDiv.style.display = 'block'; save();
    }

    function openSettingsModal() {
        document.getElementById('chk-show-bp').checked = db.analytics.showBp;
        document.getElementById('set-name').value = db.userName || '';
        document.getElementById('set-gender').value = db.personal.gender || 'm';
        document.getElementById('set-age').value = db.personal.age || '';
        document.getElementById('set-height').value = db.personal.height || '';
        document.getElementById('set-weight').value = db.personal.weight || '';
        document.getElementById('set-birth').value = db.personal.birthdate || '';
        document.getElementById('set-waist').value = db.personal.waist || '';
        document.getElementById('set-hip').value = db.personal.hip || '';
        document.getElementById('pal-sleep').value = db.personal.pal.sleep;
        document.getElementById('pal-relax').value = db.personal.pal.relax;
        document.getElementById('pal-sit').value = db.personal.pal.sit;
        document.getElementById('pal-stand').value = db.personal.pal.stand;
        document.getElementById('pal-sport').value = db.personal.pal.sport;
        
        document.getElementById('chk-show-fasting').checked = db.analytics.showFasting;
        document.getElementById('chk-show-masse').checked = db.analytics.showMasse;
        document.getElementById('chk-show-gewicht').checked = db.analytics.showGewicht;
        document.getElementById('chk-show-labor').checked = db.analytics.showLabor;
        document.getElementById('chk-show-radar').checked = db.analytics.showRadar;
        document.getElementById('chk-show-bmi').checked = db.analytics.showBmi;
        document.getElementById('chk-show-whtr').checked = db.analytics.showWhtr;
        document.getElementById('chk-show-whr').checked = db.analytics.showWhr;
        document.getElementById('chk-show-grund').checked = db.analytics.showGrund;
        document.getElementById('chk-show-leistung').checked = db.analytics.showLeistung;
        document.getElementById('chk-show-gesamt').checked = db.analytics.showGesamt;
        document.getElementById('chk-show-top-level').checked = db.analytics.showTopLevel !== false;
        
        // Neu: Zyklus laden
        document.getElementById('chk-show-cycle').checked = db.analytics.showCycle || false;
        document.getElementById('set-cycle-start').value = db.personal.cycleStart || '';
        document.getElementById('set-cycle-length').value = db.personal.cycleLength || 28;
        
        document.getElementById('chk-haptic').checked = db.analytics.haptic;
        
        updatePalStatus();
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettingsModal() {
        db.analytics.showBp = document.getElementById('chk-show-bp').checked;
        db.userName = document.getElementById('set-name').value.trim();
        db.personal.gender = document.getElementById('set-gender').value;
        db.personal.age = document.getElementById('set-age').value;
        db.personal.height = document.getElementById('set-height').value;
        db.personal.weight = document.getElementById('set-weight').value;
        db.personal.birthdate = document.getElementById('set-birth').value;
        db.personal.waist = document.getElementById('set-waist').value;
        db.personal.hip = document.getElementById('set-hip').value;
        db.personal.pal.sleep = parseFloat(document.getElementById('pal-sleep').value) || 0;
        db.personal.pal.relax = parseFloat(document.getElementById('pal-relax').value) || 0;
        db.personal.pal.sit = parseFloat(document.getElementById('pal-sit').value) || 0;
        db.personal.pal.stand = parseFloat(document.getElementById('pal-stand').value) || 0;
        db.personal.pal.sport = parseFloat(document.getElementById('pal-sport').value) || 0;
        
        db.analytics.showFasting = document.getElementById('chk-show-fasting').checked;
        db.analytics.showMasse = document.getElementById('chk-show-masse').checked;
        db.analytics.showGewicht = document.getElementById('chk-show-gewicht').checked;
        db.analytics.showLabor = document.getElementById('chk-show-labor').checked;
        db.analytics.showRadar = document.getElementById('chk-show-radar').checked;
        db.analytics.showBmi = document.getElementById('chk-show-bmi').checked;
        db.analytics.showWhtr = document.getElementById('chk-show-whtr').checked;
        db.analytics.showWhr = document.getElementById('chk-show-whr').checked;
        db.analytics.showGrund = document.getElementById('chk-show-grund').checked;
        db.analytics.showLeistung = document.getElementById('chk-show-leistung').checked;
        db.analytics.showGesamt = document.getElementById('chk-show-gesamt').checked;
        db.analytics.showTopLevel = document.getElementById('chk-show-top-level').checked;

        // Neu: Zyklus speichern
        db.analytics.showCycle = document.getElementById('chk-show-cycle').checked;
        db.personal.cycleStart = document.getElementById('set-cycle-start').value;
        db.personal.cycleLength = parseInt(document.getElementById('set-cycle-length').value) || 28;

        db.analytics.haptic = document.getElementById('chk-haptic').checked;

        save(); 
        
        // NEU: Wenn ein Backup geladen wurde, App nach dem Speichern aktualisieren
        if (needsReloadAfterSave) {
            location.reload();
            return;
        }
        
        initWelcome(); 
        updateBodySummary();
        updateDashboardView();
        document.getElementById('settings-modal').style.display = 'none';
    }

    function exportBackup() {
        const rawData = localStorage.getItem(STORAGE_KEY);
        if (!rawData) { showAlert("Keine Daten gefunden!", "Fehler"); return; }
        const blob = new Blob([rawData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "BioStack_Backup_" + new Date().toISOString().split('T')[0] + ".json";
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function importBackup(event) {
        const file = event.target.files[0]; if (!file) return;
        
        showConfirm(`M√∂chtest du das lokale Backup "${file.name}" wirklich laden? Deine aktuellen Daten werden √ºberschrieben.`, function(res) {
            if(res) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try { 
                        db = JSON.parse(e.target.result); // In-Memory Update
                        localStorage.setItem(STORAGE_KEY, e.target.result); 
                        needsReloadAfterSave = true; // Reload f√ºr den Speichern-Button vormerken
                        showAlert("Lokales Backup erfolgreich geladen!\n\nBitte klicke nun unten auf 'SCHLIE√üEN & SPEICHERN', um den Vorgang abzuschlie√üen.", "Erfolg");
                        document.getElementById('fileInput').value = ''; // Input zur√ºcksetzen
                    } catch (err) { 
                        showAlert("Ung√ºltige Datei.", "Fehler"); 
                    }
                };
                reader.readAsText(file);
            } else {
                document.getElementById('fileInput').value = ''; // Input bei Abbruch zur√ºcksetzen
            }
        }, "Lokal Laden", "Ja, laden");
    }

    // --- GOOGLE DRIVE CLOUD SYNC ---
    let tokenClient;
    let gAccessToken = localStorage.getItem('gAccessToken') || null;
    let gUserInfo = JSON.parse(localStorage.getItem('gUserInfo')) || null;
    let needsReloadAfterSave = false; // NEU: Steuert den App-Reload nach dem Backup

    // Initialisiert den Google Auth Client im Hintergrund
    window.addEventListener('load', () => {
        if(window.google && google.accounts && google.accounts.oauth2) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '658435060149-9gilb78tq2kbs472u4pfco49js3tgf3l.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        gAccessToken = tokenResponse.access_token;
                        localStorage.setItem('gAccessToken', gAccessToken);
                        fetchGoogleUserInfo();
                    }
                },
            });
            if (gAccessToken && gUserInfo) updateGoogleUI();
        }
    });

    function handleAuthClick() {
        if(tokenClient) tokenClient.requestAccessToken({prompt: 'consent'});
        else showAlert("Google API noch nicht geladen. Bitte kurz warten.", "Hinweis");
    }

    function fetchGoogleUserInfo() {
        fetch('https://www.googleapis.com/oauth2/v1/userinfo?alt=json', {
            headers: { Authorization: `Bearer ${gAccessToken}` }
        })
        .then(res => res.json())
        .then(data => {
            gUserInfo = data;
            localStorage.setItem('gUserInfo', JSON.stringify(data));
            updateGoogleUI();
            showAlert("Erfolgreich mit Google verbunden!", "Cloud");
        }).catch(err => console.log(err));
    }

    function updateGoogleUI() {
        if(gUserInfo && document.getElementById('google-login-section')) {
            document.getElementById('google-login-section').style.display = 'none';
            document.getElementById('google-user-section').style.display = 'block';
            document.getElementById('google-user-name').innerText = `Angemeldet als: ${gUserInfo.name}`;
        }
    }

    async function syncToDrive() {
        if(!gAccessToken) { handleAuthClick(); return; }
        document.getElementById('google-user-name').innerText = "Synchronisiere... ‚è≥";
        
        const metadata = { name: 'BioStack_Backup.json', mimeType: 'application/json' };
        const fileContent = localStorage.getItem(STORAGE_KEY);
        const file = new Blob([fileContent], {type: 'application/json'});
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', file);

        try {
            // 1. Pr√ºfen ob Backup schon existiert
            let searchRes = await fetch("https://www.googleapis.com/drive/v3/files?q=name='BioStack_Backup.json' and trashed=false", {
                headers: { Authorization: `Bearer ${gAccessToken}` }
            });
            let searchData = await searchRes.json();
            
            let fetchMethod = 'POST';
            let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            
            // Wenn existent, √ºberschreiben (PATCH)
            if (searchData.files && searchData.files.length > 0) {
                const fileId = searchData.files[0].id;
                fetchMethod = 'PATCH';
                url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
            }

            // 2. Upload ausf√ºhren
            let uploadRes = await fetch(url, { method: fetchMethod, headers: { Authorization: `Bearer ${gAccessToken}` }, body: form });
            
            if(uploadRes.ok) {
                showAlert("Backup erfolgreich in deinem Google Drive gespeichert!", "Cloud Sync");
                document.getElementById('google-user-name').innerText = `Angemeldet als: ${gUserInfo.name}`;
            } else {
                gAccessToken = null; localStorage.removeItem('gAccessToken');
                handleAuthClick(); // Token abgelaufen, neu anfordern
            }
        } catch(e) {
            showAlert("Netzwerkfehler beim Cloud Sync.", "Fehler");
            document.getElementById('google-user-name').innerText = `Angemeldet als: ${gUserInfo.name}`;
        }
    }

    async function restoreFromDrive() {
        if(!gAccessToken) { handleAuthClick(); return; }
        
        showConfirm("Achtung: Dies √ºberschreibt deine aktuellen lokalen Daten mit dem letzten Google Drive Backup. Fortfahren?", async function(res) {
            if(res) {
                document.getElementById('google-user-name').innerText = "Lade Backup... ‚è≥";
                try {
                    let searchRes = await fetch("https://www.googleapis.com/drive/v3/files?q=name='BioStack_Backup.json' and trashed=false", {
                        headers: { Authorization: `Bearer ${gAccessToken}` }
                    });
                    let searchData = await searchRes.json();
                    
                    if (searchData.files && searchData.files.length > 0) {
                        const fileId = searchData.files[0].id;
                        let fileRes = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                            headers: { Authorization: `Bearer ${gAccessToken}` }
                        });
                        let fileText = await fileRes.text();
                        
                        try {
                            db = JSON.parse(fileText); // In-Memory Update
                            localStorage.setItem(STORAGE_KEY, fileText);
                            needsReloadAfterSave = true; // Reload f√ºr den Speichern-Button vormerken
                            showAlert("Daten erfolgreich aus der Cloud geladen!\n\nBitte klicke nun unten auf 'SCHLIE√üEN & SPEICHERN', um den Vorgang abzuschlie√üen.", "Erfolg");
                        } catch(e) {
                            showAlert("Fehler: Das Cloud-Backup ist besch√§digt.", "Fehler");
                        }
                    } else {
                        showAlert("Kein Backup 'BioStack_Backup.json' in deinem Google Drive gefunden.", "Nicht gefunden");
                    }
                } catch(e) {
                    showAlert("Fehler beim Abrufen aus Google Drive.", "Fehler");
                }
                document.getElementById('google-user-name').innerText = `Angemeldet als: ${gUserInfo.name}`;
            }
        }, "Cloud Restore", "Wiederherstellen");
    }

    function openWiki() { document.getElementById('wiki-modal').style.display = 'flex'; }
    function closeWiki() { document.getElementById('wiki-modal').style.display = 'none'; }
    function tglWiki(element) { element.classList.toggle('active'); }

    const ranks = [ { id: 1, name: "Starter", xp: 0, icon: "üå±" }, { id: 5, name: "Novize", xp: 250, icon: "ü•â" }, { id: 10, name: "Optimizer", xp: 500, icon: "üîã" }, { id: 15, name: "Tracker", xp: 1000, icon: "üìã" }, { id: 20, name: "Bio-Hacker", xp: 2000, icon: "üß¨" }, { id: 25, name: "System-Engineer", xp: 3500, icon: "üõ†Ô∏è" }, { id: 30, name: "Neuro-Hacker", xp: 5000, icon: "üß†" }, { id: 40, name: "Alchemist", xp: 7500, icon: "‚öóÔ∏è" }, { id: 50, name: "Limitless", xp: 10000, icon: "‚ö°" }, { id: 60, name: "Cyborg", xp: 13000, icon: "ü¶æ" }, { id: 75, name: "Apex Human", xp: 17500, icon: "ü¶Ö" }, { id: 90, name: "Immortal", xp: 21000, icon: "üåå" }, { id: 100, name: "BioHacker Master", xp: 25000, icon: "üëë" } ];

    function updateLevel() {
        let xp = 0; 
    // XP f√ºr Supplements
    for (let date in db.history) { xp += (db.history[date].length * 10); } 
    // XP f√ºr Gewicht
    if (db.weightData) { xp += (db.weightData.length * 50); }
    if (db.bpData) { xp += (db.bpData.length * 20); } // 20 XP f√ºr jede Blutdruckmessung
    // XP f√ºr Gym (150 XP pro getracktem Trainingstag)
    if (db.gym && db.gym.logs) {
        const gymDays = [...new Set(db.gym.logs.map(l => l.date))];
        xp += (gymDays.length * 150);
}
        let currentRank = ranks[0], nextRank = ranks[1];
        for (let i = 0; i < ranks.length; i++) { if (xp >= ranks[i].xp) { currentRank = ranks[i]; nextRank = ranks[i + 1] || ranks[i]; } }
        if(document.getElementById('lvl-name')){
            document.getElementById('lvl-name').innerText = `Level ${currentRank.id}: ${currentRank.name}`;
            document.getElementById('lvl-icon').innerText = currentRank.icon;
            document.getElementById('lvl-xp').innerText = currentRank.id === 100 ? `${xp} XP (Max)` : `${xp} / ${nextRank.xp} XP`;
            document.getElementById('lvl-bar').style.width = currentRank.id === 100 ? "100%" : `${((xp - currentRank.xp) / (nextRank.xp - currentRank.xp)) * 100}%`;
        }
        const listContainer = document.getElementById('ranks-list-container');
        if (listContainer) {
            listContainer.innerHTML = '';
            ranks.forEach(r => {
                let statusClass = xp >= r.xp ? (r.id === currentRank.id ? "current" : "") : "locked";
                listContainer.innerHTML += `<div class="rank-list-item ${statusClass}"><span style="font-size:30px;">${r.icon}</span><div><b style="${r.id === currentRank.id ? 'color:var(--accent);' : ''}">Level ${r.id}: ${r.name}</b><br><span style="font-size:11px; color:#94a3b8;">ab ${r.xp} XP</span></div></div>`;
            });
        }
        
        // NEU: Update das globale Badge in der Navigationsleiste
        if(document.getElementById('glb-icon')) {
            document.getElementById('glb-icon').innerText = currentRank.icon;
            document.getElementById('glb-text').innerText = `Lvl ${currentRank.id}`;
        }
        updateTopLevelBadge(); // Pr√ºft direkt, ob es angezeigt werden soll
    }

    function openRanksModal() { document.getElementById('ranks-modal').style.display = 'flex'; }
    function closeRanksModal() { document.getElementById('ranks-modal').style.display = 'none'; }

    // NEU: Funktion zum Ein- und Ausblenden des Badges
    function updateTopLevelBadge() {
        const badge = document.getElementById('global-level-badge');
        if(badge) {
            badge.style.display = (db.analytics.showTopLevel !== false) ? 'flex' : 'none';
        }
    }

    updateLevel(); 
    updateFastingUI(); 
    updateDashboardView();
    showPage('plan');
    // --- START-TAB LOGIK ---
    function saveStartTab() {
        const val = document.getElementById('setting-start-tab').value;
        db.startTab = val;
        save();
        if(typeof showAlert === 'function') showAlert("Start-Tab auf " + val.toUpperCase() + " ge√§ndert!");
    }

    function loadStartTabSetting() {
        const el = document.getElementById('setting-start-tab');
        if(el && db.startTab) {
            el.value = db.startTab;
        }
    }

    // --- APP LOCK LOGIK ---
    let currentPinInput = "";
    let isSettingPin = false;
    let tempPin = "";

    // 1. Beim Start pr√ºfen, ob eine PIN existiert
    if(db.appLockPin) {
        document.getElementById('app-lock-screen').style.display = 'flex';
    }

    function addPin(num) {
        if(currentPinInput.length < 4) {
            currentPinInput += num;
            updatePinDots();
        }
        if(currentPinInput.length === 4) {
            setTimeout(checkPin, 150);
        }
    }

    function delPin() {
        if(currentPinInput.length > 0) {
            currentPinInput = currentPinInput.slice(0, -1);
            updatePinDots();
        }
    }

    function updatePinDots() {
        for(let i=1; i<=4; i++) {
            const dot = document.getElementById('dot-'+i);
            if(i <= currentPinInput.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        }
    }

    function checkPin() {
        const msg = document.getElementById('pin-msg');
        
        if(isSettingPin) {
            if(!tempPin) {
                tempPin = currentPinInput;
                currentPinInput = "";
                updatePinDots();
                msg.innerText = "PIN wiederholen";
                msg.style.color = "var(--day-glow)";
            } else {
                if(tempPin === currentPinInput) {
                    db.appLockPin = tempPin;
                    save();
                    isSettingPin = false;
                    tempPin = "";
                    document.getElementById('app-lock-screen').style.display = 'none';
                    document.getElementById('pin-close-btn').style.display = 'none';
                    showAlert("PIN-Sperre erfolgreich aktiviert!");
                } else {
                    msg.innerText = "PINs stimmen nicht √ºberein!";
                    msg.style.color = "var(--danger)";
                    tempPin = "";
                    currentPinInput = "";
                    updatePinDots();
                    if(typeof vBuz === 'function') vBuz([50, 50, 50]);
                    setTimeout(() => { msg.innerText = "Neue PIN eingeben"; msg.style.color = "var(--accent)"; }, 2000);
                }
            }
        } else {
            if(currentPinInput === db.appLockPin) {
                document.getElementById('app-lock-screen').style.display = 'none';
                currentPinInput = "";
                updatePinDots();
            } else {
                msg.innerText = "Falsche PIN!";
                msg.style.color = "var(--danger)";
                currentPinInput = "";
                updatePinDots();
                if(typeof vBuz === 'function') vBuz([50, 50, 50]);
                setTimeout(() => { msg.innerText = "PIN eingeben"; msg.style.color = "#94a3b8"; }, 1500);
            }
        }
    }

    function setupPinLock() {
        if(db.appLockPin) {
            showConfirm("App-Sperre ist aktiv. M√∂chtest du sie DEAKTIVIEREN?", function(res) {
                if(res) {
                    db.appLockPin = null;
                    save();
                    showAlert("App-Sperre wurde deaktiviert.");
                }
            });
        } else {
            isSettingPin = true;
            tempPin = "";
            currentPinInput = "";
            updatePinDots();
            document.getElementById('pin-msg').innerText = "Neue PIN festlegen";
            document.getElementById('pin-msg').style.color = "var(--accent)";
            document.getElementById('pin-close-btn').style.display = 'block'; // X anzeigen
            document.getElementById('app-lock-screen').style.display = 'flex';
        }
    }

    // NEU: Funktion zum Abbrechen der PIN-Einrichtung
    function cancelPinSetup() {
        isSettingPin = false;
        tempPin = "";
        currentPinInput = "";
        updatePinDots();
        document.getElementById('pin-close-btn').style.display = 'none';
        document.getElementById('app-lock-screen').style.display = 'none';
    }

    // --- APP-START INITIALISIERUNG ---
    setTimeout(() => {
        loadStartTabSetting(); // L√§dt deine Einstellung ins Dropdown
        if(db.startTab && db.startTab !== 'plan') {
            showPage(db.startTab); // Springt magisch zum gew√§hlten Tab!
        }
    }, 100);

    // --- PIN-LOGIK (Subtil & Clean) ---
    if (!db.pinnedSections) db.pinnedSections = [];

    function initSubtlePins() {
        // Sucht alle Inhalts-Boxen
        document.querySelectorAll('.collapse-content').forEach(content => {
            const container = content.parentElement;
            const containerId = container.id;
            
            // Nur einbauen, wenn die Box eine ID hat und noch keinen Fixier-Button besitzt
            if (containerId && !content.querySelector('.pin-subtle-btn')) {
                
                // Erstellt den Container f√ºr den dezenten Button
                const btnWrapper = document.createElement('div');
                btnWrapper.className = 'pin-subtle-btn';
                btnWrapper.style.cssText = 'display:flex; justify-content:flex-end; margin-top:-5px; margin-bottom:15px; user-select:none;';
                
                const isPinned = db.pinnedSections.includes(containerId);
                
                // Erstellt das kleine, elegante Badge
                const badge = document.createElement('div');
                badge.style.cssText = 'font-size:9px; font-weight:800; cursor:pointer; text-transform:uppercase; letter-spacing:1px; padding:4px 8px; border-radius:6px; transition:0.2s;';
                
                if (isPinned) {
                    badge.style.background = 'rgba(255, 140, 0, 0.1)';
                    badge.style.color = 'var(--accent)';
                    badge.innerHTML = '‚òÖ Fixiert';
                } else {
                    badge.style.background = 'rgba(255,255,255,0.05)';
                    badge.style.color = '#64748b';
                    badge.innerHTML = '‚òÜ Fixieren';
                }

                btnWrapper.appendChild(badge);

                // Klick-Logik
                badge.onclick = (e) => {
                    e.stopPropagation(); 
                    
                    if (db.pinnedSections.includes(containerId)) {
                        db.pinnedSections = db.pinnedSections.filter(id => id !== containerId);
                        badge.style.background = 'rgba(255,255,255,0.05)';
                        badge.style.color = '#64748b';
                        badge.innerHTML = '‚òÜ Fixieren';
                    } else {
                        db.pinnedSections.push(containerId);
                        badge.style.background = 'rgba(255, 140, 0, 0.1)';
                        badge.style.color = 'var(--accent)';
                        badge.innerHTML = '‚òÖ Fixiert';
                    }
                    save();
                };

                // Ganz oben als allererstes Element in den Content einf√ºgen
                content.insertBefore(btnWrapper, content.firstChild);
            }
        });
    }

    // Beim App-Start alle fixierten Boxen automatisch im Hintergrund √∂ffnen
    function openPinnedSections() {
        if (!db.pinnedSections) return;
        db.pinnedSections.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.classList.add('collapse-active');
                const content = container.querySelector('.collapse-content');
                if (content) content.style.maxHeight = '5000px'; 
            }
        });
    }

    setTimeout(() => {
        initSubtlePins();
        openPinnedSections();
    }, 250);
// --- ZYKLUS TRACKER LOGIK (Deep Dive Version) ---
function updateCycleUI() {
    const widget = document.getElementById('cycle-widget-container');
    if(!widget) return;
    
    // Falls Tracker in Einstellungen aus: Widget verstecken
    if(!db.analytics.showCycle) {
        widget.style.display = 'none';
        return;
    }
    
    widget.style.display = 'flex';
    widget.style.flexDirection = 'column';

    const ring = document.getElementById('c-ring');
    const dayEl = document.getElementById('c-day');
    const phaseEl = document.getElementById('c-phase');
    const infoEl = document.getElementById('c-info');

    // Falls kein Datum eingegeben wurde
    if(!db.personal.cycleStart) {
        dayEl.innerText = "-";
        phaseEl.innerText = "Nicht konfiguriert";
        infoEl.innerHTML = "Bitte in den <b style='color:#ec4899;'>Einstellungen</b> konfigurieren.";
        return;
    }

    // Berechnung
    const start = new Date(db.personal.cycleStart);
    start.setHours(0,0,0,0);
    const current = new Date(getViewDate());
    current.setHours(0,0,0,0);

    const diffTime = current - start;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const cLen = db.personal.cycleLength || 28;
    
    let currentDay = (diffDays % cLen) + 1;
    let pct = (currentDay / cLen) * 100;
    
    // Ring & Tag updaten
    dayEl.innerText = `${currentDay}`;
    ring.style.background = `conic-gradient(#ec4899 ${pct}%, rgba(255,255,255,0.05) ${pct}%)`;

    const ratio = currentDay / cLen;
    let data = {};

    // Die 4 Phasen Logik
    if (ratio <= (5/28)) {
        data = {
            title: "Menstruationsphase",
            short: "Fokus auf Regeneration & Eisen.",
            wirkung: "Der Hormonspiegel ist am niedrigsten Punkt. Der K√∂rper reinigt sich, was Energie f√ºr das Immunsystem abzieht.",
            timing: "Kinetik: Tag 1-5. Niedrige Belastbarkeit. Progesteron-Abfall kann Entz√ºndungen triggern.",
            food: ["Rote Bete (Eisen)", "K√ºrbiskerne (Magnesium)", "Zartbitterschokolade (Stimmung)", "Linsen (Zink)"]
        };
    } else if (ratio <= (13/28)) {
        data = {
            title: "Follikelphase",
            short: "High-Energy & Kraftaufbau.",
            wirkung: "√ñstrogen steigt an. Das wirkt anabol (muskelaufbauend) und verbessert die Insulin-Sensitivit√§t.",
            timing: "Kinetik: Peak-Leistung ca. Tag 8-12. Du bist mental scharf und k√∂rperlich am st√§rksten.",
            food: ["Brokkoli (Stoffwechsel)", "Kimchi (Darmflora)", "H√§hnchen/Tofu (Aminos√§uren)", "Leinsamen (Phyto√∂strogene)"]
        };
    } else if (ratio <= (15/28)) {
        data = {
            title: "Ovulationsphase (Eisprung)",
            short: "Maximale Kraft, saubere Technik.",
            wirkung: "√ñstrogen-Peak macht dich stark, aber lockert Kollagenstrukturen (B√§nder/Sehnen).",
            timing: "Kinetik: H√§lt nur 24-48 Std. Stoffwechsel l√§uft auf Hochtouren.",
            food: ["Lachs (Omega-3)", "Spinat (Fols√§ure)", "Eier (Cholin)", "Avocado (Hormon-Fette)"]
        };
    } else {
        data = {
            title: "Lutealphase",
            short: "Umsatz steigt +250 kcal.",
            wirkung: "Progesteron dominiert. Die K√∂rpertemperatur steigt um ca. 0.5¬∞C, was den Kalorienverbrauch erh√∂ht.",
            timing: "Kinetik: 10-14 Tage. Wasseransammlungen m√∂glich. Kraft sinkt zum Ende hin ab.",
            food: ["Bananen (B6 gegen PMS)", "S√º√ükartoffeln (Komplexe Carbs)", "Waln√ºsse (Entspannung)", "Quinoa (Zink & Protein)"]
        };
    }

    phaseEl.innerText = data.title;
    
    // Das Info-Feld mit dem neuen Dropdown bef√ºllen
    infoEl.innerHTML = `
        <div style="color:#cbd5e1; font-size:11px; margin-bottom:5px;">${data.short}</div>
        <details style="background:rgba(236, 72, 153, 0.1); border-radius:8px; padding:8px; border:1px solid rgba(236, 72, 153, 0.2);">
            <summary style="font-size:10px; color:#ec4899; cursor:pointer; font-weight:bold; outline:none; list-style:none;">‚ÑπÔ∏è DEEP DIVE & FOOD ‚ñæ</summary>
            <div style="font-size:10px; line-height:1.4; margin-top:8px; color:#e2e8f0;">
                <p style="margin-bottom:5px;"><b>Wirkungsweise:</b> ${data.wirkung}</p>
                <p style="margin-bottom:5px;"><b>Timing (Kinetik):</b> ${data.timing}</p>
                <b>Lebensmittel-Quellen:</b><br>
                ‚Ä¢ ${data.food[0]} (Hoch)<br>
                ‚Ä¢ ${data.food[1]} (Hoch)<br>
                ‚Ä¢ ${data.food[2]} (Normal)<br>
                ‚Ä¢ ${data.food[3]} (Normal)
            </div>
        </details>
    `;
}

      // --- BLUTDRUCK LOGIK (Multimessung & Averages) ---
    function saveBp() {
        const dateStr = document.getElementById('bp-date').value || getTodayDate();
        const sys = parseInt(document.getElementById('bp-sys').value);
        const dia = parseInt(document.getElementById('bp-dia').value);
        const pulse = parseInt(document.getElementById('bp-pulse').value) || null;

        if(!sys || !dia) { showAlert("Bitte SYS und DIA (z.B. 120 / 80) eintragen!"); return; }

        const dateDisplay = new Date(dateStr).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'});
        const timeStr = new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});

        const entryId = 'bp_' + Date.now();

        db.bpData.push({ id: entryId, date: dateDisplay, isoDate: dateStr, time: timeStr, sys, dia, pulse });
        db.bpData.sort((a,b) => new Date(b.isoDate) - new Date(a.isoDate));

        save();
        vBuz([30, 50, 30]);
        document.getElementById('bp-msg').innerText = "Messung gespeichert!";
        setTimeout(() => document.getElementById('bp-msg').innerText = "", 2000);
        
        document.getElementById('bp-sys').value = '';
        document.getElementById('bp-dia').value = '';
        document.getElementById('bp-pulse').value = '';

        renderBpHistory();
        initBpChart();
        updateLevel(); 
    }

    let openBpDate = null; // Speichert das ge√∂ffnete Datum beim L√∂schen

function deleteBp(id) {
    const item = db.bpData.find(d => d.id === id);
    if (!item) return;

    showConfirm("Diese spezifische Messung wirklich l√∂schen?", function(res) {
        if(res) {
            openBpDate = item.isoDate; // Datum vor dem L√∂schen sichern
            db.bpData = db.bpData.filter(d => d.id !== id);
            save(); renderBpHistory(); initBpChart();
        }
    });
}

function renderBpHistory() {
    const cont = document.getElementById('bp-history-list');
    if (!cont) return;
    cont.innerHTML = '';
    if (!db.bpData || db.bpData.length === 0) {
        cont.innerHTML = '<div style="font-size:11px; opacity:0.5; text-align:center;">Noch keine Blutdruck-Historie.</div>';
        return;
    }

    const daysMap = {};
    db.bpData.forEach(m => {
        if(!daysMap[m.isoDate]) daysMap[m.isoDate] = [];
        daysMap[m.isoDate].push(m);
    });

    const yearGroups = {};
    Object.keys(daysMap).sort().reverse().forEach(isoDate => {
        const yKey = isoDate.substring(0, 4);
        const mKey = isoDate.substring(5, 7);
        if (!yearGroups[yKey]) yearGroups[yKey] = {};
        if (!yearGroups[yKey][mKey]) yearGroups[yKey][mKey] = [];
        yearGroups[yKey][mKey].push(isoDate);
    });

    Object.keys(yearGroups).sort().reverse().forEach(yKey => {
        let isYearOpen = (typeof openBpDate !== 'undefined' && openBpDate && openBpDate.startsWith(yKey)) ? "open" : "";
        let yearHtml = `<details ${isYearOpen} style="margin-bottom:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; overflow:hidden;"><summary style="padding:15px; font-weight:900; color:white; font-size:14px; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05);"><span>üìÖ JAHR ${yKey}</span><span style="font-size:10px; opacity:0.6;">Aufklappen ‚ñæ</span></summary><div style="padding:10px;">`;

        Object.keys(yearGroups[yKey]).sort().reverse().forEach(mKey => {
            const monthLabel = new Date(`${yKey}-${mKey}-01`).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            let isMonthOpen = (typeof openBpDate !== 'undefined' && openBpDate && openBpDate.startsWith(`${yKey}-${mKey}`)) ? "open" : "";
            yearHtml += `<details ${isMonthOpen} style="margin-bottom:10px; border:1px solid rgba(239, 68, 68, 0.2); border-radius:12px; overflow:hidden;"><summary style="padding:12px; font-weight:900; color:#ef4444; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center; background:rgba(239, 68, 68, 0.05);"><span>ü´Ä ${monthLabel.toUpperCase()}</span><span style="font-size:10px; opacity:0.6;">${yearGroups[yKey][mKey].length} Tage ‚ñæ</span></summary><div style="padding:10px;">`;
            
            yearGroups[yKey][mKey].forEach(isoDate => {
                const measurements = daysMap[isoDate];
                const dateDisplay = measurements[0].date;
                
                let sumSys = 0, sumDia = 0;
                measurements.forEach(m => { sumSys += m.sys; sumDia += m.dia; });
                const avgSys = Math.round(sumSys / measurements.length);
                const avgDia = Math.round(sumDia / measurements.length);
                
                let statusColor = "#22c55e"; let statusText = "Normal";
                if (avgSys >= 140 || avgDia >= 90) { statusColor = "#ef4444"; statusText = "Hoch"; }
                else if (avgSys >= 130 || avgDia >= 85) { statusColor = "#f59e0b"; statusText = "Erh√∂ht"; }
                else if (avgSys < 90 || avgDia < 60) { statusColor = "#4facfe"; statusText = "Niedrig"; }

                let isDayOpen = (typeof openBpDate !== 'undefined' && openBpDate === isoDate) ? "open" : "";
                let dayHtml = `
                <details ${isDayOpen} style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid var(--glass-border);">
                    <summary style="display:flex; justify-content:space-between; align-items:center; cursor:pointer; list-style:none;">
                        <div>
                            <div style="font-size:11px; color:#cbd5e1; margin-bottom:3px;">üóìÔ∏è ${dateDisplay} ${measurements.length > 1 ? `(<b style="color:var(--accent)">${measurements.length}x</b>)` : ''}</div>
                            <div style="font-size:16px; font-weight:900; color:white;">${avgSys} <span style="font-size:12px; color:#94a3b8; font-weight:normal;">/</span> ${avgDia} <span style="font-size:10px; color:#64748b; font-weight:bold;">√ò mmHg</span></div>
                        </div>
                        <div style="text-align:right;">
                            <span style="background:${statusColor}20; color:${statusColor}; border:1px solid ${statusColor}50; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:bold; text-transform:uppercase;">${statusText}</span>
                            <span style="font-size:12px; opacity:0.5; margin-left:8px;">‚ñæ</span>
                        </div>
                    </summary>
                    <div style="margin-top:12px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">`;
                
                measurements.forEach(m => {
                    let pText = m.pulse ? `${m.pulse} BPM` : '';
                    let tText = m.time ? m.time + " Uhr" : 'Messung';
                    dayHtml += `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-size:12px; background: rgba(255,255,255,0.02); padding: 8px; border-radius: 6px;">
                            <span style="color:#94a3b8; width:60px;">${tText}</span>
                            <span style="color:white; font-weight:bold; flex:1; text-align:center;">${m.sys}/${m.dia}</span>
                            <span style="color:#64748b; font-size:10px; width:40px; text-align:right;">${pText}</span>
                            <div onclick="deleteBp('${m.id}')" style="color:var(--danger); font-size:14px; cursor:pointer; margin-left:15px; padding:0 5px;">‚úñ</div>
                        </div>`;
                });
                dayHtml += `</div></details>`;
                yearHtml += dayHtml;
            });
            yearHtml += `</div></details>`;
        });
        yearHtml += `</div></details>`;
        cont.innerHTML += yearHtml;
    });
}

function initBpChart() {
    const ctxEl = document.getElementById('bpChart');
    const avgDiv = document.getElementById('bp-weekly-avg');
    if(!ctxEl) return;
    if(bpChartInstance) bpChartInstance.destroy();
    
    if(!db.bpData || db.bpData.length === 0) {
        ctxEl.parentElement.style.display = 'none';
        if(avgDiv) avgDiv.style.display = 'none';
        return;
    }
    ctxEl.parentElement.style.display = 'block';

    const dailyAverages = {};
    db.bpData.forEach(m => {
        if(!dailyAverages[m.isoDate]) dailyAverages[m.isoDate] = { sysSum:0, diaSum:0, pulseSum:0, count:0, pulseCount:0 };
        dailyAverages[m.isoDate].sysSum += m.sys;
        dailyAverages[m.isoDate].diaSum += m.dia;
        dailyAverages[m.isoDate].count++;
        if (m.pulse) { dailyAverages[m.isoDate].pulseSum += m.pulse; dailyAverages[m.isoDate].pulseCount++; }
    });

    const sortedDates = Object.keys(dailyAverages).sort();
    const labels = []; const sysData = []; const diaData = []; const pulseData = [];

    sortedDates.forEach(d => {
        labels.push(d.split('-').slice(1).reverse().join('.'));
        sysData.push(Math.round(dailyAverages[d].sysSum / dailyAverages[d].count));
        diaData.push(Math.round(dailyAverages[d].diaSum / dailyAverages[d].count));
        pulseData.push(dailyAverages[d].pulseCount > 0 ? Math.round(dailyAverages[d].pulseSum / dailyAverages[d].pulseCount) : null);
    });

    // NEU: Erstelle Daten f√ºr die Grenzlinien (immer 140 bzw. 90)
    const limitSysData = new Array(labels.length).fill(140);
    const limitDiaData = new Array(labels.length).fill(90);

    if(avgDiv) {
        const last7Dates = sortedDates.slice(-7);
        let weekSys = 0, weekDia = 0;
        last7Dates.forEach(d => {
            weekSys += Math.round(dailyAverages[d].sysSum / dailyAverages[d].count);
            weekDia += Math.round(dailyAverages[d].diaSum / dailyAverages[d].count);
        });
        avgDiv.innerHTML = `Wochentrend (${last7Dates.length} Tage): <span style="color:#4facfe">${Math.round(weekSys/last7Dates.length)}</span> / <span style="color:#f59e0b">${Math.round(weekDia/last7Dates.length)}</span> √ò`;
        avgDiv.style.display = 'block';
    }

    bpChartInstance = new Chart(ctxEl.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'SYS (√ò)', data: sysData, borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.1)', borderWidth: 2, tension: 0, fill: true, pointRadius: 4, yAxisID: 'y', order: 2 },
                { label: 'DIA (√ò)', data: diaData, borderColor: '#f59e0b', backgroundColor: 'transparent', borderWidth: 2, tension: 0, fill: false, pointRadius: 4, yAxisID: 'y', order: 2 },
                { label: 'Puls (√ò)', data: pulseData, borderColor: '#a855f7', borderDash: [5, 5], backgroundColor: 'transparent', borderWidth: 2, tension: 0, fill: false, pointRadius: 3, yAxisID: 'y1', spanGaps: true, order: 2 },
                
                // NEU: Die beiden Grenzlinien
                {
                    label: 'Limit SYS', data: limitSysData,
                    borderColor: '#ef4444', borderWidth: 1, borderDash: [5, 5], // Rot, d√ºnn, gestrichelt
                    pointRadius: 0, fill: false, yAxisID: 'y', order: 1 // Keine Punkte, im Hintergrund
                },
                {
                    label: 'Limit DIA', data: limitDiaData,
                    borderColor: '#ef4444', borderWidth: 1, borderDash: [5, 5], // Rot, d√ºnn, gestrichelt
                    pointRadius: 0, fill: false, yAxisID: 'y', order: 1 // Keine Punkte, im Hintergrund
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true, labels: { color: '#cbd5e1', boxWidth: 10 },
                    // NEU: Verstecke die Grenzlinien in der Legende
                    filter: function(item, chart) { return !item.text.includes('Limit'); }
                },
                tooltip: {
                    // NEU: Zeige keine Tooltips f√ºr die Grenzlinien an
                    filter: function(tooltipItem) { return !tooltipItem.dataset.label.includes('Limit'); }
                }
            },
            scales: { 
                x: { ticks: {color: '#cbd5e1'}, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { 
                    type: 'linear', display: true, position: 'left', 
                    ticks: {color: '#cbd5e1'}, grid: { color: 'rgba(255,255,255,0.05)' },
                    title: { display: true, text: 'mmHg', color: '#cbd5e1', font: { size: 10 } }
                },
                y1: { 
                    type: 'linear', display: true, position: 'right', 
                    ticks: {color: '#a855f7'}, grid: { drawOnChartArea: false },
                    title: { display: true, text: 'BPM', color: '#a855f7', font: { size: 10 } }
                }
            }
        }
    });
}  

</script>
<script>
    // Verhindert das vertikale "Gummiband"-Ziehen der gesamten App
document.addEventListener('touchmove', function (e) {
    // Scrollen in den Seiten UND Modals erlauben
    if (e.target.closest('.page') || e.target.closest('.custom-modal-box')) return; 
    e.preventDefault(); // Alles andere (Hintergrund ziehen) verbieten
}, { passive: false });

// =========================================
// NEU V3: Absoluter iOS Tastatur-Fix (Transformation)
// =========================================
if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    setTimeout(() => {
        // Jetzt mit der KORREKTEN ID aus deinem HTML
        const nameInput = document.getElementById('user-name-input');
        const startScreenEl = document.getElementById('start-screen');
        
        if (nameInput && startScreenEl) {
            nameInput.addEventListener('focus', function() {
                // Schiebt den gesamten schwarzen Screen physisch nach oben
                startScreenEl.style.transform = 'translateY(-20vh)';
            });
            nameInput.addEventListener('blur', function() {
                // Setzt ihn wieder zur√ºck in die Mitte, wenn die Tastatur zugeht
                startScreenEl.style.transform = 'translateY(0)';
            });
        }
    }, 500); 
}

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registriert!', reg))
                .catch(err => console.log('Service Worker Fehler:', err));
        });
    }
</script>
</body>
</html>